<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Ø³Ø¬Ù„Ùƒ Ø§Ù„Ø£Ø¯Ø¨ÙŠ</title>
    
    <!-- ØªØ­Ù…ÙŠÙ„ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- ØªØ­Ù…ÙŠÙ„ Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <!-- ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© -->
    <script src="https://cdn.jsdelivr.net/npm/localforage@1.10.0/dist/localforage.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <!-- Fuse.js Ù„Ù„Ø¨Ø­Ø« -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.6.2/fuse.min.js"></script>
    
    <!-- ØªØ­Ù…ÙŠÙ„ Ø®Ø·ÙˆØ· Ù…Ø¨Ø³Ø·Ø© -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600&family=Tajawal:wght@300;400;500&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'primary': {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            200: '#bae6fd',
                            300: '#7dd3fc',
                            400: '#38bdf8',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            700: '#0369a1',
                            800: '#075985',
                            900: '#0c4a6e',
                        },
                        'secondary': {
                            50: '#f8fafc',
                            100: '#f1f5f9',
                            200: '#e2e8f0',
                            300: '#cbd5e1',
                            400: '#94a3b8',
                            500: '#64748b',
                            600: '#475569',
                            700: '#334155',
                            800: '#1e293b',
                            900: '#0f172a',
                        },
                        // Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø±ÙÙˆÙ
                        'shelf': {
                            'reading': '#fef3c7',
                            'want_to_read': '#dbeafe',
                            'liked': '#fce7f3',
                            'recommended': '#fef9c3',
                            'life_changing': '#dcfce7',
                            'thought_provoking': '#ede9fe',
                            'heavy_but_important': '#f1f5f9',
                            'emotional': '#fee2e2',
                            'faded_out': '#fef3c7',
                            'experimental': '#ecfccb'
                        }
                    },
                    fontFamily: {
                        'cairo': ['Cairo', 'sans-serif'],
                        'tajawal': ['Tajawal', 'sans-serif'],
                        'sans': ['Cairo', 'Tajawal', 'sans-serif'],
                    },
                    borderRadius: {
                        'xl': '1rem',
                        '2xl': '1.5rem',
                    },
                    boxShadow: {
                        'soft': '0 4px 20px rgba(0, 0, 0, 0.05)',
                        'medium': '0 6px 30px rgba(0, 0, 0, 0.08)',
                        'hard': '0 10px 40px rgba(0, 0, 0, 0.12)',
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-out',
                        'slide-in': 'slideIn 0.3s ease-out',
                    }
                }
            }
        }
    </script>
    
    <style>
        /* Ø£Ù†Ù…Ø§Ø· Ù…Ø¨Ø³Ø·Ø© */
        body {
            font-family: 'Cairo', sans-serif;
            font-size: 0.9375rem;
            line-height: 1.6;
        }
        
        /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ø¹Ø§Ù…Ø© */
        .glass-effect {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
        }
        
        .dark .glass-effect {
            background: rgba(15, 23, 42, 0.8);
        }
        
        .card {
            background: white;
            border-radius: 0.875rem;
            padding: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border: 1px solid #e2e8f0;
            transition: all 0.2s;
        }
        
        .dark .card {
            background: #1e293b;
            border-color: #334155;
        }
        
        .card:hover {
            box-shadow: 0 6px 20px rgba(0,0,0,0.12);
            transform: translateY(-2px);
        }
        
        /* Ø£Ø²Ø±Ø§Ø± ØµØºÙŠØ±Ø© */
        .btn-sm {
            padding: 0.375rem 0.75rem;
            font-size: 0.875rem;
            border-radius: 0.625rem;
            font-weight: 500;
        }
        
        /* Ø¥Ø¯Ø®Ø§Ù„Ø§Øª ØµØºÙŠØ±Ø© */
        .input-sm {
            padding: 0.375rem 0.75rem;
            font-size: 0.875rem;
            border-radius: 0.625rem;
            border: 1.5px solid #e2e8f0;
        }
        
        .dark .input-sm {
            border-color: #334155;
            background: #1e293b;
        }
        
        /* Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª ØµØºÙŠØ±Ø© */
        .icon-sm {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.625rem;
            transition: all 0.2s;
        }
        
        /* ØªØ¯Ø±Ø¬Ø§Øª Ø¨Ø§Ø³ØªÙŠÙ„ Ø®ÙÙŠÙØ© */
        .pastel-gradient {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
        }
        
        .dark .pastel-gradient {
            background: linear-gradient(135deg, #0c4a6e 0%, #075985 100%);
        }
        
        /* Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª */
        .tag {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        /* Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ù…ØªØ­Ø±ÙƒØ© */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes slideIn {
            from { transform: translateX(20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .animate-fade-in {
            animation: fadeIn 0.3s ease-out;
        }
        
        .animate-slide-in {
            animation: slideIn 0.3s ease-out;
        }
        
        /* Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ…Ø±ÙŠØ± */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        
        .dark ::-webkit-scrollbar-track {
            background: #1e293b;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
        
        .dark ::-webkit-scrollbar-thumb {
            background: #475569;
        }
        
        /* ØªØ­Ø³ÙŠÙ† Ø§Ù„Ù†Ø¬Ù…Ø© */
        .star-rating i {
            transition: transform 0.2s;
        }
        
        .star-rating i:hover {
            transform: scale(1.2);
        }
        
        /* ØªØ£Ø«ÙŠØ±Ø§Øª Ø§Ù„ØµÙˆØ± */
        .book-cover {
            object-fit: cover;
            object-position: center;
            transition: transform 0.3s ease;
        }
        
        .book-cover:hover {
            transform: scale(1.05);
        }
        
        /* Ø²Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„ */
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #0ea5e9;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="font-sans bg-gray-50 dark:bg-gray-900 text-gray-800 dark:text-gray-200 transition-colors duration-300">

    <!-- Ø´Ø±ÙŠØ· Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª -->
    <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2 max-w-sm w-full"></div>

    <!-- Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ -->
    <header class="sticky top-0 z-30 glass-effect border-b border-gray-200 dark:border-gray-700">
        <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
            <!-- Ø²Ø± Ø§Ù„Ø¹ÙˆØ¯Ø© -->
            <button id="back-btn" class="icon-sm text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 hidden" onclick="goBack()">
                <i class="fa-solid fa-arrow-right"></i>
            </button>
            
            <!-- Ø§Ù„Ø¹Ù†ÙˆØ§Ù† -->
            <h1 id="header-title" class="text-lg font-semibold text-primary-600 dark:text-primary-400 truncate">
                Ø³Ø¬Ù„Ùƒ Ø§Ù„Ø£Ø¯Ø¨ÙŠ
            </h1>
            
            <!-- Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª -->
            <div class="flex items-center gap-2">
                <button onclick="toggleSearchBar()" class="icon-sm text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700" title="Ø¨Ø­Ø«">
                    <i class="fa-solid fa-search"></i>
                </button>
                
                <button onclick="showSettingsModal()" class="icon-sm text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700" title="Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª">
                    <i class="fa-solid fa-gear"></i>
                </button>
                
                <button onclick="toggleDarkMode()" class="icon-sm text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700" title="Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ">
                    <i class="fa-solid fa-moon"></i>
                </button>
            </div>
        </div>
        
        <!-- Ø´Ø±ÙŠØ· Ø§Ù„Ø¨Ø­Ø« -->
        <div id="search-bar" class="hidden px-4 py-3 bg-gray-100 dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 animate-slide-in">
            <div class="max-w-6xl mx-auto">
                <div class="relative">
                    <input type="text" id="search-input" placeholder="Ø§Ø¨Ø­Ø« ÙÙŠ Ø§Ù„ÙƒØªØ¨ ÙˆØ§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª..." 
                           class="w-full pr-10 pl-3 py-2.5 text-sm rounded-xl bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                    <i class="fa-solid fa-search absolute right-3 top-3 text-gray-400 text-sm"></i>
                </div>
                
                <!-- Ø³ÙŠØ§Ù‚ Ø§Ù„Ø¨Ø­Ø« -->
                <div id="search-context" class="text-xs text-gray-500 dark:text-gray-400 mt-2 hidden">
                    Ø§Ù„Ø¨Ø­Ø« ÙÙŠ: <span id="search-context-text"></span>
                </div>
                
                <!-- Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù…ØªÙ‚Ø¯Ù… -->
                <button onclick="showAdvancedSearch()" class="mt-2 text-xs text-primary-600 dark:text-primary-400 hover:text-primary-700">
                    <i class="fa-solid fa-sliders ml-1"></i> ÙÙ„Ø§ØªØ± Ù…ØªÙ‚Ø¯Ù…Ø©
                </button>
            </div>
        </div>
    </header>

    <!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
    <main class="max-w-6xl mx-auto px-4 py-4 pb-24">
        <!-- ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
        <section id="view-home" class="view-section space-y-4">
            <div class="flex items-center justify-between">
                <div>
                    <h2 class="text-xl font-semibold text-gray-900 dark:text-gray-100">Ø³Ø¬Ù„Ùƒ Ø§Ù„Ø£Ø¯Ø¨ÙŠ</h2>
                </div>
                <button onclick="showCreatePostModal()" class="btn-sm bg-primary-500 text-white hover:bg-primary-600 flex items-center gap-2">
                    <i class="fa-solid fa-plus"></i>
                    Ø¬Ø¯ÙŠØ¯
                </button>
            </div>
            
            <!-- ÙÙ„Ø§ØªØ± Ø§Ù„ÙØ±Ø² -->
            <div class="flex flex-wrap gap-2 pb-2">
                <button class="sort-btn active px-3 py-1.5 text-sm rounded-full bg-primary-100 dark:bg-primary-900/30 text-primary-700 dark:text-primary-300" onclick="sortPosts('newest')">
                    Ø§Ù„Ø£Ø­Ø¯Ø«
                </button>
                <button class="sort-btn px-3 py-1.5 text-sm rounded-full bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300" onclick="sortPosts('quotes')">
                    Ø§Ù„Ø§Ù‚ØªØ¨Ø§Ø³Ø§Øª
                </button>
                <button class="sort-btn px-3 py-1.5 text-sm rounded-full bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300" onclick="sortPosts('reviews')">
                    Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø§Øª
                </button>
                <button class="sort-btn px-3 py-1.5 text-sm rounded-full bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300" onclick="sortPosts('notes')">
                    Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª
                </button>
            </div>
            
            <!-- Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª -->
            <div>
                <div id="home-posts-list" class="space-y-3"></div>
            </div>
        </section>

        <!-- ØµÙØ­Ø© ÙƒØªØ§Ø¨Ø§ØªÙŠ -->
        <section id="view-writings" class="view-section hidden">
            <div class="mb-6">
                <h2 class="text-xl font-semibold text-gray-900 dark:text-gray-100 mb-2">ÙƒØªØ§Ø¨Ø§ØªÙŠ</h2>
            </div>
            
            <!-- Ø±ÙÙˆÙ Ø§Ù„ÙƒØªØ§Ø¨Ø§Øª -->
            <div class="flex flex-col gap-3">
                <!-- Ø§Ù„Ø§Ù‚ØªØ¨Ø§Ø³Ø§Øª -->
                <div class="card cursor-pointer hover:shadow-medium" onclick="openWritingShelf('quotes')">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 rounded-lg bg-blue-100 dark:bg-blue-900/30 flex items-center justify-center">
                            <i class="fa-solid fa-quote-right text-blue-600 dark:text-blue-400 text-lg"></i>
                        </div>
                        <div class="flex-1">
                            <h3 class="font-medium text-sm mb-1">Ø§Ù„Ø§Ù‚ØªØ¨Ø§Ø³Ø§Øª</h3>
                            <p class="text-xs text-gray-500">Ø£Ø¬Ù…Ù„ Ù…Ø§ Ø®Ø·Ù‡ Ø§Ù„Ø¢Ø®Ø±ÙˆÙ† Ù…Ù† Ø­ÙƒÙ… ÙˆØ£Ù‚ÙˆØ§Ù„</p>
                        </div>
                    </div>
                </div>
                
                <!-- Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø§Øª -->
                <div class="card cursor-pointer hover:shadow-medium" onclick="openWritingShelf('reviews')">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 rounded-lg bg-amber-100 dark:bg-amber-900/30 flex items-center justify-center">
                            <i class="fa-solid fa-star text-amber-600 dark:text-amber-400 text-lg"></i>
                        </div>
                        <div class="flex-1">
                            <h3 class="font-medium text-sm mb-1">Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø§Øª</h3>
                            <p class="text-xs text-gray-500">Ù…Ø±Ø§Ø¬Ø¹Ø§Øª Ù…ÙØµÙ„Ø© Ù„Ù„ÙƒØªØ¨ Ø§Ù„ØªÙŠ Ù‚Ø±Ø£ØªÙ‡Ø§</p>
                        </div>
                    </div>
                </div>
                
                <!-- Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª -->
                <div class="card cursor-pointer hover:shadow-medium" onclick="openWritingShelf('notes')">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 rounded-lg bg-emerald-100 dark:bg-emerald-900/30 flex items-center justify-center">
                            <i class="fa-solid fa-note-sticky text-emerald-600 dark:text-emerald-400 text-lg"></i>
                        </div>
                        <div class="flex-1">
                            <h3 class="font-medium text-sm mb-1">Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</h3>
                            <p class="text-xs text-gray-500">Ø®ÙˆØ§Ø·Ø±ÙŠ ÙˆØªØ£Ù…Ù„Ø§ØªÙŠ Ø§Ù„Ø´Ø®ØµÙŠØ©</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Ø¹Ø±Ø¶ Ù…Ø­ØªÙˆÙŠØ§Øª Ø§Ù„Ø±Ù -->
            <div id="writings-shelf-view" class="hidden animate-fade-in">
                <div class="mb-6">
                    <button onclick="backToWritings()" class="icon-sm text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-700 mb-3">
                        <i class="fa-solid fa-arrow-right"></i>
                    </button>
                    <h3 id="writing-shelf-title" class="text-lg font-semibold text-gray-900 dark:text-gray-100"></h3>
                </div>
                
                <div id="writing-shelf-posts" class="space-y-3"></div>
            </div>
        </section>

        <!-- ØµÙØ­Ø© Ø§Ù„Ù…ÙƒØªØ¨Ø© -->
        <section id="view-books" class="view-section hidden">
            <div class="flex items-center justify-between mb-6">
                <div>
                    <h2 class="text-xl font-semibold text-gray-900 dark:text-gray-100 mb-2">Ø§Ù„Ù…ÙƒØªØ¨Ø©</h2>
                </div>
                <button onclick="showCreateBookModal()" class="btn-sm bg-primary-500 text-white hover:bg-primary-600 flex items-center gap-2">
                    <i class="fa-solid fa-plus"></i>
                    ÙƒØªØ§Ø¨ Ø¬Ø¯ÙŠØ¯
                </button>
            </div>
            
            <!-- ÙÙ„Ø§ØªØ± Ø§Ù„Ù…ÙƒØªØ¨Ø© -->
            <div class="card mb-6">
                <div class="flex flex-wrap items-center justify-between gap-3">
                    <div class="flex-1 min-w-[200px]">
                        <select id="books-sort-select" onchange="sortBooks()" class="w-full input-sm">
                            <option value="newest">Ø§Ù„Ø£Ø­Ø¯Ø« Ø¥Ø¶Ø§ÙØ©</option>
                            <option value="oldest">Ø§Ù„Ø£Ù‚Ø¯Ù… Ø¥Ø¶Ø§ÙØ©</option>
                            <option value="title_asc">Ø§Ù„Ø¹Ù†ÙˆØ§Ù† (Ø£-ÙŠ)</option>
                            <option value="title_desc">Ø§Ù„Ø¹Ù†ÙˆØ§Ù† (ÙŠ-Ø£)</option>
                            <option value="author">Ø§Ù„Ù…Ø¤Ù„Ù</option>
                            <option value="year_desc">Ø§Ù„Ø£Ø­Ø¯Ø« Ù†Ø´Ø±Ø§Ù‹</option>
                            <option value="year_asc">Ø§Ù„Ø£Ù‚Ø¯Ù… Ù†Ø´Ø±Ø§Ù‹</option>
                            <option value="rating_desc">Ø§Ù„Ø£Ø¹Ù„Ù‰ ØªÙ‚ÙŠÙŠÙ…Ø§Ù‹</option>
                            <option value="pages_asc">Ø§Ù„Ø£Ù‚Ù„ ØµÙØ­Ø§Øª</option>
                            <option value="pages_desc">Ø§Ù„Ø£ÙƒØ«Ø± ØµÙØ­Ø§Øª</option>
                            <option value="status">Ø­Ø§Ù„Ø© Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©</option>
                        </select>
                    </div>
                    
                    <div class="flex items-center gap-2">
                        <div class="relative">
                            <input type="text" id="books-search" placeholder="Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…ÙƒØªØ¨Ø©..." 
                                   class="input-sm pr-8 w-40" 
                                   oninput="searchBooks()">
                            <i class="fa-solid fa-search absolute right-2 top-2 text-gray-400 text-sm"></i>
                        </div>
                        
                        <button onclick="toggleBooksView()" class="icon-sm text-gray-600 dark:text-gray-300" title="ØªØºÙŠÙŠØ± Ø§Ù„Ø¹Ø±Ø¶">
                            <i id="books-view-icon" class="fa-solid fa-grip"></i>
                        </button>
                    </div>
                </div>
                
                <!-- ÙÙ„Ø§ØªØ± Ø³Ø±ÙŠØ¹Ø© -->
                <div class="flex flex-wrap gap-2 mt-3">
                    <button onclick="filterByStatus('reading')" class="text-xs px-2 py-1 rounded-full bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300">
                        Ø£Ù‚Ø±Ø£ Ø§Ù„Ø¢Ù†
                    </button>
                    <button onclick="filterByStatus('finished')" class="text-xs px-2 py-1 rounded-full bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300">
                        Ù…Ù†Ø¬Ø²
                    </button>
                    <button onclick="filterByStatus('not_started')" class="text-xs px-2 py-1 rounded-full bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300">
                        Ù„Ù… Ø£Ø¨Ø¯Ø£
                    </button>
                    <button onclick="clearFilters()" class="text-xs px-2 py-1 rounded-full bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300">
                        Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†
                    </button>
                </div>
            </div>
            
            <!-- Ø¹Ø±Ø¶ Ø´Ø¨ÙƒØ© Ø§Ù„ÙƒØªØ¨ -->
            <div id="books-grid-view" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-3"></div>
            
            <!-- Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙƒØªØ¨ -->
            <div id="books-list-view" class="hidden space-y-3"></div>
        </section>

        <!-- ØµÙØ­Ø© Ø§Ù„Ø±ÙÙˆÙ -->
        <section id="view-shelves" class="view-section hidden">
            <div class="mb-6">
                <h2 class="text-xl font-semibold text-gray-900 dark:text-gray-100 mb-2">Ø§Ù„Ø±ÙÙˆÙ</h2>
            </div>
            
            <div id="shelves-landing">
                <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3">
                    <!-- Ø§Ù„Ø±ÙÙˆÙ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
                    <div class="card cursor-pointer hover:shadow-medium" onclick="openShelf('reading')">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 rounded-lg bg-shelf-reading flex items-center justify-center">
                                <i class="fa-solid fa-book-open text-amber-700"></i>
                            </div>
                            <div class="flex-1">
                                <h3 class="font-medium text-sm mb-1">Ø£Ù‚Ø±Ø£Ù‡ Ø­Ø§Ù„ÙŠØ§Ù‹</h3>
                                <p class="text-xs text-gray-500">0 ÙƒØªØ§Ø¨</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card cursor-pointer hover:shadow-medium" onclick="openShelf('want_to_read')">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 rounded-lg bg-shelf-want_to_read flex items-center justify-center">
                                <i class="fa-solid fa-bookmark text-blue-700"></i>
                            </div>
                            <div class="flex-1">
                                <h3 class="font-medium text-sm mb-1">Ø£Ø±ØºØ¨ Ø¨Ù‚Ø±Ø§Ø¡ØªÙ‡</h3>
                                <p class="text-xs text-gray-500">0 ÙƒØªØ§Ø¨</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card cursor-pointer hover:shadow-medium" onclick="openShelf('liked')">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 rounded-lg bg-shelf-liked flex items-center justify-center">
                                <i class="fa-solid fa-heart text-pink-700"></i>
                            </div>
                            <div class="flex-1">
                                <h3 class="font-medium text-sm mb-1">Ø£Ø¹Ø¬Ø¨Ù†ÙŠ</h3>
                                <p class="text-xs text-gray-500">0 ÙƒØªØ§Ø¨</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card cursor-pointer hover:shadow-medium" onclick="openShelf('recommended')">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 rounded-lg bg-shelf-recommended flex items-center justify-center">
                                <i class="fa-solid fa-star text-yellow-700"></i>
                            </div>
                            <div class="flex-1">
                                <h3 class="font-medium text-sm mb-1">Ø£Ù†ØµØ­ Ø¨Ù‡</h3>
                                <p class="text-xs text-gray-500">0 ÙƒØªØ§Ø¨</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Ø±ÙÙˆÙ Ø¥Ø¶Ø§ÙÙŠØ© -->
                    <div class="card cursor-pointer hover:shadow-medium" onclick="openShelf('life_changing')">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 rounded-lg bg-shelf-life_changing flex items-center justify-center">
                                <i class="fa-solid fa-brain text-green-700"></i>
                            </div>
                            <div class="flex-1">
                                <h3 class="font-medium text-sm mb-1">ØºÙŠÙ‘Ø± ØªÙÙƒÙŠØ±ÙŠ</h3>
                                <p class="text-xs text-gray-500">0 ÙƒØªØ§Ø¨</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card cursor-pointer hover:shadow-medium" onclick="openShelf('thought_provoking')">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 rounded-lg bg-shelf-thought_provoking flex items-center justify-center">
                                <i class="fa-solid fa-lightbulb text-purple-700"></i>
                            </div>
                            <div class="flex-1">
                                <h3 class="font-medium text-sm mb-1">Ø­ÙŠÙ‘Ø±Ù†ÙŠ</h3>
                                <p class="text-xs text-gray-500">0 ÙƒØªØ§Ø¨</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card cursor-pointer hover:shadow-medium" onclick="openShelf('heavy_but_important')">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 rounded-lg bg-shelf-heavy_but_important flex items-center justify-center">
                                <i class="fa-solid fa-weight-hanging text-gray-700"></i>
                            </div>
                            <div class="flex-1">
                                <h3 class="font-medium text-sm mb-1">Ø«Ù‚ÙŠÙ„ Ù„ÙƒÙ† Ù…Ù‡Ù…</h3>
                                <p class="text-xs text-gray-500">0 ÙƒØªØ§Ø¨</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card cursor-pointer hover:shadow-medium" onclick="openShelf('emotional')">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 rounded-lg bg-shelf-emotional flex items-center justify-center">
                                <i class="fa-solid fa-heart-crack text-red-700"></i>
                            </div>
                            <div class="flex-1">
                                <h3 class="font-medium text-sm mb-1">Ø¹Ø§Ø·ÙÙŠ</h3>
                                <p class="text-xs text-gray-500">0 ÙƒØªØ§Ø¨</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Ø±ÙÙˆÙ Ø£Ø®Ø±Ù‰ -->
                    <div class="card cursor-pointer hover:shadow-medium" onclick="openShelf('faded_out')">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 rounded-lg bg-shelf-faded_out flex items-center justify-center">
                                <i class="fa-solid fa-battery-empty text-yellow-700"></i>
                            </div>
                            <div class="flex-1">
                                <h3 class="font-medium text-sm mb-1">Ø¨Ø¯Ø£ Ù‚ÙˆÙŠÙ‹Ø§ Ø«Ù… Ø®ÙÙ‘</h3>
                                <p class="text-xs text-gray-500">0 ÙƒØªØ§Ø¨</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card cursor-pointer hover:shadow-medium" onclick="openShelf('experimental')">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 rounded-lg bg-shelf-experimental flex items-center justify-center">
                                <i class="fa-solid fa-flask text-lime-700"></i>
                            </div>
                            <div class="flex-1">
                                <h3 class="font-medium text-sm mb-1">ØªØ¬Ø±Ø¨Ø©</h3>
                                <p class="text-xs text-gray-500">0 ÙƒØªØ§Ø¨</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Ø¹Ø±Ø¶ Ù…Ø­ØªÙˆÙŠØ§Øª Ø§Ù„Ø±Ù -->
            <div id="shelves-shelf-view" class="hidden animate-fade-in">
                <div class="mb-6">
                    <button onclick="backToShelves()" class="icon-sm text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-700 mb-3">
                        <i class="fa-solid fa-arrow-right"></i>
                    </button>
                    <h3 id="shelf-title" class="text-lg font-semibold text-gray-900 dark:text-gray-100"></h3>
                </div>
                
                <!-- ÙØ±Ø² Ø¯Ø§Ø®Ù„ Ø§Ù„Ø±Ù -->
                <div class="mb-4">
                    <select id="shelf-sort-select" onchange="sortShelfBooks()" class="input-sm">
                        <option value="title_asc">Ø§Ù„Ø¹Ù†ÙˆØ§Ù† (Ø£-ÙŠ)</option>
                        <option value="added_newest">Ø§Ù„Ø£Ø­Ø¯Ø« Ø¥Ø¶Ø§ÙØ©</option>
                        <option value="rating_desc">Ø§Ù„Ø£Ø¹Ù„Ù‰ ØªÙ‚ÙŠÙŠÙ…Ø§Ù‹</option>
                        <option value="year_desc">Ø§Ù„Ø£Ø­Ø¯Ø« Ù†Ø´Ø±Ø§Ù‹</option>
                    </select>
                </div>
                
                <!-- ÙƒØªØ¨ Ø§Ù„Ø±Ù -->
                <div id="shelf-books-grid" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-3"></div>
            </div>
        </section>

        <!-- ØµÙØ­Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª -->
        <section id="view-menu" class="view-section hidden space-y-4">
            <h2 class="text-xl font-semibold text-gray-900 dark:text-gray-100">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h2>
            
            <!-- Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ -->
            <div class="card">
                <h3 class="font-medium mb-3 text-gray-900 dark:text-gray-100 flex items-center gap-2">
                    <i class="fa-solid fa-user"></i>
                    Ù…Ù„ÙÙŠ Ø§Ù„Ø´Ø®ØµÙŠ
                </h3>
                <div class="grid grid-cols-3 gap-3 text-center mb-4">
                    <div>
                        <div class="text-lg font-semibold text-primary-600 dark:text-primary-400" id="stats-books">0</div>
                        <div class="text-xs text-gray-500">Ø§Ù„ÙƒØªØ¨</div>
                    </div>
                    <div>
                        <div class="text-lg font-semibold text-primary-600 dark:text-primary-400" id="stats-posts">0</div>
                        <div class="text-xs text-gray-500">Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª</div>
                    </div>
                    <div>
                        <div class="text-lg font-semibold text-primary-600 dark:text-primary-400" id="stats-quotes">0</div>
                        <div class="text-xs text-gray-500">Ø§Ù„Ø§Ù‚ØªØ¨Ø§Ø³Ø§Øª</div>
                    </div>
                </div>
                
                <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ù„Ù -->
                <div class="space-y-3">
                    <div>
                        <label class="block text-xs text-gray-500 mb-1">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
                        <input type="text" id="profile-name" class="w-full input-sm" placeholder="Ø§Ø³Ù…Ùƒ">
                    </div>
                    <div>
                        <label class="block text-xs text-gray-500 mb-1">Ø§Ù„ÙˆØµÙ</label>
                        <textarea id="profile-bio" rows="2" class="w-full input-sm" placeholder="ÙˆØµÙ Ù‚ØµÙŠØ±"></textarea>
                    </div>
                    <button onclick="saveProfile()" class="w-full btn-sm bg-primary-500 text-white hover:bg-primary-600">
                        Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ
                    </button>
                </div>
            </div>
            
            <!-- Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© -->
            <div class="card space-y-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-gray-100 dark:bg-gray-700 rounded-lg flex items-center justify-center">
                            <i class="fa-solid fa-moon text-gray-600 dark:text-gray-300"></i>
                        </div>
                        <div>
                            <div class="font-medium text-gray-900 dark:text-gray-100">Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ</div>
                            <div class="text-xs text-gray-500">ØªØºÙŠÙŠØ± Ù…Ø¸Ù‡Ø± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</div>
                        </div>
                    </div>
                    <button id="theme-toggle" class="w-12 h-6 rounded-full bg-gray-300 dark:bg-gray-700 relative" onclick="toggleDarkMode()">
                        <div class="absolute top-0.5 left-0.5 w-5 h-5 rounded-full bg-white transition-transform duration-300"></div>
                    </button>
                </div>
                
                <!-- ØªØºÙŠÙŠØ± Ø§Ù„Ø«ÙŠÙ… -->
                <button onclick="showThemeSettings()" class="w-full flex items-center justify-between py-2 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded-lg transition-colors">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-gray-100 dark:bg-gray-700 rounded-lg flex items-center justify-center">
                            <i class="fa-solid fa-palette text-gray-600 dark:text-gray-300"></i>
                        </div>
                        <div>
                            <div class="font-medium text-gray-900 dark:text-gray-100">ØªØºÙŠÙŠØ± Ù†Ù…Ø· Ø§Ù„Ø¹Ø±Ø¶</div>
                            <div class="text-xs text-gray-500">Ø§Ø®ØªØ± Ø«ÙŠÙ… ÙŠÙ†Ø§Ø³Ø¨ Ø°ÙˆÙ‚Ùƒ</div>
                        </div>
                    </div>
                    <i class="fa-solid fa-arrow-left text-gray-400"></i>
                </button>
                
                <!-- Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ -->
                <div class="pt-4 border-t border-gray-100 dark:border-gray-700">
                    <h4 class="font-medium text-gray-700 dark:text-gray-300 mb-3">Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <button onclick="exportBackup()" class="btn-sm bg-emerald-500 text-white hover:bg-emerald-600 flex items-center justify-center gap-2">
                            <i class="fa-solid fa-download"></i>
                            ØªØµØ¯ÙŠØ±
                        </button>
                        
                        <label class="btn-sm bg-blue-500 text-white hover:bg-blue-600 flex items-center justify-center gap-2 cursor-pointer">
                            <i class="fa-solid fa-upload"></i>
                            Ø§Ø³ØªÙŠØ±Ø§Ø¯
                            <input type="file" id="import-file-input" class="hidden" accept=".json,.zip">
                        </label>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ ÙŠØ­ÙØ¸ Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø¨Ø´ÙƒÙ„ Ø¢Ù…Ù†</p>
                </div>
            </div>
            
            <!-- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…ØªÙ‚Ø¯Ù…Ø© -->
            <div class="card">
                <h3 class="font-medium mb-3 text-gray-900 dark:text-gray-100">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…ØªÙ‚Ø¯Ù…Ø©</h3>
                <div class="space-y-3">
                    <label class="flex items-center justify-between">
                        <span class="text-sm text-gray-700 dark:text-gray-300">Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ</span>
                        <input type="checkbox" id="auto-refresh" class="rounded">
                    </label>
                    <label class="flex items-center justify-between">
                        <span class="text-sm text-gray-700 dark:text-gray-300">Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª</span>
                        <input type="checkbox" id="notifications" class="rounded" checked>
                    </label>
                    <label class="flex items-center justify-between">
                        <span class="text-sm text-gray-700 dark:text-gray-300">Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠ</span>
                        <input type="checkbox" id="auto-save" class="rounded" checked>
                    </label>
                    <button onclick="clearCache()" class="w-full btn-sm bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600">
                        Ù…Ø³Ø­ Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø¤Ù‚ØªØ©
                    </button>
                </div>
            </div>
        </section>

        <!-- ØµÙØ­Ø© ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙƒØªØ§Ø¨ -->
        <section id="view-book-details" class="view-section hidden"></section>

        <!-- ØµÙØ­Ø© Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø« -->
        <section id="view-search" class="view-section hidden">
            <div class="flex items-center gap-3 mb-6">
                <button onclick="hideSearchResults()" class="icon-sm text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-700">
                    <i class="fa-solid fa-arrow-right"></i>
                </button>
                <div>
                    <h2 class="text-xl font-semibold text-gray-900 dark:text-gray-100">ğŸ” Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«</h2>
                    <p id="search-results-count" class="text-sm text-gray-600 dark:text-gray-400"></p>
                </div>
            </div>
            
            <!-- ÙÙ„Ø§ØªØ± Ø§Ù„Ø¨Ø­Ø« -->
            <div class="card mb-4">
                <div class="flex flex-wrap gap-2">
                    <button onclick="filterSearchResults('all')" class="text-xs px-2 py-1 rounded-full bg-primary-100 dark:bg-primary-900/30 text-primary-700 dark:text-primary-300">
                        Ø§Ù„ÙƒÙ„
                    </button>
                    <button onclick="filterSearchResults('books')" class="text-xs px-2 py-1 rounded-full bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300">
                        Ø§Ù„ÙƒØªØ¨
                    </button>
                    <button onclick="filterSearchResults('quotes')" class="text-xs px-2 py-1 rounded-full bg-emerald-100 dark:bg-emerald-900/30 text-emerald-700 dark:text-emerald-300">
                        Ø§Ù„Ø§Ù‚ØªØ¨Ø§Ø³Ø§Øª
                    </button>
                    <button onclick="filterSearchResults('reviews')" class="text-xs px-2 py-1 rounded-full bg-amber-100 dark:bg-amber-900/30 text-amber-700 dark:text-amber-300">
                        Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø§Øª
                    </button>
                </div>
            </div>
            
            <div id="search-results" class="space-y-3"></div>
        </section>
    </main>

    <!-- ========================================================================= -->
    <!-- Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© -->
    <!-- ========================================================================= -->

    <!-- Ù†Ø§ÙØ°Ø© Ø¥Ù†Ø´Ø§Ø¡/ØªØ¹Ø¯ÙŠÙ„ Ù…Ù†Ø´ÙˆØ± -->
    <div id="post-modal" class="fixed inset-0 bg-black/50 dark:bg-black/70 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 rounded-xl w-full max-w-md max-h-[90vh] overflow-y-auto animate-fade-in">
            <div class="p-4 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between">
                <h3 id="post-modal-title" class="font-semibold text-gray-900 dark:text-gray-100">Ù…Ù†Ø´ÙˆØ± Ø¬Ø¯ÙŠØ¯</h3>
                <button onclick="hideCreatePostModal()" class="icon-sm text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-700">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
            
            <div class="p-4 space-y-4">
                <!-- Ù†ÙˆØ¹ Ø§Ù„Ù…Ù†Ø´ÙˆØ± -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Ù†ÙˆØ¹ Ø§Ù„Ù…Ù†Ø´ÙˆØ±</label>
                    <div class="grid grid-cols-2 gap-2">
                        <button data-type="quote" onclick="selectPostType('quote')" class="py-2 rounded-lg bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 flex items-center justify-center gap-2">
                            <i class="fa-solid fa-quote-right"></i>
                            Ø§Ù‚ØªØ¨Ø§Ø³
                        </button>
                        <button data-type="note" onclick="selectPostType('note')" class="py-2 rounded-lg bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300 flex items-center justify-center gap-2">
                            <i class="fa-solid fa-note-sticky"></i>
                            Ù…Ù„Ø§Ø­Ø¸Ø©
                        </button>
                        <button data-type="review" onclick="selectPostType('review')" class="py-2 rounded-lg bg-amber-100 dark:bg-amber-900/30 text-amber-700 dark:text-amber-300 flex items-center justify-center gap-2">
                            <i class="fa-solid fa-star"></i>
                            Ù…Ø±Ø§Ø¬Ø¹Ø©
                        </button>
                        <button data-type="thought" onclick="selectPostType('thought')" class="py-2 rounded-lg bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-300 flex items-center justify-center gap-2">
                            <i class="fa-solid fa-lightbulb"></i>
                            ÙÙƒØ±Ø©
                        </button>
                    </div>
                </div>
                
                <!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ -->
                <div>
                    <label for="post-content" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Ø§Ù„Ù…Ø­ØªÙˆÙ‰</label>
                    <textarea id="post-content" rows="4" placeholder="Ø§ÙƒØªØ¨ Ù‡Ù†Ø§..." class="w-full p-3 text-sm rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary-500 focus:border-primary-500"></textarea>
                </div>
                
                <!-- Ø§Ù„ØªÙ‚ÙŠÙŠÙ… -->
                <div id="post-rating-field" class="hidden">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</label>
                    <div class="flex items-center gap-4">
                        <div class="star-rating text-2xl text-amber-500" id="rating-stars">
                            <i class="fa-regular fa-star cursor-pointer" data-rating="1"></i>
                            <i class="fa-regular fa-star cursor-pointer" data-rating="2"></i>
                            <i class="fa-regular fa-star cursor-pointer" data-rating="3"></i>
                            <i class="fa-regular fa-star cursor-pointer" data-rating="4"></i>
                            <i class="fa-regular fa-star cursor-pointer" data-rating="5"></i>
                        </div>
                        <input type="number" id="post-rating-input" min="1" max="5" value="5" class="w-16 input-sm text-center">
                    </div>
                </div>
                
                <!-- Ø§Ù„ÙˆØ³ÙˆÙ… -->
                <div>
                    <label for="post-tags" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Ø§Ù„ÙˆØ³ÙˆÙ…</label>
                    <input type="text" id="post-tags" placeholder="Ø£Ø¶Ù ÙˆØ³ÙˆÙ…Ø§Ù‹ (Ù…Ø«Ù„: ÙÙ„Ø³ÙØ©ØŒ Ø£Ø¯Ø¨)" class="w-full input-sm">
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Ø§ÙØµÙ„ Ø¨ÙŠÙ† Ø§Ù„ÙˆØ³ÙˆÙ… Ø¨ÙØ§ØµÙ„Ø©</p>
                </div>
                
                <!-- Ø§Ø®ØªÙŠØ§Ø± ÙƒØªØ§Ø¨ -->
                <div>
                    <label for="post-book-select" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Ø±Ø¨Ø· Ø¨ÙƒØªØ§Ø¨ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                    
                    <!-- Ø¨Ø­Ø« Ø§Ù„ÙƒØªØ¨ -->
                    <input type="text" id="book-search-input" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† ÙƒØªØ§Ø¨..." class="w-full mb-2 input-sm">
                    
                    <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙƒØªØ¨ -->
                    <div id="book-search-results" class="max-h-48 overflow-y-auto border border-gray-300 dark:border-gray-600 rounded-lg hidden mb-2">
                        <!-- Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø« ØªØ¸Ù‡Ø± Ù‡Ù†Ø§ -->
                    </div>
                    
                    <!-- Ø§Ù„ÙƒØªØ§Ø¨ Ø§Ù„Ù…Ø®ØªØ§Ø± -->
                    <select id="post-book-select" class="w-full input-sm">
                        <option value="">Ø§Ø®ØªØ± ÙƒØªØ§Ø¨Ø§Ù‹...</option>
                    </select>
                </div>
            </div>
            
            <div class="p-4 border-t border-gray-200 dark:border-gray-700 flex justify-end gap-2">
                <button onclick="hideCreatePostModal()" class="btn-sm bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300">
                    Ø¥Ù„ØºØ§Ø¡
                </button>
                <button onclick="savePost()" class="btn-sm bg-primary-500 text-white hover:bg-primary-600">
                    Ø­ÙØ¸
                </button>
            </div>
        </div>
    </div>

    <!-- Ù†Ø§ÙØ°Ø© Ø¥Ù†Ø´Ø§Ø¡/ØªØ¹Ø¯ÙŠÙ„ ÙƒØªØ§Ø¨ -->
    <div id="book-modal" class="fixed inset-0 bg-black/50 dark:bg-black/70 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 rounded-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto animate-fade-in">
            <div class="p-4 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between">
                <h3 id="book-modal-title" class="font-semibold text-gray-900 dark:text-gray-100">Ø¥Ø¶Ø§ÙØ© ÙƒØªØ§Ø¨ Ø¬Ø¯ÙŠØ¯</h3>
                <button onclick="hideCreateBookModal()" class="icon-sm text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-700">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
            
            <form id="book-form" class="p-4 space-y-4">
                <!-- Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="book-title" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙƒØªØ§Ø¨ *</label>
                        <input type="text" id="book-title" required class="w-full input-sm" placeholder="Ø£Ø¯Ø®Ù„ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙƒØªØ§Ø¨">
                    </div>
                    
                    <div>
                        <label for="book-author" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Ø§Ù„Ù…Ø¤Ù„Ù *</label>
                        <input type="text" id="book-author" required class="w-full input-sm" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø¤Ù„Ù">
                    </div>
                </div>
                
                <!-- ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù†Ø´Ø± -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label for="book-year" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Ø³Ù†Ø© Ø§Ù„Ù†Ø´Ø±</label>
                        <input type="number" id="book-year" class="w-full input-sm" placeholder="Ù…Ø«Ø§Ù„: 2023">
                    </div>
                    
                    <div>
                        <label for="book-pages" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Ø¹Ø¯Ø¯ Ø§Ù„ØµÙØ­Ø§Øª</label>
                        <input type="number" id="book-pages" class="w-full input-sm" placeholder="Ù…Ø«Ø§Ù„: 320">
                    </div>
                    
                    <div>
                        <label for="book-publisher" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Ø¯Ø§Ø± Ø§Ù„Ù†Ø´Ø±</label>
                        <input type="text" id="book-publisher" class="w-full input-sm" placeholder="Ø§Ø³Ù… Ø¯Ø§Ø± Ø§Ù„Ù†Ø´Ø±">
                    </div>
                </div>
                
                <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="book-status" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Ø­Ø§Ù„Ø© Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©</label>
                        <select id="book-status" class="w-full input-sm">
                            <option value="not_started">Ù„Ù… Ø£Ø¨Ø¯Ø£</option>
                            <option value="reading">Ø£Ù‚Ø±Ø£ Ø§Ù„Ø¢Ù†</option>
                            <option value="paused">Ù…ØªÙˆÙ‚Ù</option>
                            <option value="finished">Ù…Ù†Ø¬Ø²</option>
                        </select>
                    </div>
                    
                    <div>
                        <label for="book-progress" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Ø§Ù„ØµÙØ­Ø§Øª Ø§Ù„Ù…Ù‚Ø±ÙˆØ¡Ø©</label>
                        <input type="number" id="book-progress" class="w-full input-sm" placeholder="Ø¹Ø¯Ø¯ Ø§Ù„ØµÙØ­Ø§Øª Ø§Ù„Ù…Ù‚Ø±ÙˆØ¡Ø©">
                    </div>
                </div>
                
                <!-- Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label for="book-start-date" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø¡</label>
                        <input type="date" id="book-start-date" class="w-full input-sm">
                    </div>
                    
                    <div>
                        <label for="book-finish-date" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ù‡Ø§Ø¡</label>
                        <input type="date" id="book-finish-date" class="w-full input-sm">
                    </div>
                    
                    <div>
                        <label for="book-pause-date" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙˆÙ‚Ù</label>
                        <input type="date" id="book-pause-date" class="w-full input-sm">
                    </div>
                </div>
                
                <!-- Ø§Ù„ØªØµÙ†ÙŠÙ ÙˆØ§Ù„Ù„ØºØ© -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="book-category" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Ø§Ù„ØªØµÙ†ÙŠÙ</label>
                        <select id="book-category" class="w-full input-sm">
                            <option value="">Ø§Ø®ØªØ± ØªØµÙ†ÙŠÙØ§Ù‹</option>
                            <option value="fiction">Ø£Ø¯Ø¨</option>
                            <option value="non-fiction">ØºÙŠØ± Ø£Ø¯Ø¨ÙŠ</option>
                            <option value="philosophy">ÙÙ„Ø³ÙØ©</option>
                            <option value="science">Ø¹Ù„Ù…</option>
                            <option value="history">ØªØ§Ø±ÙŠØ®</option>
                            <option value="biography">Ø³ÙŠØ±Ø© Ø°Ø§ØªÙŠØ©</option>
                            <option value="self_help">ØªØ·ÙˆÙŠØ± Ø§Ù„Ø°Ø§Øª</option>
                        </select>
                    </div>
                    
                    <div>
                        <label for="book-language" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Ù„ØºØ© Ø§Ù„ÙƒØªØ§Ø¨</label>
                        <select id="book-language" class="w-full input-sm">
                            <option value="arabic">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
                            <option value="english">Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©</option>
                            <option value="french">Ø§Ù„ÙØ±Ù†Ø³ÙŠØ©</option>
                            <option value="other">Ø£Ø®Ø±Ù‰</option>
                        </select>
                    </div>
                </div>
                
                <!-- Ø§Ù„Ø³Ù„Ø³Ù„Ø© -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="book-series" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Ø§Ù„Ø³Ù„Ø³Ù„Ø©</label>
                        <input type="text" id="book-series" class="w-full input-sm" placeholder="Ø§Ø³Ù… Ø§Ù„Ø³Ù„Ø³Ù„Ø©">
                    </div>
                    
                    <div>
                        <label for="book-volume" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Ø±Ù‚Ù… Ø§Ù„Ø¬Ø²Ø¡</label>
                        <input type="number" id="book-volume" class="w-full input-sm" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø¬Ø²Ø¡">
                    </div>
                </div>
                
                <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="book-translator" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Ø§Ù„Ù…ØªØ±Ø¬Ù…</label>
                        <input type="text" id="book-translator" class="w-full input-sm" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ØªØ±Ø¬Ù…">
                    </div>
                    
                    <div>
                        <label for="book-edition" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Ø±Ù‚Ù… Ø§Ù„Ø·Ø¨Ø¹Ø©</label>
                        <input type="number" id="book-edition" class="w-full input-sm" placeholder="Ø§Ù„Ø·Ø¨Ø¹Ø©">
                    </div>
                </div>
                
                <!-- Ù…ÙƒØ§Ù† Ø§Ù„ÙƒØªØ§Ø¨ -->
                <div>
                    <label for="book-location" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Ù…ÙƒØ§Ù† Ø§Ù„ÙƒØªØ§Ø¨</label>
                    <select id="book-location" class="w-full input-sm">
                        <option value="physical_home">Ù†Ø³Ø®Ø© ÙˆØ±Ù‚ÙŠØ© ÙÙŠ Ø§Ù„Ø¨ÙŠØª</option>
                        <option value="ebook">Ù†Ø³Ø®Ø© Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©</option>
                        <option value="pdf">PDF</option>
                        <option value="online">Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†</option>
                    </select>
                </div>
                
                <!-- Ø§Ù„Ø±ÙÙˆÙ -->
                <div>
                    <label for="book-shelves-select" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Ø§Ù„Ø±ÙÙˆÙ</label>
                    <select id="book-shelves-select" multiple class="w-full input-sm h-32">
                        <!-- Ø§Ù„Ø±ÙÙˆÙ ØªØ¸Ù‡Ø± Ù‡Ù†Ø§ -->
                    </select>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Ø§Ø¶ØºØ· Ctrl Ù„Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…ØªØ¹Ø¯Ø¯</p>
                </div>
                
                <!-- Ø§Ù„ØªÙ‚ÙŠÙŠÙ… -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ØªÙ‚ÙŠÙŠÙ…Ùƒ Ø§Ù„Ø´Ø®ØµÙŠ</label>
                    <div class="flex items-center gap-4">
                        <div class="star-rating text-2xl text-amber-500" id="book-rating-stars">
                            <i class="fa-regular fa-star cursor-pointer" data-rating="1"></i>
                            <i class="fa-regular fa-star cursor-pointer" data-rating="2"></i>
                            <i class="fa-regular fa-star cursor-pointer" data-rating="3"></i>
                            <i class="fa-regular fa-star cursor-pointer" data-rating="4"></i>
                            <i class="fa-regular fa-star cursor-pointer" data-rating="5"></i>
                        </div>
                        <input type="hidden" id="book-rating" value="0">
                    </div>
                </div>
                
                <!-- ØªÙ‚ÙŠÙŠÙ… Ù†ØµÙŠ -->
                <div>
                    <label for="book-rating-text" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ØªÙ‚ÙŠÙŠÙ… Ù†ØµÙŠ Ù‚ØµÙŠØ±</label>
                    <input type="text" id="book-rating-text" class="w-full input-sm" placeholder="Ø±Ø£ÙŠÙƒ Ø¨ÙƒÙ„Ù…Ø§Øª Ø¨Ø³ÙŠØ·Ø©">
                </div>
                
                <!-- Ø§Ù„Ù…Ù„Ø®Øµ -->
                <div>
                    <label for="book-summary" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Ù…Ù„Ø®Øµ Ù‚ØµÙŠØ± Ù„Ù„ÙƒØªØ§Ø¨</label>
                    <textarea id="book-summary" rows="3" class="w-full input-sm" placeholder="Ø§ÙƒØªØ¨ Ù…Ù„Ø®ØµØ§Ù‹ Ù‚ØµÙŠØ±Ø§Ù‹ Ù„Ù„ÙƒØªØ§Ø¨"></textarea>
                </div>
                
                <!-- Ù†Ø¨Ø°Ø© Ø¹Ù† Ø§Ù„ÙƒØ§ØªØ¨ -->
                <div>
                    <label for="book-author-bio" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Ù†Ø¨Ø°Ø© Ø¹Ù† Ø§Ù„ÙƒØ§ØªØ¨</label>
                    <textarea id="book-author-bio" rows="2" class="w-full input-sm" placeholder="Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù…Ø®ØªØµØ±Ø© Ø¹Ù† Ø§Ù„Ù…Ø¤Ù„Ù"></textarea>
                </div>
                
                <!-- Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø´Ø®ØµÙŠØ© -->
                <div>
                    <label for="book-notes" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø´Ø®ØµÙŠØ©</label>
                    <textarea id="book-notes" rows="3" class="w-full input-sm" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§ØªÙƒ Ø¹Ù† Ø§Ù„ÙƒØªØ§Ø¨"></textarea>
                </div>
                
                <!-- ØµÙˆØ±Ø© Ø§Ù„ØºÙ„Ø§Ù -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ØµÙˆØ±Ø© Ø§Ù„ØºÙ„Ø§Ù</label>
                    <div class="border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-4 text-center cursor-pointer hover:border-primary-400 transition-colors" onclick="document.getElementById('book-cover-input').click()">
                        <input type="file" id="book-cover-input" accept="image/*" class="hidden" onchange="previewBookCover(event)">
                        <div id="book-cover-preview" class="w-32 h-48 mx-auto bg-gray-100 dark:bg-gray-700 rounded flex flex-col items-center justify-center mb-4 overflow-hidden">
                            <i class="fa-solid fa-image text-4xl text-gray-400 dark:text-gray-500 mb-3"></i>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Ø§Ù†Ù‚Ø± Ù„ØªØ­Ù…ÙŠÙ„ ØµÙˆØ±Ø©</p>
                        </div>
                        <p class="text-xs text-gray-500 dark:text-gray-400">Ø§Ù„ØµÙˆØ± ØªØªØ­Ù…Ù„ Ø¨Ø¬ÙˆØ¯Ø© Ø¹Ø§Ù„ÙŠØ©</p>
                    </div>
                </div>
            </form>
            
            <div class="p-4 border-t border-gray-200 dark:border-gray-700 flex justify-end gap-2">
                <button onclick="hideCreateBookModal()" class="btn-sm bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300">
                    Ø¥Ù„ØºØ§Ø¡
                </button>
                <button onclick="saveBook()" class="btn-sm bg-primary-500 text-white hover:bg-primary-600">
                    Ø­ÙØ¸ Ø§Ù„ÙƒØªØ§Ø¨
                </button>
            </div>
        </div>
    </div>

    <!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª -->
    <div id="settings-modal" class="fixed inset-0 bg-black/50 dark:bg-black/70 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 rounded-xl w-full max-w-md max-h-[90vh] overflow-y-auto animate-fade-in">
            <div class="p-4 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between">
                <h3 class="font-semibold text-gray-900 dark:text-gray-100">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø«ÙŠÙ…</h3>
                <button onclick="hideSettingsModal()" class="icon-sm text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-700">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
            
            <div class="p-4 space-y-6">
                <!-- Ø§Ù„Ø«ÙŠÙ…Ø§Øª -->
                <div>
                    <h4 class="font-medium text-gray-900 dark:text-gray-100 mb-3">Ø§Ø®ØªØ± Ù†Ù…Ø· Ø§Ù„Ø¹Ø±Ø¶</h4>
                    <div class="grid grid-cols-2 gap-3">
                        <div class="theme-option p-3 rounded-lg border-2 border-transparent cursor-pointer hover:border-primary-400 transition-all" data-theme="default" onclick="selectTheme('default')">
                            <div class="w-8 h-8 bg-gradient-to-br from-blue-400 to-purple-500 rounded-lg mb-2"></div>
                            <p class="text-sm font-medium">Ø£Ø³Ø§Ø³ÙŠ</p>
                            <p class="text-xs text-gray-500">Ù‡Ø§Ø¯Ø¦ ÙˆØ£Ù†ÙŠÙ‚</p>
                        </div>
                        
                        <div class="theme-option p-3 rounded-lg border-2 border-transparent cursor-pointer hover:border-primary-400 transition-all" data-theme="forest" onclick="selectTheme('forest')">
                            <div class="w-8 h-8 bg-gradient-to-br from-emerald-400 to-green-500 rounded-lg mb-2"></div>
                            <p class="text-sm font-medium">ØºØ§Ø¨Ø©</p>
                            <p class="text-xs text-gray-500">Ø£Ø®Ø¶Ø± Ø·Ø¨ÙŠØ¹ÙŠ</p>
                        </div>
                        
                        <div class="theme-option p-3 rounded-lg border-2 border-transparent cursor-pointer hover:border-primary-400 transition-all" data-theme="sunset" onclick="selectTheme('sunset')">
                            <div class="w-8 h-8 bg-gradient-to-br from-orange-400 to-pink-500 rounded-lg mb-2"></div>
                            <p class="text-sm font-medium">ØºØ±ÙˆØ¨</p>
                            <p class="text-xs text-gray-500">Ø¯Ø§ÙØ¦ ÙˆÙ…Ø´Ø±Ù‚</p>
                        </div>
                        
                        <div class="theme-option p-3 rounded-lg border-2 border-transparent cursor-pointer hover:border-primary-400 transition-all" data-theme="ocean" onclick="selectTheme('ocean')">
                            <div class="w-8 h-8 bg-gradient-to-br from-cyan-400 to-blue-500 rounded-lg mb-2"></div>
                            <p class="text-sm font-medium">Ù…Ø­ÙŠØ·</p>
                            <p class="text-xs text-gray-500">Ø£Ø²Ø±Ù‚ Ø³Ù…Ø§ÙˆÙŠ</p>
                        </div>
                        
                        <div class="theme-option p-3 rounded-lg border-2 border-transparent cursor-pointer hover:border-primary-400 transition-all" data-theme="royal" onclick="selectTheme('royal')">
                            <div class="w-8 h-8 bg-gradient-to-br from-purple-400 to-indigo-500 rounded-lg mb-2"></div>
                            <p class="text-sm font-medium">Ù…Ù„ÙƒÙŠ</p>
                            <p class="text-xs text-gray-500">Ø£Ø±Ø¬ÙˆØ§Ù†ÙŠ Ø¹Ù…ÙŠÙ‚</p>
                        </div>
                        
                        <div class="theme-option p-3 rounded-lg border-2 border-transparent cursor-pointer hover:border-primary-400 transition-all" data-theme="earth" onclick="selectTheme('earth')">
                            <div class="w-8 h-8 bg-gradient-to-br from-amber-400 to-brown-500 rounded-lg mb-2"></div>
                            <p class="text-sm font-medium">Ø£Ø±Ø¶ÙŠ</p>
                            <p class="text-xs text-gray-500">Ø¨Ù†ÙŠ Ø¯Ø§ÙØ¦</p>
                        </div>
                    </div>
                </div>
                
                <!-- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ -->
                <div>
                    <h4 class="font-medium text-gray-900 dark:text-gray-100 mb-3">Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ</h4>
                    <div class="space-y-3">
                        <button onclick="exportBackup()" class="w-full btn-sm bg-emerald-500 text-white hover:bg-emerald-600 flex items-center justify-center gap-2">
                            <i class="fa-solid fa-download"></i>
                            ØªØµØ¯ÙŠØ± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                        </button>
                        
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙƒÙ„</label>
                            <select id="auto-backup-frequency" class="w-full input-sm">
                                <option value="never">Ù„Ø§</option>
                                <option value="weekly">Ø£Ø³Ø¨ÙˆØ¹</option>
                                <option value="monthly">Ø´Ù‡Ø±</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨Ø­Ø« -->
                <div>
                    <h4 class="font-medium text-gray-900 dark:text-gray-100 mb-3">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨Ø­Ø«</h4>
                    <div class="space-y-3">
                        <label class="flex items-center justify-between">
                            <span class="text-sm text-gray-700 dark:text-gray-300">Ø§Ù„Ø¨Ø­Ø« Ø§Ù„ÙÙˆØ±ÙŠ</span>
                            <input type="checkbox" id="instant-search" class="rounded" checked>
                        </label>
                        
                        <label class="flex items-center justify-between">
                            <span class="text-sm text-gray-700 dark:text-gray-300">ØªØ¶Ù…ÙŠÙ† Ø§Ù„ÙˆØ³ÙˆÙ…</span>
                            <input type="checkbox" id="search-include-tags" class="rounded" checked>
                        </label>
                        
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">Ø¯Ù‚Ø© Ø§Ù„Ø¨Ø­Ø«</label>
                            <select id="search-precision" class="w-full input-sm">
                                <option value="normal">Ø·Ø¨ÙŠØ¹ÙŠ</option>
                                <option value="strict">Ø¯Ù‚ÙŠÙ‚</option>
                                <option value="loose">Ù…Ø±Ù†</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© -->
                <div>
                    <h4 class="font-medium text-gray-900 dark:text-gray-100 mb-3">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©</h4>
                    <div class="space-y-3">
                        <label class="flex items-center justify-between">
                            <span class="text-sm text-gray-700 dark:text-gray-300">Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ù…ØªØ­Ø±ÙƒØ©</span>
                            <input type="checkbox" id="animations-enabled" class="rounded" checked>
                        </label>
                        
                        <label class="flex items-center justify-between">
                            <span class="text-sm text-gray-700 dark:text-gray-300">Ø¸Ù„Ø§Ù„ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª</span>
                            <input type="checkbox" id="card-shadows" class="rounded" checked>
                        </label>
                        
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">Ø­Ø¬Ù… Ø§Ù„Ø®Ø·</label>
                            <select id="font-size" class="w-full input-sm">
                                <option value="small">ØµØºÙŠØ±</option>
                                <option value="normal" selected>Ø·Ø¨ÙŠØ¹ÙŠ</option>
                                <option value="large">ÙƒØ¨ÙŠØ±</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="p-4 border-t border-gray-200 dark:border-gray-700 flex justify-end">
                <button onclick="hideSettingsModal()" class="btn-sm bg-primary-500 text-white hover:bg-primary-600">
                    Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
                </button>
            </div>
        </div>
    </div>

    <!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù…ØªÙ‚Ø¯Ù… -->
    <div id="advanced-search-modal" class="fixed inset-0 bg-black/50 dark:bg-black/70 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 rounded-xl w-full max-w-md max-h-[90vh] overflow-y-auto animate-fade-in">
            <div class="p-4 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between">
                <h3 class="font-semibold text-gray-900 dark:text-gray-100">Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù…ØªÙ‚Ø¯Ù…</h3>
                <button onclick="hideAdvancedSearch()" class="icon-sm text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-700">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
            
            <div class="p-4 space-y-4">
                <!-- Ø§Ù„Ù†Øµ -->
                <div>
                    <label for="advanced-search-text" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Ø§Ù„Ù†Øµ</label>
                    <input type="text" id="advanced-search-text" class="w-full input-sm" placeholder="Ø§ÙƒØªØ¨ Ù„Ù„Ø¨Ø­Ø«...">
                </div>
                
                <!-- Ø§Ù„Ù†ÙˆØ¹ -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Ø§Ù„Ù†ÙˆØ¹</label>
                    <div class="grid grid-cols-2 gap-2">
                        <label class="flex items-center gap-2">
                            <input type="checkbox" id="search-type-book" class="rounded" checked>
                            <span class="text-sm text-gray-700 dark:text-gray-300">ÙƒØªØ¨</span>
                        </label>
                        <label class="flex items-center gap-2">
                            <input type="checkbox" id="search-type-quote" class="rounded" checked>
                            <span class="text-sm text-gray-700 dark:text-gray-300">Ø§Ù‚ØªØ¨Ø§Ø³Ø§Øª</span>
                        </label>
                        <label class="flex items-center gap-2">
                            <input type="checkbox" id="search-type-review" class="rounded" checked>
                            <span class="text-sm text-gray-700 dark:text-gray-300">Ù…Ø±Ø§Ø¬Ø¹Ø§Øª</span>
                        </label>
                        <label class="flex items-center gap-2">
                            <input type="checkbox" id="search-type-note" class="rounded" checked>
                            <span class="text-sm text-gray-700 dark:text-gray-300">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</span>
                        </label>
                    </div>
                </div>
                
                <!-- Ø§Ù„ØªÙ‚ÙŠÙŠÙ… -->
                <div>
                    <label for="search-rating" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</label>
                    <select id="search-rating" class="w-full input-sm">
                        <option value="">Ø§Ù„ÙƒÙ„</option>
                        <option value="5">â­â­â­â­â­ ÙÙ‚Ø·</option>
                        <option value="4">â­â­â­â­ ÙØ£Ø¹Ù„Ù‰</option>
                        <option value="3">â­â­â­ ÙØ£Ø¹Ù„Ù‰</option>
                    </select>
                </div>
                
                <!-- Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="search-date-from" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Ù…Ù† ØªØ§Ø±ÙŠØ®</label>
                        <input type="date" id="search-date-from" class="w-full input-sm">
                    </div>
                    
                    <div>
                        <label for="search-date-to" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label>
                        <input type="date" id="search-date-to" class="w-full input-sm">
                    </div>
                </div>
                
                <!-- Ø§Ù„ÙØ±Ø² -->
                <div>
                    <label for="search-sort" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ØªØ±ØªÙŠØ¨ Ø§Ù„Ù†ØªØ§Ø¦Ø¬</label>
                    <select id="search-sort" class="w-full input-sm">
                        <option value="newest">Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹</option>
                        <option value="oldest">Ø§Ù„Ø£Ù‚Ø¯Ù… Ø£ÙˆÙ„Ø§Ù‹</option>
                        <option value="alphabetical">Ø§Ù„Ø£Ø¨Ø¬Ø¯ÙŠ</option>
                        <option value="rating">Ø§Ù„Ø£Ø¹Ù„Ù‰ ØªÙ‚ÙŠÙŠÙ…Ø§Ù‹</option>
                    </select>
                </div>
                
                <!-- Ø§Ù„Ø¯Ù‚Ø© -->
                <div>
                    <label for="search-precision-advanced" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Ø¯Ù‚Ø© Ø§Ù„Ø¨Ø­Ø«</label>
                    <select id="search-precision-advanced" class="w-full input-sm">
                        <option value="partial">ØªØ·Ø§Ø¨Ù‚ Ø¬Ø²Ø¦ÙŠ</option>
                        <option value="exact">ØªØ·Ø§Ø¨Ù‚ ÙƒØ§Ù…Ù„</option>
                        <option value="fuzzy">ØªÙ‚Ø±ÙŠØ¨ÙŠ</option>
                    </select>
                </div>
            </div>
            
            <div class="p-4 border-t border-gray-200 dark:border-gray-700 flex justify-end gap-2">
                <button onclick="hideAdvancedSearch()" class="btn-sm bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300">
                    Ø¥Ù„ØºØ§Ø¡
                </button>
                <button onclick="performAdvancedSearch()" class="btn-sm bg-primary-500 text-white hover:bg-primary-600">
                    Ø¨Ø­Ø«
                </button>
            </div>
        </div>
    </div>

    <!-- Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ -->
    <div id="loading-overlay" class="fixed inset-0 bg-black/50 dark:bg-black/70 z-50 hidden flex items-center justify-center">
        <div class="bg-white dark:bg-gray-800 rounded-xl p-8 flex flex-col items-center">
            <div class="loading-spinner mb-4"></div>
            <p class="text-gray-700 dark:text-gray-300 font-medium">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
        </div>
    </div>

    <!-- Ø§Ù„ØªÙ†Ù‚Ù„ Ø§Ù„Ø³ÙÙ„ÙŠ -->
    <nav class="fixed bottom-0 left-0 right-0 glass-effect border-t border-gray-200 dark:border-gray-700">
        <div class="max-w-lg mx-auto flex justify-around py-3">
            <button class="nav-btn flex flex-col items-center p-2 text-gray-500" data-view="home" onclick="navigateTo('home')">
                <i class="fa-solid fa-house text-lg mb-1"></i>
                <span class="text-xs">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
            </button>
            <button class="nav-btn flex flex-col items-center p-2 text-gray-500" data-view="writings" onclick="navigateTo('writings')">
                <i class="fa-solid fa-pen text-lg mb-1"></i>
                <span class="text-xs">ÙƒØªØ§Ø¨Ø§ØªÙŠ</span>
            </button>
            <button class="nav-btn flex flex-col items-center p-2 text-gray-500" data-view="books" onclick="navigateTo('books')">
                <i class="fa-solid fa-book text-lg mb-1"></i>
                <span class="text-xs">Ø§Ù„Ù…ÙƒØªØ¨Ø©</span>
            </button>
            <button class="nav-btn flex flex-col items-center p-2 text-gray-500" data-view="shelves" onclick="navigateTo('shelves')">
                <i class="fa-solid fa-boxes-stacked text-lg mb-1"></i>
                <span class="text-xs">Ø§Ù„Ø±ÙÙˆÙ</span>
            </button>
            <button class="nav-btn flex flex-col items-center p-2 text-gray-500" data-view="menu" onclick="navigateTo('menu')">
                <i class="fa-solid fa-gear text-lg mb-1"></i>
                <span class="text-xs">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</span>
            </button>
        </div>
    </nav>

<!-- ========================================================================= -->
<!-- JavaScript Ø§Ù„ÙƒØ§Ù…Ù„ -->
<!-- ========================================================================= -->
<script>
    // =========================================================================
    // 1. Ø§Ù„Ø«ÙˆØ§Ø¨Øª ÙˆØ¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø§Ù„Ø©
    // =========================================================================
    
    const SHELVES = [
        { key: 'reading', title: 'Ø£Ù‚Ø±Ø£Ù‡ Ø­Ø§Ù„ÙŠØ§Ù‹', desc: 'Ø§Ù„ÙƒØªØ¨ Ø§Ù„ØªÙŠ Ø£ØªØ§Ø¨Ø¹Ù‡Ø§ Ø§Ù„Ø¢Ù†', icon: 'fa-book-open', color: 'shelf-reading' },
        { key: 'want_to_read', title: 'Ø£Ø±ØºØ¨ Ø¨Ù‚Ø±Ø§Ø¡ØªÙ‡', desc: 'ÙƒØªØ¨ Ø®Ø·Ø·Øª Ù„Ù‚Ø±Ø§Ø¡ØªÙ‡Ø§', icon: 'fa-bookmark', color: 'shelf-want_to_read' },
        { key: 'liked', title: 'Ø£Ø¹Ø¬Ø¨Ù†ÙŠ', desc: 'ÙƒØªØ¨ Ø§Ø³ØªÙ…ØªØ¹Øª Ø¨Ù‚Ø±Ø§Ø¡ØªÙ‡Ø§', icon: 'fa-heart', color: 'shelf-liked' },
        { key: 'recommended', title: 'Ø£Ù†ØµØ­ Ø¨Ù‡', desc: 'ÙƒØªØ¨ Ø£ÙˆØµÙŠ Ø¨Ù‡Ø§ Ù„Ù„Ø¢Ø®Ø±ÙŠÙ†', icon: 'fa-star', color: 'shelf-recommended' },
        { key: 'life_changing', title: 'ØºÙŠÙ‘Ø± ØªÙÙƒÙŠØ±ÙŠ', desc: 'ÙƒØªØ¨ Ø£Ø«Ø±Øª Ø¹Ù„Ù‰ Ø±Ø¤ÙŠØªÙŠ', icon: 'fa-brain', color: 'shelf-life_changing' },
        { key: 'thought_provoking', title: 'Ø­ÙŠÙ‘Ø±Ù†ÙŠ', desc: 'ÙƒØªØ¨ Ø·Ø±Ø­Øª Ø£Ø³Ø¦Ù„Ø© ØµØ¹Ø¨Ø©', icon: 'fa-lightbulb', color: 'shelf-thought_provoking' },
        { key: 'heavy_but_important', title: 'Ø«Ù‚ÙŠÙ„ Ù„ÙƒÙ† Ù…Ù‡Ù…', desc: 'ÙƒØªØ¨ ØªØ­ØªØ§Ø¬ Ù„Ø¬Ù‡Ø¯', icon: 'fa-weight-hanging', color: 'shelf-heavy_but_important' },
        { key: 'emotional', title: 'Ø¹Ø§Ø·ÙÙŠ', desc: 'ÙƒØªØ¨ Ø£Ø«Ø±Øª Ø¹Ù„Ù‰ Ù…Ø´Ø§Ø¹Ø±ÙŠ', icon: 'fa-heart-crack', color: 'shelf-emotional' },
        { key: 'faded_out', title: 'Ø¨Ø¯Ø£ Ù‚ÙˆÙŠÙ‹Ø§ Ø«Ù… Ø®ÙÙ‘', desc: 'ÙƒØªØ¨ Ø§Ù†Ø®ÙØ¶ Ù…Ø³ØªÙˆØ§Ù‡Ø§', icon: 'fa-battery-empty', color: 'shelf-faded_out' },
        { key: 'experimental', title: 'ØªØ¬Ø±Ø¨Ø©', desc: 'ÙƒØªØ¨ Ù‚Ø±Ø£ØªÙ‡Ø§ Ù„ØªØ¬Ø±Ø¨Ø© Ù†Ù…Ø· Ø¬Ø¯ÙŠØ¯', icon: 'fa-flask', color: 'shelf-experimental' }
    ];

    const WRITING_SHELVES = {
        'quotes': { title: 'Ø§Ù„Ø§Ù‚ØªØ¨Ø§Ø³Ø§Øª', desc: 'Ø£Ø¬Ù…Ù„ Ù…Ø§ Ø®Ø·Ù‡ Ø§Ù„Ø¢Ø®Ø±ÙˆÙ† Ù…Ù† Ø­ÙƒÙ… ÙˆØ£Ù‚ÙˆØ§Ù„', icon: 'fa-quote-right', color: 'blue' },
        'reviews': { title: 'Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø§Øª', desc: 'Ù…Ø±Ø§Ø¬Ø¹Ø§Øª Ù…ÙØµÙ„Ø© Ù„Ù„ÙƒØªØ¨ Ø§Ù„ØªÙŠ Ù‚Ø±Ø£ØªÙ‡Ø§', icon: 'fa-star', color: 'amber' },
        'notes': { title: 'Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª', desc: 'Ø®ÙˆØ§Ø·Ø±ÙŠ ÙˆØªØ£Ù…Ù„Ø§ØªÙŠ Ø§Ù„Ø´Ø®ØµÙŠØ©', icon: 'fa-note-sticky', color: 'emerald' }
    };

    const READING_STATUS = {
        'not_started': { text: 'Ù„Ù… Ø£Ø¨Ø¯Ø£', color: 'gray' },
        'reading': { text: 'Ø£Ù‚Ø±Ø£ Ø§Ù„Ø¢Ù†', color: 'blue' },
        'paused': { text: 'Ù…ØªÙˆÙ‚Ù', color: 'orange' },
        'finished': { text: 'Ù…Ù†Ø¬Ø²', color: 'green' }
    };

    const BOOK_LOCATIONS = {
        'physical_home': { text: 'Ù†Ø³Ø®Ø© ÙˆØ±Ù‚ÙŠØ©', icon: 'fa-book' },
        'ebook': { text: 'Ù†Ø³Ø®Ø© Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©', icon: 'fa-tablet' },
        'pdf': { text: 'PDF', icon: 'fa-file-pdf' },
        'online': { text: 'Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†', icon: 'fa-globe' }
    };

    const POST_TYPES = {
        'quote': { icon: 'fa-quote-right', text: 'Ø§Ù‚ØªØ¨Ø§Ø³', color: 'blue' },
        'note': { icon: 'fa-note-sticky', text: 'Ù…Ù„Ø§Ø­Ø¸Ø©', color: 'emerald' },
        'review': { icon: 'fa-star', text: 'Ù…Ø±Ø§Ø¬Ø¹Ø©', color: 'amber' },
        'thought': { icon: 'fa-lightbulb', text: 'ÙÙƒØ±Ø©', color: 'purple' }
    };

    const AppState = {
        currentView: 'home',
        currentShelf: null,
        currentWritingShelf: null,
        currentBookId: null,
        editingPostId: null,
        editingBookId: null,
        books: [],
        posts: [],
        profile: { 
            name: 'Ù‚Ø§Ø±Ø¦', 
            bio: 'Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙƒØªØ¨Ø©',
            fullName: '',
            birthdate: '',
            nationality: '',
            location: '',
            stats: {
                booksRead: 0,
                favoriteBooks: 0,
                readingHours: 0,
                currentBooks: 0
            }
        },
        settings: { theme: 'default', mode: 'light' },
        navigationStack: [],
        searchQuery: '',
        booksViewMode: 'grid',
        currentPostSort: 'newest',
        showPinnedOnly: false,
        searchFilter: 'all',
        fuseBooks: null,
        fusePosts: null
    };

    // =========================================================================
    // 2. Ø§Ù„ØªÙ‡ÙŠØ¦Ø©
    // =========================================================================

    async function initApp() {
        try {
            showLoading();
            await DB.init();
            await setupInitialData();
            await loadData();
            setupEventListeners();
            setupSearchIndexes();
            navigateTo('home');
            hideLoading();
            
            // ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø­Ø³Ø¨ Ø§Ù„Ø·Ù„Ø¨
        } catch (error) {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚:', error);
            showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚', 'error');
            hideLoading();
        }
    }

    function showLoading() {
        document.getElementById('loading-overlay').classList.remove('hidden');
    }

    function hideLoading() {
        document.getElementById('loading-overlay').classList.add('hidden');
    }

    async function loadData() {
        try {
            AppState.books = await DB.getAll('books') || [];
            AppState.posts = await DB.getAll('posts') || [];
            AppState.profile = await DB.getAll('profile') || { 
                name: 'Ù‚Ø§Ø±Ø¦', 
                bio: 'Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙƒØªØ¨Ø©',
                fullName: '',
                birthdate: '',
                nationality: '',
                location: '',
                stats: {
                    booksRead: 0,
                    favoriteBooks: 0,
                    readingHours: 0,
                    currentBooks: 0
                }
            };
            AppState.settings = await DB.getAll('settings') || { theme: 'default', mode: 'light' };
            
            // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø«ÙŠÙ… Ø§Ù„Ù…Ø­ÙÙˆØ¸
            applyTheme(AppState.settings.theme, AppState.settings.mode === 'dark');
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
            updateStats();
            
            console.log(`âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ${AppState.books.length} ÙƒØªØ§Ø¨ Ùˆ ${AppState.posts.length} Ù…Ù†Ø´ÙˆØ±`);
        } catch (error) {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
        }
    }

    function setupSearchIndexes() {
        AppState.fuseBooks = new Fuse(AppState.books, {
            keys: ['title', 'author', 'publisher', 'category', 'series', 'notes', 'summary'],
            threshold: 0.3,
            includeScore: true
        });
        
        AppState.fusePosts = new Fuse(AppState.posts, {
            keys: ['content', 'tags', 'type'],
            threshold: 0.3,
            includeScore: true
        });
    }

    function setupEventListeners() {
        // Ø§Ù„Ø¨Ø­Ø« Ø§Ù„ÙÙˆØ±ÙŠ
        document.getElementById('search-input')?.addEventListener('input', debounce(function(e) {
            handleSearch(e.target.value);
        }, 300));
        
        // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø´ÙˆØ±
        document.getElementById('book-search-input')?.addEventListener('input', function(e) {
            searchBooksInModal(e.target.value);
        });
        
        // Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«
        document.addEventListener('click', function(e) {
            if (!e.target.closest('#book-search-results') && !e.target.closest('#book-search-input')) {
                document.getElementById('book-search-results').classList.add('hidden');
            }
        });
        
        // Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯
        document.getElementById('import-file-input')?.addEventListener('change', handleImport);
        
        // Ø§Ù„Ù†Ø¬Ù…Ø© ÙÙŠ Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø´ÙˆØ±
        document.getElementById('rating-stars')?.addEventListener('click', function(e) {
            if (e.target.matches('i')) {
                const rating = parseInt(e.target.dataset.rating);
                setPostRating(rating);
            }
        });
        
        // Ø§Ù„Ù†Ø¬Ù…Ø© ÙÙŠ Ù†Ø§ÙØ°Ø© Ø§Ù„ÙƒØªØ§Ø¨
        document.getElementById('book-rating-stars')?.addEventListener('click', function(e) {
            if (e.target.matches('i')) {
                const rating = parseInt(e.target.dataset.rating);
                setBookRating(rating);
            }
        });
        
        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ
        loadDarkMode();
    }

    function debounce(func, delay) {
        let timeout;
        return function(...args) {
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(this, args), delay);
        };
    }

    function loadDarkMode() {
        const savedTheme = localStorage.getItem('theme');
        const savedMode = localStorage.getItem('mode');
        
        if (savedTheme) {
            AppState.settings.theme = savedTheme;
        }
        
        if (savedMode === 'dark') {
            document.documentElement.classList.add('dark');
            const toggleBtn = document.getElementById('theme-toggle');
            const circle = toggleBtn.querySelector('div');
            circle.style.transform = 'translateX(1.75rem)';
        }
    }

    // =========================================================================
    // 3. Ø§Ù„ØªÙ†Ù‚Ù„ ÙˆØ§Ù„ÙˆØ§Ø¬Ù‡Ø©
    // =========================================================================

    function navigateTo(viewId, params = {}) {
        // Ø¥Ø®ÙØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙØ­Ø§Øª
        document.querySelectorAll('.view-section').forEach(section => {
            section.classList.add('hidden');
        });
        
        // ØªØ­Ø¯ÙŠØ§Øª Ø§Ù„ØªÙ†Ù‚Ù„
        if (viewId !== AppState.currentView) {
            AppState.navigationStack.push(AppState.currentView);
        }
        
        // Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ø°Ø§ Ù„Ø²Ù…
        const backBtn = document.getElementById('back-btn');
        if (viewId !== 'home') {
            backBtn.classList.remove('hidden');
        } else {
            backBtn.classList.add('hidden');
        }
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù†ÙˆØ§Ù†
        updateHeaderTitle(viewId);
        
        // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
        const targetSection = document.getElementById(`view-${viewId}`);
        if (targetSection) {
            targetSection.classList.remove('hidden');
            AppState.currentView = viewId;
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ†Ù‚Ù„ Ø§Ù„Ø³ÙÙ„ÙŠ
            updateNavigation(viewId);
            
            // ØªØ­Ù…ÙŠÙ„ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØµÙØ­Ø©
            switch(viewId) {
                case 'home':
                    loadHomePosts();
                    break;
                case 'books':
                    loadBooksView();
                    break;
                case 'shelves':
                    renderShelvesGrid();
                    break;
                case 'writings':
                    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø¹Ø±Ø¶ Ø§Ù„Ø±ÙÙˆÙ
                    document.getElementById('writings-shelf-view').classList.add('hidden');
                    document.querySelector('#view-writings > div:nth-child(2)').classList.remove('hidden');
                    break;
                case 'menu':
                    loadMenuStats();
                    loadProfileForm();
                    break;
                case 'book-details':
                    if (params.id) {
                        AppState.currentBookId = params.id;
                        loadBookDetails(params.id);
                    }
                    break;
                case 'search':
                    // Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø­Ø§Ù„ÙŠ
                    if (AppState.searchQuery) {
                        performSearch(AppState.searchQuery);
                    }
                    break;
            }
        }
        
        // Ø§Ù„ØªÙ…Ø±ÙŠØ± Ù„Ù„Ø£Ø¹Ù„Ù‰
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function updateHeaderTitle(viewId) {
        const titles = {
            'home': 'Ø³Ø¬Ù„Ùƒ Ø§Ù„Ø£Ø¯Ø¨ÙŠ',
            'writings': 'ÙƒØªØ§Ø¨Ø§ØªÙŠ',
            'books': 'Ø§Ù„Ù…ÙƒØªØ¨Ø©',
            'shelves': 'Ø§Ù„Ø±ÙÙˆÙ',
            'menu': 'Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª',
            'search': 'Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«',
            'book-details': 'ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙƒØªØ§Ø¨'
        };
        document.getElementById('header-title').textContent = titles[viewId] || 'Ø³Ø¬Ù„Ùƒ Ø§Ù„Ø£Ø¯Ø¨ÙŠ';
    }

    function updateNavigation(viewId) {
        document.querySelectorAll('.nav-btn').forEach(btn => {
            btn.classList.remove('text-primary-600', 'dark:text-primary-400');
            if (btn.dataset.view === viewId) {
                btn.classList.add('text-primary-600', 'dark:text-primary-400');
            }
        });
    }

    function goBack() {
        if (AppState.navigationStack.length > 0) {
            const prevView = AppState.navigationStack.pop();
            navigateTo(prevView);
        } else {
            navigateTo('home');
        }
    }

    // =========================================================================
    // 4. Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ ÙˆØ§Ù„Ø«ÙŠÙ…Ø§Øª
    // =========================================================================

    function toggleDarkMode() {
        const isDark = document.documentElement.classList.toggle('dark');
        const toggleBtn = document.getElementById('theme-toggle');
        const circle = toggleBtn.querySelector('div');
        
        if (isDark) {
            circle.style.transform = 'translateX(1.75rem)';
            AppState.settings.mode = 'dark';
            localStorage.setItem('mode', 'dark');
        } else {
            circle.style.transform = 'translateX(0)';
            AppState.settings.mode = 'light';
            localStorage.setItem('mode', 'light');
        }
        
        // Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
        DB.save('settings', AppState.settings);
    }

    function applyTheme(themeKey, isDark) {
        // Ø¥Ø²Ø§Ù„Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø«ÙŠÙ…Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
        document.documentElement.classList.remove('theme-forest', 'theme-sunset', 'theme-ocean', 'theme-royal', 'theme-earth');
        
        // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø«ÙŠÙ… Ø§Ù„Ø¬Ø¯ÙŠØ¯
        if (themeKey !== 'default') {
            document.documentElement.classList.add(`theme-${themeKey}`);
        }
        
        // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ
        if (isDark) {
            document.documentElement.classList.add('dark');
            const toggleBtn = document.getElementById('theme-toggle');
            const circle = toggleBtn.querySelector('div');
            circle.style.transform = 'translateX(1.75rem)';
        } else {
            document.documentElement.classList.remove('dark');
        }
    }

    function selectTheme(themeKey) {
        // Ø¥Ø²Ø§Ù„Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø«ÙŠÙ…Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
        document.documentElement.classList.remove('theme-forest', 'theme-sunset', 'theme-ocean', 'theme-royal', 'theme-earth');
        
        // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø«ÙŠÙ… Ø§Ù„Ø¬Ø¯ÙŠØ¯
        if (themeKey !== 'default') {
            document.documentElement.classList.add(`theme-${themeKey}`);
        }
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ Ø­Ø³Ø¨ Ø§Ù„Ø«ÙŠÙ…
        let primaryColor = '';
        switch(themeKey) {
            case 'forest':
                primaryColor = '#10b981';
                break;
            case 'sunset':
                primaryColor = '#f97316';
                break;
            case 'ocean':
                primaryColor = '#06b6d4';
                break;
            case 'royal':
                primaryColor = '#8b5cf6';
                break;
            case 'earth':
                primaryColor = '#d97706';
                break;
            default:
                primaryColor = '#0ea5e9';
        }
        
        // Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
        AppState.settings.theme = themeKey;
        localStorage.setItem('theme', themeKey);
        DB.save('settings', AppState.settings);
        
        showToast(`ØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø«ÙŠÙ…: ${themeKey}`, 'success');
    }

    // =========================================================================
    // 5. Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© - Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª
    // =========================================================================

    function loadHomePosts() {
        loadAllPosts();
    }

    function loadAllPosts() {
        const container = document.getElementById('home-posts-list');
        if (!container) return;
        
        let filteredPosts = AppState.posts;
        
        if (AppState.currentPostSort === 'quotes') {
            filteredPosts = filteredPosts.filter(post => post.type === 'quote');
        } else if (AppState.currentPostSort === 'reviews') {
            filteredPosts = filteredPosts.filter(post => post.type === 'review');
        } else if (AppState.currentPostSort === 'notes') {
            filteredPosts = filteredPosts.filter(post => post.type === 'note');
        }
        
        // Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙØ±Ø²
        sortPosts(AppState.currentPostSort, filteredPosts);
        
        if (filteredPosts.length === 0) {
            container.innerHTML = `
                <div class="card text-center py-8 text-gray-500">
                    <i class="fa-solid fa-feather text-2xl mb-2"></i>
                    <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†Ø´ÙˆØ±Ø§Øª Ø¨Ø¹Ø¯</p>
                    <button onclick="showCreatePostModal()" class="btn-sm bg-primary-500 text-white mt-3">
                        Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø´ÙˆØ± Ø¬Ø¯ÙŠØ¯
                    </button>
                </div>
            `;
            return;
        }
        
        container.innerHTML = filteredPosts.map(post => renderPostCard(post, false)).join('');
    }

    function renderPostCard(post, isPinned = false) {
        const associatedBook = post.book_ids && post.book_ids.length > 0
            ? AppState.books.find(b => b.id === post.book_ids[0])
            : null;
        
        const typeInfo = POST_TYPES[post.type] || POST_TYPES.note;
        const typeColor = typeInfo.color;
        
        return `
            <div class="card animate-fade-in">
                <div class="flex items-start justify-between mb-3">
                    <div class="flex items-center gap-2">
                        <div class="w-8 h-8 rounded-lg bg-${typeColor}-100 dark:bg-${typeColor}-900/30 flex items-center justify-center">
                            <i class="fa-solid ${typeInfo.icon} text-${typeColor}-600 dark:text-${typeColor}-400"></i>
                        </div>
                        <div>
                            <div class="text-xs text-gray-500">
                                ${new Date(post.created_at).toLocaleDateString('ar-EG', {
                                    year: 'numeric',
                                    month: 'short',
                                    day: 'numeric'
                                })}
                            </div>
                            <div class="text-xs font-medium text-${typeColor}-600 dark:text-${typeColor}-400">
                                ${typeInfo.text}
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex items-center gap-1">
                        <button onclick="copyToClipboard('${post.content.replace(/'/g, "\\'")}')" class="icon-sm text-gray-400 hover:text-primary-600" title="Ù†Ø³Ø®">
                            <i class="fa-solid fa-copy"></i>
                        </button>
                    </div>
                </div>
                
                <p class="text-gray-800 dark:text-gray-200 mb-3 leading-relaxed">
                    ${post.content}
                </p>
                
                ${post.rating ? `
                    <div class="mb-3">
                        <div class="star-rating text-amber-500">
                            ${renderStars(post.rating)}
                        </div>
                    </div>
                ` : ''}
                
                ${associatedBook ? `
                    <div class="flex items-center gap-2 p-2 bg-gray-50 dark:bg-gray-700/50 rounded-lg mb-3">
                        <div class="w-8 h-8 rounded overflow-hidden">
                            <img src="${associatedBook.cover || 'https://images.unsplash.com/photo-1541963463532-d68292c34b19?ixlib=rb-4.0.3&auto=format&fit=crop&w=100&q=80'}" 
                                 alt="${associatedBook.title}" 
                                 class="w-full h-full object-cover">
                        </div>
                        <div class="flex-1">
                            <div class="text-sm font-medium text-gray-700 dark:text-gray-300">${associatedBook.title}</div>
                            <div class="text-xs text-gray-500">${associatedBook.author || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</div>
                        </div>
                    </div>
                ` : ''}
                
                ${post.tags && post.tags.length > 0 ? `
                    <div class="flex flex-wrap gap-1 mb-3">
                        ${post.tags.map(tag => `
                            <span class="tag bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 text-xs">
                                ${tag}
                            </span>
                        `).join('')}
                    </div>
                ` : ''}
                
                <div class="flex justify-end gap-2 pt-2 border-t border-gray-100 dark:border-gray-700">
                    <button onclick="editPost('${post.id}')" class="text-xs text-blue-500 hover:text-blue-700">
                        <i class="fa-solid fa-edit ml-1"></i>
                        ØªØ¹Ø¯ÙŠÙ„
                    </button>
                    <button onclick="deletePost('${post.id}')" class="text-xs text-red-500 hover:text-red-700">
                        <i class="fa-solid fa-trash ml-1"></i>
                        Ø­Ø°Ù
                    </button>
                </div>
            </div>
        `;
    }

    function renderStars(rating) {
        let html = '';
        for (let i = 1; i <= 5; i++) {
            if (i <= rating) {
                html += `<i class="fa-solid fa-star"></i>`;
            } else {
                html += `<i class="fa-regular fa-star"></i>`;
            }
        }
        return html;
    }

    function sortPosts(sortType, posts = AppState.posts) {
        AppState.currentPostSort = sortType;
        
        // ØªØ­Ø¯ÙŠØ« Ø£Ø²Ø±Ø§Ø± Ø§Ù„ÙØ±Ø²
        document.querySelectorAll('.sort-btn').forEach(btn => {
            if (btn.textContent.includes(sortType) || (sortType === 'newest' && btn.textContent.includes('Ø§Ù„Ø£Ø­Ø¯Ø«'))) {
                btn.classList.add('bg-primary-100', 'dark:bg-primary-900/30', 'text-primary-700', 'dark:text-primary-300');
                btn.classList.remove('bg-gray-100', 'dark:bg-gray-800', 'text-gray-700', 'dark:text-gray-300');
            } else {
                btn.classList.remove('bg-primary-100', 'dark:bg-primary-900/30', 'text-primary-700', 'dark:text-primary-300');
                btn.classList.add('bg-gray-100', 'dark:bg-gray-800', 'text-gray-700', 'dark:text-gray-300');
            }
        });
        
        let sortedPosts = [...posts];
        
        switch(sortType) {
            case 'newest':
                sortedPosts.sort((a, b) => b.created_at - a.created_at);
                break;
            case 'oldest':
                sortedPosts.sort((a, b) => a.created_at - b.created_at);
                break;
            case 'quotes':
                sortedPosts = sortedPosts.filter(p => p.type === 'quote');
                sortedPosts.sort((a, b) => b.created_at - a.created_at);
                break;
            case 'reviews':
                sortedPosts = sortedPosts.filter(p => p.type === 'review');
                sortedPosts.sort((a, b) => b.created_at - a.created_at);
                break;
            case 'notes':
                sortedPosts = sortedPosts.filter(p => p.type === 'note');
                sortedPosts.sort((a, b) => b.created_at - a.created_at);
                break;
        }
        
        // Ø¥Ø°Ø§ ÙƒÙ†Ø§ ÙÙŠ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©ØŒ Ù†Ø­Ø¯Ù‘Ø« Ø§Ù„Ø¹Ø±Ø¶
        if (AppState.currentView === 'home') {
            loadAllPosts();
        }
    }

    // =========================================================================
    // 6. ÙƒØªØ§Ø¨Ø§ØªÙŠ
    // =========================================================================

    function openWritingShelf(type) {
        const shelf = WRITING_SHELVES[type];
        if (!shelf) return;
        
        AppState.currentWritingShelf = type;
        
        // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø±ÙÙˆÙ ÙˆØ¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…Ø­ØªÙˆÙ‰
        document.querySelector('#view-writings > div:nth-child(2)').classList.add('hidden');
        document.getElementById('writings-shelf-view').classList.remove('hidden');
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ÙÙ‚Ø·
        document.getElementById('writing-shelf-title').textContent = shelf.title;
        
        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª
        loadWritingShelfPosts(type);
    }

    function loadWritingShelfPosts(type) {
        const container = document.getElementById('writing-shelf-posts');
        if (!container) return;
        
        let filteredPosts = [];
        
        switch(type) {
            case 'quotes':
                filteredPosts = AppState.posts.filter(p => p.type === 'quote');
                break;
            case 'reviews':
                filteredPosts = AppState.posts.filter(p => p.type === 'review');
                break;
            case 'notes':
                filteredPosts = AppState.posts.filter(p => p.type === 'note');
                break;
        }
        
        if (filteredPosts.length === 0) {
            container.innerHTML = `
                <div class="card text-center py-8 text-gray-500">
                    <i class="fa-solid fa-feather text-2xl mb-2"></i>
                    <p>Ù„Ø§ ØªÙˆØ¬Ø¯ ${type === 'quotes' ? 'Ø§Ù‚ØªØ¨Ø§Ø³Ø§Øª' : type === 'reviews' ? 'Ù…Ø±Ø§Ø¬Ø¹Ø§Øª' : 'Ù…Ù„Ø§Ø­Ø¸Ø§Øª'} Ø¨Ø¹Ø¯</p>
                    <button onclick="showCreatePostModal()" class="btn-sm bg-primary-500 text-white mt-3">
                        Ø¥Ø¶Ø§ÙØ© Ø¬Ø¯ÙŠØ¯
                    </button>
                </div>
            `;
            return;
        }
        
        filteredPosts.sort((a, b) => b.created_at - a.created_at);
        container.innerHTML = filteredPosts.map(post => renderPostCard(post, false)).join('');
    }

    function backToWritings() {
        document.getElementById('writings-shelf-view').classList.add('hidden');
        document.querySelector('#view-writings > div:nth-child(2)').classList.remove('hidden');
        AppState.currentWritingShelf = null;
    }

    // =========================================================================
    // 7. Ø§Ù„Ù…ÙƒØªØ¨Ø©
    // =========================================================================

    function loadBooksView() {
        const gridView = document.getElementById('books-grid-view');
        const listView = document.getElementById('books-list-view');
        
        if (AppState.booksViewMode === 'grid') {
            gridView.classList.remove('hidden');
            listView.classList.add('hidden');
            renderBooksGrid();
        } else {
            gridView.classList.add('hidden');
            listView.classList.remove('hidden');
            renderBooksList();
        }
    }

    function renderBooksGrid() {
        const container = document.getElementById('books-grid-view');
        if (!container) return;
        
        let booksToDisplay = [...AppState.books];
        
        // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙØ±Ø²
        const sortSelect = document.getElementById('books-sort-select');
        if (sortSelect) {
            booksToDisplay = sortBookList(booksToDisplay, sortSelect.value);
        }
        
        // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¨Ø­Ø«
        const searchInput = document.getElementById('books-search');
        if (searchInput && searchInput.value.trim() !== '') {
            const query = searchInput.value.trim().toLowerCase();
            booksToDisplay = booksToDisplay.filter(book => 
                book.title.toLowerCase().includes(query) ||
                (book.author && book.author.toLowerCase().includes(query))
            );
        }
        
        if (booksToDisplay.length === 0) {
            container.innerHTML = `
                <div class="col-span-full card text-center py-8 text-gray-500">
                    <i class="fa-solid fa-book text-2xl mb-2"></i>
                    <p>Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒØªØ¨</p>
                    <button onclick="showCreateBookModal()" class="btn-sm bg-primary-500 text-white mt-3">
                        Ø¥Ø¶Ø§ÙØ© ÙƒØªØ§Ø¨ Ø¬Ø¯ÙŠØ¯
                    </button>
                </div>
            `;
            return;
        }
        
        container.innerHTML = booksToDisplay.map(book => `
            <div class="cursor-pointer animate-fade-in" onclick="navigateTo('book-details', {id: '${book.id}'})">
                <div class="card hover:shadow-medium">
                    <div class="aspect-[2/3] rounded-lg overflow-hidden mb-3">
                        <img src="${book.cover || 'https://images.unsplash.com/photo-1541963463532-d68292c34b19?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&q=80'}" 
                             alt="${book.title}" 
                             class="w-full h-full object-cover book-cover">
                    </div>
                    
                    <h3 class="font-medium text-sm mb-1 truncate">${book.title}</h3>
                    <p class="text-xs text-gray-500 truncate">${book.author || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</p>
                    
                    ${book.rating ? `
                        <div class="mt-2">
                            <div class="star-rating text-amber-500 text-xs">
                                ${renderStars(book.rating)}
                            </div>
                        </div>
                    ` : ''}
                    
                    <div class="mt-2 flex items-center justify-between">
                        <span class="text-xs text-gray-500">
                            ${book.year || ''}
                        </span>
                        <span class="text-xs px-2 py-0.5 rounded-full bg-${READING_STATUS[book.status]?.color || 'gray'}-100 dark:bg-${READING_STATUS[book.status]?.color || 'gray'}-900/30 text-${READING_STATUS[book.status]?.color || 'gray'}-700 dark:text-${READING_STATUS[book.status]?.color || 'gray'}-300">
                            ${READING_STATUS[book.status]?.text || book.status}
                        </span>
                    </div>
                </div>
            </div>
        `).join('');
    }

    function renderBooksList() {
        const container = document.getElementById('books-list-view');
        if (!container) return;
        
        let booksToDisplay = [...AppState.books];
        
        // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙØ±Ø²
        const sortSelect = document.getElementById('books-sort-select');
        if (sortSelect) {
            booksToDisplay = sortBookList(booksToDisplay, sortSelect.value);
        }
        
        // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¨Ø­Ø«
        const searchInput = document.getElementById('books-search');
        if (searchInput && searchInput.value.trim() !== '') {
            const query = searchInput.value.trim().toLowerCase();
            booksToDisplay = booksToDisplay.filter(book => 
                book.title.toLowerCase().includes(query) ||
                (book.author && book.author.toLowerCase().includes(query))
            );
        }
        
        if (booksToDisplay.length === 0) {
            container.innerHTML = `
                <div class="card text-center py-8 text-gray-500">
                    <i class="fa-solid fa-book text-2xl mb-2"></i>
                    <p>Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒØªØ¨</p>
                    <button onclick="showCreateBookModal()" class="btn-sm bg-primary-500 text-white mt-3">
                        Ø¥Ø¶Ø§ÙØ© ÙƒØªØ§Ø¨ Ø¬Ø¯ÙŠØ¯
                    </button>
                </div>
            `;
            return;
        }
        
        container.innerHTML = booksToDisplay.map(book => `
            <div class="card cursor-pointer hover:shadow-medium" onclick="navigateTo('book-details', {id: '${book.id}'})">
                <div class="flex items-center gap-3">
                    <div class="w-12 h-16 rounded overflow-hidden flex-shrink-0">
                        <img src="${book.cover || 'https://images.unsplash.com/photo-1541963463532-d68292c34b19?ixlib=rb-4.0.3&auto=format&fit=crop&w=100&q=80'}" 
                             alt="${book.title}" 
                             class="w-full h-full object-cover">
                    </div>
                    
                    <div class="flex-1 min-w-0">
                        <h3 class="font-medium text-sm mb-1 truncate">${book.title}</h3>
                        <p class="text-xs text-gray-500 truncate">${book.author || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</p>
                        
                        <div class="flex items-center gap-2 mt-1">
                            ${book.rating ? `
                                <div class="star-rating text-amber-500 text-xs">
                                    ${renderStars(book.rating)}
                                </div>
                            ` : ''}
                            
                            <span class="text-xs text-gray-500">
                                ${book.year || ''}
                            </span>
                        </div>
                    </div>
                    
                    <div class="text-right">
                        <span class="text-xs px-2 py-0.5 rounded-full bg-${READING_STATUS[book.status]?.color || 'gray'}-100 dark:bg-${READING_STATUS[book.status]?.color || 'gray'}-900/30 text-${READING_STATUS[book.status]?.color || 'gray'}-700 dark:text-${READING_STATUS[book.status]?.color || 'gray'}-300">
                            ${READING_STATUS[book.status]?.text || book.status}
                        </span>
                    </div>
                </div>
            </div>
        `).join('');
    }

    function sortBooks() {
        loadBooksView();
    }

    function sortBookList(books, sortType) {
        let sortedBooks = [...books];
        
        switch(sortType) {
            case 'title_asc':
                sortedBooks.sort((a, b) => a.title.localeCompare(b.title, 'ar'));
                break;
            case 'title_desc':
                sortedBooks.sort((a, b) => b.title.localeCompare(a.title, 'ar'));
                break;
            case 'newest':
                sortedBooks.sort((a, b) => b.added_date - a.added_date);
                break;
            case 'oldest':
                sortedBooks.sort((a, b) => a.added_date - b.added_date);
                break;
            case 'author':
                sortedBooks.sort((a, b) => (a.author || '').localeCompare(b.author || '', 'ar'));
                break;
            case 'year_desc':
                sortedBooks.sort((a, b) => (b.year || 0) - (a.year || 0));
                break;
            case 'year_asc':
                sortedBooks.sort((a, b) => (a.year || 0) - (b.year || 0));
                break;
            case 'rating_desc':
                sortedBooks.sort((a, b) => (b.rating || 0) - (a.rating || 0));
                break;
            case 'pages_asc':
                sortedBooks.sort((a, b) => (a.pages || 0) - (b.pages || 0));
                break;
            case 'pages_desc':
                sortedBooks.sort((a, b) => (b.pages || 0) - (a.pages || 0));
                break;
            case 'status':
                const statusOrder = { 'reading': 1, 'not_started': 2, 'paused': 3, 'finished': 4 };
                sortedBooks.sort((a, b) => (statusOrder[a.status] || 5) - (statusOrder[b.status] || 5));
                break;
        }
        
        return sortedBooks;
    }

    function searchBooks() {
        loadBooksView();
    }

    function toggleBooksView() {
        AppState.booksViewMode = AppState.booksViewMode === 'grid' ? 'list' : 'grid';
        
        const icon = document.getElementById('books-view-icon');
        if (AppState.booksViewMode === 'grid') {
            icon.classList.remove('fa-list');
            icon.classList.add('fa-grip');
        } else {
            icon.classList.remove('fa-grip');
            icon.classList.add('fa-list');
        }
        
        loadBooksView();
    }

    function filterByStatus(status) {
        const searchInput = document.getElementById('books-search');
        searchInput.value = '';
        
        const sortSelect = document.getElementById('books-sort-select');
        sortSelect.value = 'newest';
        
        AppState.books = AppState.books.filter(book => book.status === status);
        loadBooksView();
        
        showToast(`Ø¹Ø±Ø¶ Ø§Ù„ÙƒØªØ¨ Ø¨Ø­Ø§Ù„Ø©: ${READING_STATUS[status]?.text || status}`);
    }

    function clearFilters() {
        loadData().then(() => {
            const searchInput = document.getElementById('books-search');
            searchInput.value = '';
            loadBooksView();
            showToast('ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙÙ„Ø§ØªØ±');
        });
    }

    // =========================================================================
    // 8. Ø§Ù„Ø±ÙÙˆÙ
    // =========================================================================

    function renderShelvesGrid() {
        const grid = document.getElementById('shelves-landing').querySelector('.grid');
        if (!grid) return;
        
        grid.innerHTML = SHELVES.map(shelf => {
            const count = AppState.books.filter(book => 
                Array.isArray(book.statuses) && book.statuses.includes(shelf.key)
            ).length;
            
            return `
                <div class="card cursor-pointer hover:shadow-medium" onclick="openShelf('${shelf.key}')">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 rounded-lg ${shelf.color} flex items-center justify-center">
                            <i class="fa-solid ${shelf.icon} text-gray-800"></i>
                        </div>
                        <div class="flex-1">
                            <h3 class="font-medium text-sm mb-1">${shelf.title}</h3>
                            <p class="text-xs text-gray-500">${count} ÙƒØªØ§Ø¨</p>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }

    function openShelf(shelfKey) {
        const shelf = SHELVES.find(s => s.key === shelfKey);
        if (!shelf) return;
        
        AppState.currentShelf = shelfKey;
        
        document.getElementById('shelves-landing').classList.add('hidden');
        document.getElementById('shelves-shelf-view').classList.remove('hidden');
        
        document.getElementById('shelf-title').textContent = shelf.title;
        
        sortShelfBooks();
    }

    function sortShelfBooks() {
        const sortSelect = document.getElementById('shelf-sort-select');
        const sortType = sortSelect ? sortSelect.value : 'title_asc';
        
        const booksInShelf = AppState.books.filter(book => 
            Array.isArray(book.statuses) && book.statuses.includes(AppState.currentShelf)
        );
        
        const sortedBooks = sortBookList(booksInShelf, sortType);
        renderShelfBooks(sortedBooks);
    }

    function renderShelfBooks(books) {
        const container = document.getElementById('shelf-books-grid');
        if (!container) return;
        
        if (books.length === 0) {
             container.innerHTML = `
                <div class="col-span-full card text-center py-8 text-gray-500">
                    <i class="fa-solid fa-inbox text-2xl mb-2"></i>
                    <p>Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒØªØ¨ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø±Ù</p>
                    <p class="text-sm text-gray-400 mt-1">Ø£Ø¶Ù ÙƒØªØ¨Ø§Ù‹ Ø¥Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø±Ù Ù…Ù† Ø®Ù„Ø§Ù„ ØµÙØ­Ø© Ø§Ù„Ù…ÙƒØªØ¨Ø©</p>
                </div>
             `;
             return;
        }

        container.innerHTML = books.map(book => `
            <div class="cursor-pointer animate-fade-in" onclick="navigateTo('book-details', {id: '${book.id}'})">
                <div class="card hover:shadow-medium">
                    <div class="aspect-[2/3] rounded-lg overflow-hidden mb-3">
                        <img src="${book.cover || 'https://images.unsplash.com/photo-1541963463532-d68292c34b19?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&q=80'}" 
                             alt="${book.title}" 
                             class="w-full h-full object-cover">
                    </div>
                    
                    <h3 class="font-medium text-sm mb-1 truncate">${book.title}</h3>
                    <p class="text-xs text-gray-500 truncate">${book.author || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</p>
                </div>
            </div>
        `).join('');
    }

    function backToShelves() {
        document.getElementById('shelves-landing').classList.remove('hidden');
        document.getElementById('shelves-shelf-view').classList.add('hidden');
        AppState.currentShelf = null;
    }

    // =========================================================================
    // 9. Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª
    // =========================================================================

    function showCreatePostModal(postId = null, bookId = null) {
        AppState.editingPostId = postId;
        
        const modal = document.getElementById('post-modal');
        const titleElement = document.getElementById('post-modal-title');
        const contentInput = document.getElementById('post-content');
        const ratingField = document.getElementById('post-rating-field');
        const bookSelect = document.getElementById('post-book-select');
        const tagsInput = document.getElementById('post-tags');
        const pinnedCheckbox = document.getElementById('post-pinned');
        
        // ØªØ¹Ø¨Ø¦Ø© Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„ÙƒØªØ¨
        bookSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± ÙƒØªØ§Ø¨Ø§Ù‹...</option>';
        AppState.books.forEach(book => {
            bookSelect.innerHTML += `<option value="${book.id}">${book.title}</option>`;
        });

        // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ†
        contentInput.value = '';
        tagsInput.value = '';
        setPostRating(5);
        ratingField.classList.add('hidden');
        pinnedCheckbox.checked = false;
        
        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù†ÙˆØ¹
        document.querySelectorAll('#post-modal button[data-type]').forEach(btn => {
            btn.classList.remove('bg-blue-100', 'dark:bg-blue-900/30', 'text-blue-700', 'dark:text-blue-300',
                               'bg-amber-100', 'dark:bg-amber-900/30', 'text-amber-700', 'dark:text-amber-300');
            btn.classList.add('bg-gray-100', 'dark:bg-gray-800', 'text-gray-700', 'dark:text-gray-300');
        });
        
        // ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
        document.querySelector('#post-modal button[data-type="note"]').classList.remove('bg-gray-100', 'dark:bg-gray-800', 'text-gray-700', 'dark:text-gray-300');
        document.querySelector('#post-modal button[data-type="note"]').classList.add('bg-primary-100', 'dark:bg-primary-900/30', 'text-primary-700', 'dark:text-primary-300');

        if (postId) {
            titleElement.textContent = 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù†Ø´ÙˆØ±';
            const post = AppState.posts.find(p => p.id === postId);
            if (post) {
                contentInput.value = post.content;
                tagsInput.value = (post.tags || []).join(', ');
                pinnedCheckbox.checked = post.pinned || false;
                
                // ØªØ¹ÙŠÙŠÙ† Ù†ÙˆØ¹ Ø§Ù„Ù…Ù†Ø´ÙˆØ±
                document.querySelectorAll('#post-modal button[data-type]').forEach(btn => {
                    if (btn.dataset.type === post.type) {
                        btn.click();
                    }
                });
                
                if (post.type === 'review') {
                    ratingField.classList.remove('hidden');
                    setPostRating(post.rating || 5);
                }
                
                if (post.book_ids && post.book_ids.length > 0) {
                    bookSelect.value = post.book_ids[0];
                }
            }
        } else {
            titleElement.textContent = 'Ù…Ù†Ø´ÙˆØ± Ø¬Ø¯ÙŠØ¯';
            if (bookId) {
                bookSelect.value = bookId;
            }
        }

        modal.classList.remove('hidden');
    }

    function hideCreatePostModal() {
        const modal = document.getElementById('post-modal');
        modal.classList.add('hidden');
        AppState.editingPostId = null;
    }

    function selectPostType(type) {
        // ØªØ­Ø¯ÙŠØ« Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù†ÙˆØ¹
        document.querySelectorAll('#post-modal button[data-type]').forEach(btn => {
            btn.classList.remove('bg-blue-100', 'dark:bg-blue-900/30', 'text-blue-700', 'dark:text-blue-300',
                               'bg-amber-100', 'dark:bg-amber-900/30', 'text-amber-700', 'dark:text-amber-300',
                               'bg-emerald-100', 'dark:bg-emerald-900/30', 'text-emerald-700', 'dark:text-emerald-300',
                               'bg-purple-100', 'dark:bg-purple-900/30', 'text-purple-700', 'dark:text-purple-300');
            btn.classList.add('bg-gray-100', 'dark:bg-gray-800', 'text-gray-700', 'dark:text-gray-300');
        });
        
        const selectedBtn = document.querySelector(`#post-modal button[data-type="${type}"]`);
        selectedBtn.classList.remove('bg-gray-100', 'dark:bg-gray-800', 'text-gray-700', 'dark:text-gray-300');
        
        // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ù…Ù†Ø§Ø³Ø¨ Ù„Ù„Ù†ÙˆØ¹
        const typeColors = {
            'quote': 'bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300',
            'note': 'bg-emerald-100 dark:bg-emerald-900/30 text-emerald-700 dark:text-emerald-300',
            'review': 'bg-amber-100 dark:bg-amber-900/30 text-amber-700 dark:text-amber-300',
            'thought': 'bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-300'
        };
        
        selectedBtn.classList.add(...typeColors[type].split(' '));
        
        // Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…
        const ratingField = document.getElementById('post-rating-field');
        if (type === 'review') {
            ratingField.classList.remove('hidden');
        } else {
            ratingField.classList.add('hidden');
        }
    }

    function setPostRating(rating) {
        const stars = document.querySelectorAll('#rating-stars i');
        const input = document.getElementById('post-rating-input');
        
        stars.forEach((star, index) => {
            if (index < rating) {
                star.classList.remove('fa-regular');
                star.classList.add('fa-solid');
            } else {
                star.classList.remove('fa-solid');
                star.classList.add('fa-regular');
            }
        });
        
        input.value = rating;
    }

    async function savePost() {
        try {
            const content = document.getElementById('post-content').value.trim();
            const tagsInput = document.getElementById('post-tags').value.trim();
            const bookSelect = document.getElementById('post-book-select');
            const pinned = document.getElementById('post-pinned').checked;
            
            if (!content) {
                showToast('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ù†Ø´ÙˆØ±', 'error');
                return;
            }
            
            // ØªØ­Ø¯ÙŠØ¯ Ù†ÙˆØ¹ Ø§Ù„Ù…Ù†Ø´ÙˆØ± Ù…Ù† Ø§Ù„Ø²Ø± Ø§Ù„Ù†Ø´Ø·
            const activeTypeBtn = document.querySelector('#post-modal button[data-type]');
            const type = activeTypeBtn?.dataset.type || 'note';
            
            let rating = null;
            if (type === 'review') {
                rating = parseInt(document.getElementById('post-rating-input').value) || 5;
            }
            
            const tags = tagsInput ? tagsInput.split(',').map(tag => tag.trim()).filter(t => t) : [];
            
            const bookId = bookSelect.value || null;
            const book_ids = bookId ? [bookId] : [];
            
            const postData = {
                type,
                content,
                book_ids,
                tags,
                rating,
                pinned,
                edited_at: Date.now()
            };
            
            if (AppState.editingPostId) {
                await DB.update('posts', AppState.editingPostId, postData);
                showToast('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù†Ø´ÙˆØ±', 'success');
            } else {
                postData.created_at = Date.now();
                await DB.save('posts', postData);
                showToast('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ù†Ø´ÙˆØ±', 'success');
            }
            
            await loadData();
            hideCreatePostModal();
            loadHomePosts();
            
            // Ø¥Ø°Ø§ ÙƒÙ†Ø§ ÙÙŠ Ø±Ù ÙƒØªØ§Ø¨Ø§ØªÙŠØŒ Ù†Ø­Ø¯Ù‘Ø«Ù‡
            if (AppState.currentWritingShelf) {
                loadWritingShelfPosts(AppState.currentWritingShelf);
            }
        } catch (error) {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ù…Ù†Ø´ÙˆØ±:', error);
            showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ù…Ù†Ø´ÙˆØ±', 'error');
        }
    }

    function editPost(postId) {
        showCreatePostModal(postId);
    }

    function deletePost(postId) {
        if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†Ø´ÙˆØ±ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.')) {
            DB.delete('posts', postId).then(() => {
                loadData().then(() => {
                    loadHomePosts();
                    if (AppState.currentWritingShelf) {
                        loadWritingShelfPosts(AppState.currentWritingShelf);
                    }
                    showToast('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù†Ø´ÙˆØ±', 'success');
                });
            }).catch(error => {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ù…Ù†Ø´ÙˆØ±:', error);
                showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ù…Ù†Ø´ÙˆØ±', 'error');
            });
        }
    }

    // =========================================================================
    // 10. Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙƒØªØ¨
    // =========================================================================

    function showCreateBookModal(bookId = null) {
        AppState.editingBookId = bookId;
        
        const modal = document.getElementById('book-modal');
        const titleElement = document.getElementById('book-modal-title');
        const shelvesSelect = document.getElementById('book-shelves-select');
        
        // ØªØ¹Ø¨Ø¦Ø© Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø±ÙÙˆÙ
        shelvesSelect.innerHTML = '';
        SHELVES.forEach(shelf => {
            const option = document.createElement('option');
            option.value = shelf.key;
            option.textContent = shelf.title;
            shelvesSelect.appendChild(option);
        });
        
        // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ†
        document.getElementById('book-form').reset();
        document.getElementById('book-cover-preview').innerHTML = `
            <i class="fa-solid fa-image text-4xl text-gray-400 dark:text-gray-500 mb-3"></i>
            <p class="text-sm text-gray-600 dark:text-gray-400">Ø§Ù†Ù‚Ø± Ù„ØªØ­Ù…ÙŠÙ„ ØµÙˆØ±Ø©</p>
        `;
        setBookRating(0);
        
        if (bookId) {
            titleElement.textContent = 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙƒØªØ§Ø¨';
            const book = AppState.books.find(b => b.id === bookId);
            if (book) {
                // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø­Ù‚ÙˆÙ„
                document.getElementById('book-title').value = book.title || '';
                document.getElementById('book-author').value = book.author || '';
                document.getElementById('book-year').value = book.year || '';
                document.getElementById('book-publisher').value = book.publisher || '';
                document.getElementById('book-pages').value = book.pages || '';
                document.getElementById('book-status').value = book.status || 'not_started';
                document.getElementById('book-progress').value = book.progress || '';
                document.getElementById('book-start-date').value = book.start_date || '';
                document.getElementById('book-finish-date').value = book.finish_date || '';
                document.getElementById('book-pause-date').value = book.pause_date || '';
                document.getElementById('book-category').value = book.category || '';
                document.getElementById('book-language').value = book.language || 'arabic';
                document.getElementById('book-series').value = book.series || '';
                document.getElementById('book-volume').value = book.volume || '';
                document.getElementById('book-translator').value = book.translator || '';
                document.getElementById('book-edition').value = book.edition || '';
                document.getElementById('book-summary').value = book.summary || '';
                document.getElementById('book-author-bio').value = book.author_bio || '';
                document.getElementById('book-rating-text').value = book.rating_text || '';
                document.getElementById('book-notes').value = book.notes || '';
                document.getElementById('book-location').value = book.location || 'physical_home';
                
                setBookRating(book.rating || 0);
                
                if (book.cover) {
                    document.getElementById('book-cover-preview').innerHTML = `
                        <img src="${book.cover}" alt="ØºÙ„Ø§Ù Ø§Ù„ÙƒØªØ§Ø¨" class="w-full h-full object-cover">
                    `;
                }
                
                if (Array.isArray(book.statuses)) {
                    Array.from(shelvesSelect.options).forEach(opt => {
                        if (book.statuses.includes(opt.value)) {
                            opt.selected = true;
                        }
                    });
                }
            }
        } else {
            titleElement.textContent = 'Ø¥Ø¶Ø§ÙØ© ÙƒØªØ§Ø¨ Ø¬Ø¯ÙŠØ¯';
        }
        
        modal.classList.remove('hidden');
    }

    function hideCreateBookModal() {
        const modal = document.getElementById('book-modal');
        modal.classList.add('hidden');
        AppState.editingBookId = null;
    }

    function setBookRating(rating) {
        const stars = document.querySelectorAll('#book-rating-stars i');
        const input = document.getElementById('book-rating');
        
        stars.forEach((star, index) => {
            if (index < rating) {
                star.classList.remove('fa-regular');
                star.classList.add('fa-solid');
            } else {
                star.classList.remove('fa-solid');
                star.classList.add('fa-regular');
            }
        });
        
        input.value = rating;
    }

    async function saveBook() {
        try {
            const title = document.getElementById('book-title').value.trim();
            const author = document.getElementById('book-author').value.trim();
            
            if (!title || !author) {
                showToast('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ÙˆØ§Ù„Ù…Ø¤Ù„Ù', 'error');
                return;
            }
            
            const coverInput = document.getElementById('book-cover-input');
            let cover = '';
            if (coverInput.files && coverInput.files[0]) {
                const file = coverInput.files[0];
                cover = await readFileAsDataURL(file);
            } else if (AppState.editingBookId) {
                const book = AppState.books.find(b => b.id === AppState.editingBookId);
                cover = book ? book.cover : '';
            }
            
            const shelvesSelect = document.getElementById('book-shelves-select');
            const statuses = Array.from(shelvesSelect.selectedOptions).map(opt => opt.value);
            
            const bookData = {
                title,
                author,
                cover,
                year: document.getElementById('book-year').value || null,
                publisher: document.getElementById('book-publisher').value || null,
                pages: parseInt(document.getElementById('book-pages').value) || null,
                status: document.getElementById('book-status').value,
                progress: parseInt(document.getElementById('book-progress').value) || 0,
                start_date: document.getElementById('book-start-date').value || null,
                finish_date: document.getElementById('book-finish-date').value || null,
                pause_date: document.getElementById('book-pause-date').value || null,
                category: document.getElementById('book-category').value || null,
                language: document.getElementById('book-language').value,
                series: document.getElementById('book-series').value || null,
                volume: parseInt(document.getElementById('book-volume').value) || null,
                translator: document.getElementById('book-translator').value || null,
                edition: parseInt(document.getElementById('book-edition').value) || null,
                summary: document.getElementById('book-summary').value || null,
                author_bio: document.getElementById('book-author-bio').value || null,
                rating: parseInt(document.getElementById('book-rating').value) || 0,
                rating_text: document.getElementById('book-rating-text').value || null,
                notes: document.getElementById('book-notes').value || null,
                location: document.getElementById('book-location').value,
                statuses,
                updated_at: Date.now()
            };
            
            if (AppState.editingBookId) {
                await DB.update('books', AppState.editingBookId, bookData);
                showToast('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙƒØªØ§Ø¨', 'success');
            } else {
                bookData.added_date = Date.now();
                await DB.save('books', bookData);
                showToast('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙƒØªØ§Ø¨', 'success');
            }
            
            await loadData();
            hideCreateBookModal();
            loadBooksView();
            renderShelvesGrid();
        } catch (error) {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„ÙƒØªØ§Ø¨:', error);
            showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„ÙƒØªØ§Ø¨', 'error');
        }
    }

    function readFileAsDataURL(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => resolve(e.target.result);
            reader.onerror = (e) => reject(e);
            reader.readAsDataURL(file);
        });
    }

    function editBook(bookId) {
        showCreateBookModal(bookId);
    }

    function deleteBook(bookId) {
        if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ÙƒØªØ§Ø¨ØŸ Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡ Ø£ÙŠØ¶Ø§Ù‹.')) {
            DB.delete('books', bookId).then(async () => {
                // Ø­Ø°Ù Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©
                const postsToDelete = AppState.posts.filter(p => p.book_ids && p.book_ids.includes(bookId));
                for (const post of postsToDelete) {
                    await DB.delete('posts', post.id);
                }
                
                await loadData();
                loadBooksView();
                renderShelvesGrid();
                showToast('ØªÙ… Ø­Ø°Ù Ø§Ù„ÙƒØªØ§Ø¨ ÙˆØ§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡', 'success');
            }).catch(error => {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„ÙƒØªØ§Ø¨:', error);
                showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„ÙƒØªØ§Ø¨', 'error');
            });
        }
    }

    // =========================================================================
    // 11. ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙƒØªØ§Ø¨
    // =========================================================================

    function loadBookDetails(bookId) {
        const book = AppState.books.find(b => b.id === bookId);
        if (!book) {
            showToast('Ø§Ù„ÙƒØªØ§Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯', 'error');
            navigateTo('books');
            return;
        }
        
        const relatedPosts = AppState.posts.filter(post => 
            post.book_ids && post.book_ids.includes(bookId)
        );
        
        const quotes = relatedPosts.filter(p => p.type === 'quote');
        const reviews = relatedPosts.filter(p => p.type === 'review');
        const notes = relatedPosts.filter(p => p.type === 'note');
        const thoughts = relatedPosts.filter(p => p.type === 'thought');
        
        const container = document.getElementById('view-book-details');
        if (!container) return;
        
        container.innerHTML = `
            <div class="space-y-4">
                <!-- Ø²Ø± Ø§Ù„Ø¹ÙˆØ¯Ø© -->
                <div class="flex items-center gap-2 mb-4">
                    <button onclick="navigateTo('books')" class="icon-sm text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-700">
                        <i class="fa-solid fa-arrow-right"></i>
                    </button>
                    <h2 class="text-xl font-semibold text-gray-900 dark:text-gray-100">${book.title}</h2>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                    <!-- Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø£ÙŠØ³Ø±: Ø§Ù„ØºÙ„Ø§Ù ÙˆØ§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø³Ø±ÙŠØ¹Ø© -->
                    <div class="lg:col-span-1">
                        <div class="card">
                            <div class="aspect-[2/3] rounded-lg overflow-hidden mb-4">
                                <img src="${book.cover || 'https://images.unsplash.com/photo-1541963463532-d68292c34b19?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&q=80'}" 
                                     alt="${book.title}" 
                                     class="w-full h-full object-cover">
                            </div>
                            
                            <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø³Ø±ÙŠØ¹Ø© -->
                            <div class="space-y-3">
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-gray-500">Ø§Ù„Ù…Ø¤Ù„Ù</span>
                                    <span class="font-medium">${book.author || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</span>
                                </div>
                                
                                ${book.year ? `
                                    <div class="flex justify-between items-center">
                                        <span class="text-sm text-gray-500">Ø³Ù†Ø© Ø§Ù„Ù†Ø´Ø±</span>
                                        <span>${book.year}</span>
                                    </div>
                                ` : ''}
                                
                                ${book.pages ? `
                                    <div class="flex justify-between items-center">
                                        <span class="text-sm text-gray-500">Ø§Ù„ØµÙØ­Ø§Øª</span>
                                        <span>${book.pages}</span>
                                    </div>
                                ` : ''}
                                
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-gray-500">Ø­Ø§Ù„Ø© Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©</span>
                                    <span class="px-2 py-0.5 rounded-full bg-${READING_STATUS[book.status]?.color || 'gray'}-100 dark:bg-${READING_STATUS[book.status]?.color || 'gray'}-900/30 text-${READING_STATUS[book.status]?.color || 'gray'}-700 dark:text-${READING_STATUS[book.status]?.color || 'gray'}-300 text-xs">
                                        ${READING_STATUS[book.status]?.text || book.status}
                                    </span>
                                </div>
                                
                                ${book.location ? `
                                    <div class="flex justify-between items-center">
                                        <span class="text-sm text-gray-500">Ù…ÙƒØ§Ù† Ø§Ù„ÙƒØªØ§Ø¨</span>
                                        <span class="flex items-center gap-1">
                                            <i class="fa-solid ${BOOK_LOCATIONS[book.location]?.icon || 'fa-question'}"></i>
                                            ${BOOK_LOCATIONS[book.location]?.text || book.location}
                                        </span>
                                    </div>
                                ` : ''}
                                
                                <!-- Ø§Ù„ØªÙ‚ÙŠÙŠÙ… -->
                                ${book.rating ? `
                                    <div class="pt-3 border-t border-gray-100 dark:border-gray-700">
                                        <div class="flex justify-between items-center mb-2">
                                            <span class="text-sm text-gray-500">ØªÙ‚ÙŠÙŠÙ…Ùƒ</span>
                                            <div class="star-rating text-amber-500">
                                                ${renderStars(book.rating)}
                                            </div>
                                        </div>
                                        ${book.rating_text ? `
                                            <p class="text-sm text-gray-600 dark:text-gray-400 italic">"${book.rating_text}"</p>
                                        ` : ''}
                                    </div>
                                ` : ''}
                                
                                <!-- Ø§Ù„ØªÙ‚Ø¯Ù… -->
                                ${book.progress && book.pages ? `
                                    <div class="pt-3 border-t border-gray-100 dark:border-gray-700">
                                        <div class="flex justify-between text-sm text-gray-500 mb-1">
                                            <span>Ø§Ù„ØªÙ‚Ø¯Ù…</span>
                                            <span>${Math.round((book.progress / book.pages) * 100)}%</span>
                                        </div>
                                        <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                                            <div class="bg-primary-500 h-2 rounded-full" style="width: ${(book.progress / book.pages) * 100}%"></div>
                                        </div>
                                        <p class="text-xs text-gray-500 text-center mt-1">${book.progress} Ù…Ù† ${book.pages} ØµÙØ­Ø©</p>
                                    </div>
                                ` : ''}
                                
                                <!-- Ø§Ù„Ø±ÙÙˆÙ -->
                                ${book.statuses && book.statuses.length > 0 ? `
                                    <div class="pt-3 border-t border-gray-100 dark:border-gray-700">
                                        <p class="text-sm text-gray-500 mb-2">Ø§Ù„Ø±ÙÙˆÙ</p>
                                        <div class="flex flex-wrap gap-1">
                                            ${book.statuses.map(statusKey => {
                                                const shelf = SHELVES.find(s => s.key === statusKey);
                                                return shelf ? `
                                                    <span class="tag bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 text-xs">
                                                        ${shelf.title}
                                                    </span>
                                                ` : '';
                                            }).join('')}
                                        </div>
                                    </div>
                                ` : ''}
                                
                                <!-- Ø§Ù„Ø£Ø²Ø±Ø§Ø± -->
                                <div class="pt-3 border-t border-gray-100 dark:border-gray-700 space-y-2">
                                    <button onclick="editBook('${book.id}')" class="w-full btn-sm bg-blue-500 text-white hover:bg-blue-600">
                                        <i class="fa-solid fa-edit ml-2"></i>
                                        ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                                    </button>
                                    <button onclick="showCreatePostModal(null, '${book.id}')" class="w-full btn-sm bg-primary-500 text-white hover:bg-primary-600">
                                        <i class="fa-solid fa-plus ml-2"></i>
                                        Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø´ÙˆØ± Ø¬Ø¯ÙŠØ¯
                                    </button>
                                    <button onclick="deleteBook('${book.id}')" class="w-full btn-sm bg-red-500 text-white hover:bg-red-600">
                                        <i class="fa-solid fa-trash ml-2"></i>
                                        Ø­Ø°Ù Ø§Ù„ÙƒØªØ§Ø¨
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Ø§Ù„Ø¹Ù…ÙˆØ¯ÙŠÙ† Ø§Ù„Ø£ÙŠÙ…Ù†ÙŠÙ†: Ø§Ù„ØªÙØ§ØµÙŠÙ„ -->
                    <div class="lg:col-span-2 space-y-4">
                        <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© -->
                        <div class="card">
                            <h3 class="font-medium mb-3 text-gray-900 dark:text-gray-100">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                ${book.publisher ? `
                                    <div>
                                        <p class="text-sm text-gray-500">Ø¯Ø§Ø± Ø§Ù„Ù†Ø´Ø±</p>
                                        <p class="font-medium">${book.publisher}</p>
                                    </div>
                                ` : ''}
                                
                                ${book.category ? `
                                    <div>
                                        <p class="text-sm text-gray-500">Ø§Ù„ØªØµÙ†ÙŠÙ</p>
                                        <p class="font-medium">${book.category}</p>
                                    </div>
                                ` : ''}
                                
                                ${book.language ? `
                                    <div>
                                        <p class="text-sm text-gray-500">Ø§Ù„Ù„ØºØ©</p>
                                        <p class="font-medium">${book.language === 'arabic' ? 'Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©' : 'Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©'}</p>
                                    </div>
                                ` : ''}
                                
                                ${book.series ? `
                                    <div>
                                        <p class="text-sm text-gray-500">Ø§Ù„Ø³Ù„Ø³Ù„Ø©</p>
                                        <p class="font-medium">
                                            ${book.series}
                                            ${book.volume ? ` - Ø§Ù„Ø¬Ø²Ø¡ ${book.volume}` : ''}
                                        </p>
                                    </div>
                                ` : ''}
                                
                                ${book.translator ? `
                                    <div>
                                        <p class="text-sm text-gray-500">Ø§Ù„Ù…ØªØ±Ø¬Ù…</p>
                                        <p class="font-medium">${book.translator}</p>
                                    </div>
                                ` : ''}
                                
                                ${book.edition ? `
                                    <div>
                                        <p class="text-sm text-gray-500">Ø§Ù„Ø·Ø¨Ø¹Ø©</p>
                                        <p class="font-medium">${book.edition}</p>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        
                        <!-- Ø§Ù„Ù…Ù„Ø®Øµ -->
                        ${book.summary ? `
                            <div class="card">
                                <h3 class="font-medium mb-3 text-gray-900 dark:text-gray-100">Ù…Ù„Ø®Øµ Ø§Ù„ÙƒØªØ§Ø¨</h3>
                                <p class="text-gray-700 dark:text-gray-300 leading-relaxed">${book.summary}</p>
                            </div>
                        ` : ''}
                        
                        <!-- Ù†Ø¨Ø°Ø© Ø¹Ù† Ø§Ù„ÙƒØ§ØªØ¨ -->
                        ${book.author_bio ? `
                            <div class="card">
                                <h3 class="font-medium mb-3 text-gray-900 dark:text-gray-100">Ù†Ø¨Ø°Ø© Ø¹Ù† Ø§Ù„ÙƒØ§ØªØ¨</h3>
                                <p class="text-gray-700 dark:text-gray-300 leading-relaxed">${book.author_bio}</p>
                            </div>
                        ` : ''}
                        
                        <!-- Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø´Ø®ØµÙŠØ© -->
                        ${book.notes ? `
                            <div class="card">
                                <h3 class="font-medium mb-3 text-gray-900 dark:text-gray-100">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø´Ø®ØµÙŠØ©</h3>
                                <p class="text-gray-700 dark:text-gray-300 leading-relaxed">${book.notes}</p>
                            </div>
                        ` : ''}
                        
                        <!-- Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© -->
                        <div class="card">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="font-medium text-gray-900 dark:text-gray-100">Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©</h3>
                                <button onclick="showCreatePostModal(null, '${book.id}')" class="btn-sm bg-primary-500 text-white hover:bg-primary-600">
                                    <i class="fa-solid fa-plus ml-2"></i>
                                    Ø¥Ø¶Ø§ÙØ© Ø¬Ø¯ÙŠØ¯
                                </button>
                            </div>
                            
                            <!-- Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„ØªØ¨ÙˆÙŠØ¨ -->
                            <div class="flex flex-wrap gap-2 mb-4">
                                <button onclick="showBookPosts('all')" class="text-xs px-3 py-1 rounded-full bg-primary-100 dark:bg-primary-900/30 text-primary-700 dark:text-primary-300">
                                    Ø§Ù„ÙƒÙ„ (${relatedPosts.length})
                                </button>
                                ${quotes.length > 0 ? `
                                    <button onclick="showBookPosts('quotes')" class="text-xs px-3 py-1 rounded-full bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300">
                                        Ø§Ù‚ØªØ¨Ø§Ø³Ø§Øª (${quotes.length})
                                    </button>
                                ` : ''}
                                ${reviews.length > 0 ? `
                                    <button onclick="showBookPosts('reviews')" class="text-xs px-3 py-1 rounded-full bg-amber-100 dark:bg-amber-900/30 text-amber-700 dark:text-amber-300">
                                        Ù…Ø±Ø§Ø¬Ø¹Ø§Øª (${reviews.length})
                                    </button>
                                ` : ''}
                                ${notes.length > 0 ? `
                                    <button onclick="showBookPosts('notes')" class="text-xs px-3 py-1 rounded-full bg-emerald-100 dark:bg-emerald-900/30 text-emerald-700 dark:text-emerald-300">
                                        Ù…Ù„Ø§Ø­Ø¸Ø§Øª (${notes.length})
                                    </button>
                                ` : ''}
                                ${thoughts.length > 0 ? `
                                    <button onclick="showBookPosts('thoughts')" class="text-xs px-3 py-1 rounded-full bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-300">
                                        Ø£ÙÙƒØ§Ø± (${thoughts.length})
                                    </button>
                                ` : ''}
                            </div>
                            
                            <!-- Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª -->
                            <div id="book-posts-container" class="space-y-3">
                                ${relatedPosts.length === 0 ? `
                                    <div class="text-center py-8 text-gray-500">
                                        <i class="fa-solid fa-feather text-2xl mb-2"></i>
                                        <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†Ø´ÙˆØ±Ø§Øª Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡Ø°Ø§ Ø§Ù„ÙƒØªØ§Ø¨</p>
                                    </div>
                                ` : relatedPosts.map(post => renderPostCard(post, false)).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    function showBookPosts(type) {
        const container = document.getElementById('book-posts-container');
        if (!container) return;
        
        const bookId = AppState.currentBookId;
        const relatedPosts = AppState.posts.filter(post => 
            post.book_ids && post.book_ids.includes(bookId)
        );
        
        let filteredPosts = [];
        
        switch(type) {
            case 'all':
                filteredPosts = relatedPosts;
                break;
            case 'quotes':
                filteredPosts = relatedPosts.filter(p => p.type === 'quote');
                break;
            case 'reviews':
                filteredPosts = relatedPosts.filter(p => p.type === 'review');
                break;
            case 'notes':
                filteredPosts = relatedPosts.filter(p => p.type === 'note');
                break;
            case 'thoughts':
                filteredPosts = relatedPosts.filter(p => p.type === 'thought');
                break;
        }
        
        if (filteredPosts.length === 0) {
            container.innerHTML = `
                <div class="text-center py-8 text-gray-500">
                    <i class="fa-solid fa-feather text-2xl mb-2"></i>
                    <p>Ù„Ø§ ØªÙˆØ¬Ø¯ ${type === 'quotes' ? 'Ø§Ù‚ØªØ¨Ø§Ø³Ø§Øª' : type === 'reviews' ? 'Ù…Ø±Ø§Ø¬Ø¹Ø§Øª' : type === 'notes' ? 'Ù…Ù„Ø§Ø­Ø¸Ø§Øª' : 'Ø£ÙÙƒØ§Ø±'}</p>
                </div>
            `;
            return;
        }
        
        filteredPosts.sort((a, b) => b.created_at - a.created_at);
        container.innerHTML = filteredPosts.map(post => renderPostCard(post, false)).join('');
    }

    // =========================================================================
    // 12. Ø§Ù„Ø¨Ø­Ø«
    // =========================================================================

    function toggleSearchBar() {
        const bar = document.getElementById('search-bar');
        bar.classList.toggle('hidden');
        
        if (!bar.classList.contains('hidden')) {
            document.getElementById('search-input').focus();
        }
    }

    function handleSearch(query) {
        AppState.searchQuery = query;
        
        if (query.trim().length >= 2 || query.trim() === '') {
            navigateTo('search');
            performSearch(query);
        }
    }

    function performSearch(query) {
        const container = document.getElementById('search-results');
        const countElement = document.getElementById('search-results-count');
        
        if (!query.trim()) {
            container.innerHTML = `
                <div class="card text-center py-8 text-gray-500">
                    <i class="fa-solid fa-search text-2xl mb-2"></i>
                    <p>Ø§ÙƒØªØ¨ Ù„Ù„Ø¨Ø­Ø« ÙÙŠ Ù…ÙƒØªØ¨ØªÙƒ</p>
                </div>
            `;
            countElement.textContent = '';
            return;
        }
        
        let results = [];
        let booksResults = [];
        let postsResults = [];
        
        // Ø¨Ø­Ø« ÙÙŠ Ø§Ù„ÙƒØªØ¨
        if (AppState.searchFilter === 'all' || AppState.searchFilter === 'books') {
            booksResults = AppState.books.filter(book => 
                book.title.toLowerCase().includes(query.toLowerCase()) ||
                (book.author && book.author.toLowerCase().includes(query.toLowerCase())) ||
                (book.publisher && book.publisher.toLowerCase().includes(query.toLowerCase())) ||
                (book.summary && book.summary.toLowerCase().includes(query.toLowerCase())) ||
                (book.notes && book.notes.toLowerCase().includes(query.toLowerCase()))
            );
            
            booksResults.forEach(book => {
                results.push({
                    type: 'book',
                    item: book,
                    score: 0
                });
            });
        }
        
        // Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª
        if (AppState.searchFilter === 'all' || AppState.searchFilter === 'quotes' || AppState.searchFilter === 'reviews' || AppState.searchFilter === 'notes') {
            postsResults = AppState.posts.filter(post => {
                if (AppState.searchFilter === 'quotes' && post.type !== 'quote') return false;
                if (AppState.searchFilter === 'reviews' && post.type !== 'review') return false;
                if (AppState.searchFilter === 'notes' && post.type !== 'note') return false;
                
                return post.content.toLowerCase().includes(query.toLowerCase()) ||
                       (post.tags && post.tags.some(tag => tag.toLowerCase().includes(query.toLowerCase())));
            });
            
            postsResults.forEach(post => {
                results.push({
                    type: 'post',
                    item: post,
                    score: 0
                });
            });
        }
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø¯
        countElement.textContent = `(${results.length} Ù†ØªÙŠØ¬Ø©)`;
        
        if (results.length === 0) {
            container.innerHTML = `
                <div class="card text-center py-8 text-gray-500">
                    <i class="fa-solid fa-search text-2xl mb-2"></i>
                    <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù„Ù€ "${query}"</p>
                </div>
            `;
            return;
        }
        
        // Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
        container.innerHTML = results.map(result => {
            if (result.type === 'book') {
                const book = result.item;
                return `
                    <div class="card cursor-pointer hover:shadow-medium" onclick="navigateTo('book-details', {id: '${book.id}'})">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-16 rounded overflow-hidden flex-shrink-0">
                                <img src="${book.cover || 'https://images.unsplash.com/photo-1541963463532-d68292c34b19?ixlib=rb-4.0.3&auto=format&fit=crop&w=100&q=80'}" 
                                     alt="${book.title}" 
                                     class="w-full h-full object-cover">
                            </div>
                            
                            <div class="flex-1">
                                <h3 class="font-medium text-sm mb-1">${book.title}</h3>
                                <p class="text-xs text-gray-500">${book.author || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</p>
                                <div class="text-xs text-gray-400 mt-1">ÙƒØªØ§Ø¨</div>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                const post = result.item;
                const associatedBook = post.book_ids && post.book_ids.length > 0
                    ? AppState.books.find(b => b.id === post.book_ids[0])
                    : null;
                
                const typeInfo = POST_TYPES[post.type] || POST_TYPES.note;
                
                return `
                    <div class="card">
                        <div class="flex items-start justify-between mb-2">
                            <div class="flex items-center gap-2">
                                <div class="w-6 h-6 rounded bg-${typeInfo.color}-100 dark:bg-${typeInfo.color}-900/30 flex items-center justify-center">
                                    <i class="fa-solid ${typeInfo.icon} text-${typeInfo.color}-600 dark:text-${typeInfo.color}-400 text-xs"></i>
                                </div>
                                <span class="text-xs text-${typeInfo.color}-600 dark:text-${typeInfo.color}-400">${typeInfo.text}</span>
                            </div>
                            <div class="text-xs text-gray-500">
                                ${new Date(post.created_at).toLocaleDateString('ar-EG')}
                            </div>
                        </div>
                        
                        <p class="text-gray-700 dark:text-gray-300 text-sm mb-3">
                            ${post.content.length > 150 ? post.content.substring(0, 150) + '...' : post.content}
                        </p>
                        
                        ${associatedBook ? `
                            <div class="text-xs text-gray-500 flex items-center gap-1">
                                <i class="fa-solid fa-book"></i>
                                ${associatedBook.title}
                            </div>
                        ` : ''}
                        
                        ${post.tags && post.tags.length > 0 ? `
                            <div class="flex flex-wrap gap-1 mt-2">
                                ${post.tags.map(tag => `
                                    <span class="text-xs px-2 py-0.5 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded">
                                        ${tag}
                                    </span>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                `;
            }
        }).join('');
    }

    function filterSearchResults(type) {
        AppState.searchFilter = type;
        performSearch(AppState.searchQuery);
    }

    function hideSearchResults() {
        navigateTo('home');
        document.getElementById('search-input').value = '';
        document.getElementById('search-bar').classList.add('hidden');
    }

    // =========================================================================
    // 13. Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ
    // =========================================================================

    function loadMenuStats() {
        document.getElementById('stats-books').textContent = AppState.books.length;
        document.getElementById('stats-posts').textContent = AppState.posts.length;
        document.getElementById('stats-quotes').textContent = AppState.posts.filter(p => p.type === 'quote').length;
        
        // Ø¥Ø¶Ø§ÙØ© Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø§Øª
        const statsReviews = document.getElementById('stats-reviews');
        if (statsReviews) {
            statsReviews.textContent = AppState.posts.filter(p => p.type === 'review').length;
        }
    }

    function loadProfileForm() {
        const profile = AppState.profile;
        
        document.getElementById('profile-name').value = profile.name || '';
        document.getElementById('profile-bio').value = profile.bio || '';
        
        // ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ Ø§Ù„Ø¬Ø¯ÙŠØ¯
        if (document.getElementById('profile-fullname')) {
            document.getElementById('profile-fullname').value = profile.fullName || '';
        }
        if (document.getElementById('profile-birthdate')) {
            document.getElementById('profile-birthdate').value = profile.birthdate || '';
        }
        if (document.getElementById('profile-nationality')) {
            document.getElementById('profile-nationality').value = profile.nationality || '';
        }
        if (document.getElementById('profile-location')) {
            document.getElementById('profile-location').value = profile.location || '';
        }
        if (document.getElementById('profile-books-read')) {
            document.getElementById('profile-books-read').value = profile.stats?.booksRead || 0;
        }
        if (document.getElementById('profile-favorite-books')) {
            document.getElementById('profile-favorite-books').value = profile.stats?.favoriteBooks || 0;
        }
        if (document.getElementById('profile-reading-hours')) {
            document.getElementById('profile-reading-hours').value = profile.stats?.readingHours || 0;
        }
        if (document.getElementById('profile-current-books')) {
            document.getElementById('profile-current-books').value = profile.stats?.currentBooks || 0;
        }
    }

    async function saveProfile() {
        try {
            const name = document.getElementById('profile-name').value.trim();
            const bio = document.getElementById('profile-bio').value.trim();
            
            // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ Ø§Ù„Ø¬Ø¯ÙŠØ¯
            const fullName = document.getElementById('profile-fullname')?.value.trim() || '';
            const birthdate = document.getElementById('profile-birthdate')?.value || '';
            const nationality = document.getElementById('profile-nationality')?.value.trim() || '';
            const location = document.getElementById('profile-location')?.value.trim() || '';
            
            AppState.profile = { 
                name, 
                bio,
                fullName,
                birthdate,
                nationality,
                location,
                stats: {
                    booksRead: parseInt(document.getElementById('profile-books-read')?.value) || 0,
                    favoriteBooks: parseInt(document.getElementById('profile-favorite-books')?.value) || 0,
                    readingHours: parseInt(document.getElementById('profile-reading-hours')?.value) || 0,
                    currentBooks: parseInt(document.getElementById('profile-current-books')?.value) || 0
                }
            };
            
            await DB.save('profile', AppState.profile);
            
            showToast('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ', 'success');
        } catch (error) {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ:', error);
            showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ', 'error');
        }
    }

    function updateStats() {
        loadMenuStats();
    }

    // =========================================================================
    // 14. Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ ÙˆØ§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯
    // =========================================================================

    async function exportBackup() {
        try {
            const books = await DB.getAll('books');
            const posts = await DB.getAll('posts');
            const profile = AppState.profile;
            const settings = AppState.settings;
            
            const data = {
                books,
                posts,
                profile,
                settings,
                shelves: SHELVES,
                writing_shelves: WRITING_SHELVES,
                export_date: new Date().toISOString(),
                version: '2.0'
            };
            
            // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù ZIP
            const zip = new JSZip();
            
            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙƒÙ…Ù„ÙØ§Øª JSON Ù…Ù†ÙØµÙ„Ø©
            zip.file('meta.json', JSON.stringify({
                name: 'Ø³Ø¬Ù„Ùƒ Ø§Ù„Ø£Ø¯Ø¨ÙŠ',
                version: '2.0',
                export_date: new Date().toISOString(),
                items_count: {
                    books: books.length,
                    posts: posts.length
                }
            }, null, 2));
            
            zip.file('books.json', JSON.stringify(books, null, 2));
            zip.file('posts.json', JSON.stringify(posts, null, 2));
            zip.file('profile.json', JSON.stringify(profile, null, 2));
            zip.file('settings.json', JSON.stringify(settings, null, 2));
            
            // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ù„Ù
            const content = await zip.generateAsync({ type: "blob" });
            
            const date = new Date().toISOString().slice(0, 10).replace(/-/g, '');
            const filename = `Ø³Ø¬Ù„Ùƒ-Ø§Ù„Ø£Ø¯Ø¨ÙŠ-Ù†Ø³Ø®Ø©-Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©-${date}.zip`;
            
            saveAs(content, filename);
            
            showToast('ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­', 'success');
        } catch (error) {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØµØ¯ÙŠØ±:', error);
            showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØµØ¯ÙŠØ± Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©', 'error');
        }
    }

    async function handleImport(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        
        reader.onload = async (e) => {
            try {
                showLoading();
                
                let importedData;
                
                if (file.name.endsWith('.zip')) {
                    const zip = await JSZip.loadAsync(e.target.result);
                    const meta = JSON.parse(await zip.file('meta.json').async("text"));
                    const books = JSON.parse(await zip.file('books.json').async("text"));
                    const posts = JSON.parse(await zip.file('posts.json').async("text"));
                    const profile = JSON.parse(await zip.file('profile.json').async("text"));
                    const settings = JSON.parse(await zip.file('settings.json').async("text"));
                    
                    importedData = { books, posts, profile, settings };
                } else if (file.name.endsWith('.json')) {
                    importedData = JSON.parse(e.target.result);
                } else {
                    throw new Error('Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…');
                }
                
                if (!importedData.books || !Array.isArray(importedData.books)) {
                    throw new Error('Ø§Ù„Ù…Ù„Ù Ù„Ø§ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª ØµØ­ÙŠØ­Ø©');
                }
                
                const confirmMerge = confirm(`ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${importedData.books.length} ÙƒØªØ§Ø¨ Ùˆ ${importedData.posts?.length || 0} Ù…Ù†Ø´ÙˆØ±.\n\nÙ‡Ù„ ØªØ±ÙŠØ¯ Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©ØŸ\n\nÙ…ÙˆØ§ÙÙ‚: Ø§Ø³ØªØ¨Ø¯Ø§Ù„ ÙƒØ§Ù…Ù„\nØ¥Ù„ØºØ§Ø¡: Ø¯Ù…Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª`);
                
                if (confirmMerge) {
                    // Ø§Ø³ØªØ¨Ø¯Ø§Ù„ ÙƒØ§Ù…Ù„
                    await DB.db.setItem('books', importedData.books);
                    await DB.db.setItem('posts', importedData.posts || []);
                    await DB.db.setItem('profile', importedData.profile || {});
                    await DB.db.setItem('settings', importedData.settings || {});
                } else {
                    // Ø¯Ù…Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                    const existingBooks = await DB.getAll('books');
                    const existingPosts = await DB.getAll('posts');
                    
                    const mergedBooks = [...existingBooks];
                    const existingBookIds = new Set(existingBooks.map(b => b.id));
                    
                    importedData.books.forEach(book => {
                        if (existingBookIds.has(book.id)) {
                            // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙƒØªØ§Ø¨ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯
                            const index = mergedBooks.findIndex(b => b.id === book.id);
                            mergedBooks[index] = { ...mergedBooks[index], ...book };
                        } else {
                            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙƒØªØ§Ø¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯
                            mergedBooks.push(book);
                        }
                    });
                    
                    await DB.db.setItem('books', mergedBooks);
                    
                    // Ø¯Ù…Ø¬ Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª
                    const mergedPosts = [...existingPosts];
                    const existingPostIds = new Set(existingPosts.map(p => p.id));
                    
                    (importedData.posts || []).forEach(post => {
                        if (!existingPostIds.has(post.id)) {
                            mergedPosts.push(post);
                        }
                    });
                    
                    await DB.db.setItem('posts', mergedPosts);
                }
                
                await loadData();
                hideLoading();
                
                showToast('ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­', 'success');
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø­Ø§Ù„ÙŠ
                switch(AppState.currentView) {
                    case 'home': loadHomePosts(); break;
                    case 'books': loadBooksView(); break;
                    case 'shelves': renderShelvesGrid(); break;
                    case 'menu': loadMenuStats(); loadProfileForm(); break;
                }
                
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯:', error);
                hideLoading();
                showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©', 'error');
            }
        };
        
        reader.readAsArrayBuffer(file);
    }

    // =========================================================================
    // 15. ÙˆØ¸Ø§Ø¦Ù Ù…Ø³Ø§Ø¹Ø¯Ø©
    // =========================================================================

    function copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(() => {
            showToast('ØªÙ… Ù†Ø³Ø® Ø§Ù„Ù†Øµ Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§ÙØ¸Ø©', 'success');
        }).catch(err => {
            console.error('âŒ ÙØ´Ù„ Ø§Ù„Ù†Ø³Ø®:', err);
            showToast('ÙØ´Ù„ Ù†Ø³Ø® Ø§Ù„Ù†Øµ', 'error');
        });
    }

    function showToast(message, type = 'info') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        
        const baseClasses = 'card flex items-center justify-between gap-2 animate-fade-in';
        let colorClasses = '';
        let icon = '';
        
        switch(type) {
            case 'success':
                colorClasses = 'border-l-4 border-emerald-500';
                icon = 'fa-check-circle text-emerald-500';
                break;
            case 'error':
                colorClasses = 'border-l-4 border-red-500';
                icon = 'fa-times-circle text-red-500';
                break;
            case 'info':
                colorClasses = 'border-l-4 border-blue-500';
                icon = 'fa-info-circle text-blue-500';
                break;
            default:
                colorClasses = 'border-l-4 border-gray-500';
                icon = 'fa-info-circle text-gray-500';
        }
        
        toast.className = `${baseClasses} ${colorClasses}`;
        toast.innerHTML = `
            <div class="flex items-center gap-2">
                <i class="fa-solid ${icon}"></i>
                <span>${message}</span>
            </div>
            <button onclick="this.parentElement.remove()" class="text-gray-500 hover:text-gray-700">
                <i class="fa-solid fa-xmark"></i>
            </button>
        `;
        
        container.appendChild(toast);
        
        setTimeout(() => {
            toast.classList.add('opacity-0');
            setTimeout(() => toast.remove(), 300);
        }, 4000);
    }

    function clearCache() {
        if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø³Ø­ Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø¤Ù‚ØªØ©ØŸ')) {
            localStorage.clear();
            showToast('ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø¤Ù‚ØªØ©', 'success');
        }
    }

    // =========================================================================
    // 16. Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    // =========================================================================

    const DB = {
        async init() {
            this.db = localforage.createInstance({
                name: "MaktabatiDB",
                storeName: "maktabati_store"
            });
        },

        async getAll(key) {
            const data = await this.db.getItem(key);
            return data || [];
        },

        async save(key, item) {
            let collection = await this.getAll(key);
            item.id = item.id || Date.now().toString() + Math.random().toString(36).substr(2, 9);
            collection.push(item);
            await this.db.setItem(key, collection);
            return item;
        },

        async update(key, id, newData) {
            let collection = await this.getAll(key);
            const index = collection.findIndex(item => item.id === id);
            if (index !== -1) {
                collection[index] = { ...collection[index], ...newData };
                await this.db.setItem(key, collection);
                return collection[index];
            }
            return null;
        },

        async delete(key, id) {
            let collection = await this.getAll(key);
            collection = collection.filter(item => item.id !== id);
            await this.db.setItem(key, collection);
        }
    };

    // Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ© Ø£ÙˆÙ„ÙŠØ©
    async function setupInitialData() {
        const books = await DB.getAll('books');
        const posts = await DB.getAll('posts');
        
        if (books.length === 0 && posts.length === 0) {
            const demoBooks = [
                {
                    id: '1',
                    title: 'Ù…Ù‚Ø¯Ù…Ø© ÙÙŠ Ø§Ù„ØªØ£Ù…Ù„',
                    author: 'Ø£. Ù. Ù…Ø­Ù…Ø¯',
                    year: 2022,
                    pages: 256,
                    cover: 'https://images.unsplash.com/photo-1544716278-ca5e3f4abd8c?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&q=80',
                    status: 'finished',
                    statuses: ['liked', 'recommended', 'life_changing'],
                    rating: 5,
                    rating_text: 'ÙƒØªØ§Ø¨ ØºÙŠÙ‘Ø± Ø·Ø±ÙŠÙ‚Ø© ØªÙÙƒÙŠØ±ÙŠ',
                    progress: 256,
                    location: 'physical_home',
                    language: 'arabic',
                    category: 'philosophy',
                    added_date: Date.now() - 86400000 * 30,
                    summary: 'ÙƒØªØ§Ø¨ Ø¹Ù…ÙŠÙ‚ Ø¹Ù† Ø§Ù„ØªØ£Ù…Ù„ ÙˆØ£Ø«Ø±Ù‡ Ø¹Ù„Ù‰ Ø§Ù„Ø­ÙŠØ§Ø©',
                    notes: 'ÙŠØ¬Ø¨ Ø£Ù† Ø£Ø¹ÙŠØ¯ Ù‚Ø±Ø§Ø¡ØªÙ‡ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰'
                },
                {
                    id: '2',
                    title: 'ØªØ§Ø±ÙŠØ® Ø§Ù„ÙÙ„Ø³ÙØ© Ø§Ù„Ø­Ø¯ÙŠØ«Ø©',
                    author: 'Ø¬. Ø¯. Ø³Ù„ÙŠÙ…',
                    year: 2020,
                    pages: 480,
                    cover: 'https://images.unsplash.com/photo-1531346688376-ab6275c4725e?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&q=80',
                    status: 'reading',
                    statuses: ['reading', 'heavy_but_important'],
                    rating: 4,
                    progress: 150,
                    location: 'ebook',
                    language: 'arabic',
                    category: 'philosophy',
                    added_date: Date.now() - 86400000 * 60,
                    summary: 'ØªØ§Ø±ÙŠØ® Ø´Ø§Ù…Ù„ Ù„Ù„ÙÙ„Ø³ÙØ© Ø§Ù„Ø­Ø¯ÙŠØ«Ø©'
                },
                {
                    id: '3',
                    title: 'Ø±ÙˆØ§ÙŠØ© Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ø±ÙŠØ§Ø­',
                    author: 'Ù„. ÙŠÙˆØ³Ù',
                    year: 2023,
                    pages: 320,
                    cover: 'https://images.unsplash.com/photo-1512820790803-83ca734da794?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&q=80',
                    status: 'finished',
                    statuses: ['liked', 'emotional'],
                    rating: 5,
                    rating_text: 'Ø±ÙˆØ§ÙŠØ© Ù…Ø¤Ø«Ø±Ø© Ø¬Ø¯Ø§Ù‹',
                    progress: 320,
                    location: 'pdf',
                    language: 'arabic',
                    category: 'fiction',
                    added_date: Date.now() - 86400000 * 10,
                    summary: 'Ø±ÙˆØ§ÙŠØ© Ø¹Ù† Ø±Ø­Ù„Ø© Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø°Ø§Øª'
                }
            ];
            
            const demoPosts = [
                {
                    id: 'p1',
                    type: 'quote',
                    content: 'Ø¥Ù† Ø§Ù„Ø¹Ù‚Ù„ Ù„ÙŠØ³ ÙˆØ¹Ø§Ø¡Ù‹ ÙŠØ¬Ø¨ Ù…Ù„Ø¤Ù‡ØŒ Ø¨Ù„ Ù†Ø§Ø±Ø§Ù‹ ÙŠØ¬Ø¨ Ø¥Ø´Ø¹Ø§Ù„Ù‡Ø§.',
                    book_ids: ['2'],
                    created_at: Date.now() - 86400000 * 5,
                    tags: ['ÙÙ„Ø³ÙØ©', 'ØªØ£Ù…Ù„'],
                    pinned: false
                },
                {
                    id: 'p2',
                    type: 'review',
                    content: 'Ø±ÙˆØ§ÙŠØ© Ù…Ø°Ù‡Ù„Ø© ØªØ³ØªØ­Ù‚ Ø®Ù…Ø³ Ù†Ø¬ÙˆÙ…ØŒ Ù„ÙƒÙ† Ù†Ù‡Ø§ÙŠØªÙ‡Ø§ Ø­ÙŠØ±ØªÙ†ÙŠ.',
                    book_ids: ['3'],
                    created_at: Date.now() - 86400000 * 2,
                    rating: 5,
                    tags: ['Ù…Ø±Ø§Ø¬Ø¹Ø©', 'Ø¹Ø§Ø·ÙÙŠ'],
                    pinned: false
                },
                {
                    id: 'p3',
                    type: 'note',
                    content: 'ÙŠØ¬Ø¨ Ø£Ù† Ø£Ø¨Ø­Ø« Ø£ÙƒØ«Ø± Ø¹Ù† Ù…ÙÙ‡ÙˆÙ… "Ø§Ù„ÙˆØ¬ÙˆØ¯ ÙˆØ§Ù„Ø¹Ø¯Ù…".',
                    book_ids: ['2'],
                    created_at: Date.now() - 86400000 * 1,
                    tags: ['Ø£ÙÙƒØ§Ø±', 'ÙÙ„Ø³ÙØ©'],
                    pinned: false
                },
                {
                    id: 'p4',
                    type: 'thought',
                    content: 'Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ù„ÙŠØ³Øª Ù‡ÙˆØ§ÙŠØ©ØŒ Ø¨Ù„ Ø·Ø±ÙŠÙ‚Ø© Ù„Ù„Ø­ÙŠØ§Ø©.',
                    book_ids: [],
                    created_at: Date.now() - 86400000 * 3,
                    tags: ['ØªØ£Ù…Ù„', 'Ù‚Ø±Ø§Ø¡Ø©'],
                    pinned: false
                }
            ];
            
            await DB.db.setItem('books', demoBooks);
            await DB.db.setItem('posts', demoPosts);
            await DB.db.setItem('profile', { 
                name: 'Ù‚Ø§Ø±Ø¦ Ù„ÙŠÙ„ÙŠ', 
                bio: 'Ù‡Ø§ÙˆÙ Ù„Ù„ÙƒØªØ¨ ÙˆØ§Ù„ØªØ£Ù…Ù„Ø§Øª',
                fullName: 'Ù…Ø­Ù…Ø¯ Ø£Ø­Ù…Ø¯',
                birthdate: '1990-01-15',
                nationality: 'Ø³Ø¹ÙˆØ¯ÙŠ',
                location: 'Ø§Ù„Ø±ÙŠØ§Ø¶',
                stats: {
                    booksRead: 3,
                    favoriteBooks: 2,
                    readingHours: 20,
                    currentBooks: 1
                }
            });
            await DB.db.setItem('settings', { 
                theme: 'default', 
                mode: 'light' 
            });
        }
    }

    // =========================================================================
    // 17. ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
    // =========================================================================

    document.addEventListener('DOMContentLoaded', initApp);
</script>
</body>
</html>
