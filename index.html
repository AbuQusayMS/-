<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>๐ ููุชุจุชู ุงูุดุฎุตูุฉ</title>
    
    <!-- ุชุญููู Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- ุชุญููู Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <!-- ุชุญููู ุงูููุชุจุงุช ุงูุฃุณุงุณูุฉ -->
    <script src="https://cdn.jsdelivr.net/npm/localforage@1.10.0/dist/localforage.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <!-- Fuse.js ููุจุญุซ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.6.2/fuse.min.js"></script>
    
    <!-- ุชุญููู ุฎุทูุท ูุจุณุทุฉ -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600&family=Tajawal:wght@300;400;500&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'primary': {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            200: '#bae6fd',
                            300: '#7dd3fc',
                            400: '#38bdf8',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            700: '#0369a1',
                            800: '#075985',
                            900: '#0c4a6e',
                        },
                        // ุฅุถุงูุฉ ุฃููุงู ุงูุซููุงุช ุงูุฌุฏูุฏุฉ
                        'theme-forest': {
                            500: '#10b981',
                            600: '#059669',
                            700: '#047857'
                        },
                        'theme-sunset': {
                            500: '#f97316',
                            600: '#ea580c',
                            700: '#c2410c'
                        },
                        'theme-ocean': {
                            500: '#06b6d4',
                            600: '#0891b2',
                            700: '#0e7490'
                        },
                        'theme-royal': {
                            500: '#8b5cf6',
                            600: '#7c3aed',
                            700: '#6d28d9'
                        },
                        'theme-earth': {
                            500: '#d97706',
                            600: '#b45309',
                            700: '#92400e'
                        }
                    }
                }
            }
        }
    </script>
    
    <style>
        /* ุฃููุงุท ูุจุณุทุฉ */
        body {
            font-family: 'Cairo', sans-serif;
            font-size: 0.9375rem;
            line-height: 1.6;
        }
        
        /* ุชุญุณููุงุช ุนุงูุฉ */
        .glass-effect {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
        }
        
        .dark .glass-effect {
            background: rgba(15, 23, 42, 0.8);
        }
        
        .card {
            background: white;
            border-radius: 0.875rem;
            padding: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border: 1px solid #e2e8f0;
            transition: all 0.2s;
        }
        
        .dark .card {
            background: #1e293b;
            border-color: #334155;
        }
        
        .card:hover {
            box-shadow: 0 6px 20px rgba(0,0,0,0.12);
            transform: translateY(-2px);
        }
        
        /* ุฃุฒุฑุงุฑ ุตุบูุฑุฉ */
        .btn-sm {
            padding: 0.375rem 0.75rem;
            font-size: 0.875rem;
            border-radius: 0.625rem;
            font-weight: 500;
        }
        
        /* ุฅุฏุฎุงูุงุช ุตุบูุฑุฉ */
        .input-sm {
            padding: 0.375rem 0.75rem;
            font-size: 0.875rem;
            border-radius: 0.625rem;
            border: 1.5px solid #e2e8f0;
        }
        
        .dark .input-sm {
            border-color: #334155;
            background: #1e293b;
        }
        
        /* ุฃููููุงุช ุตุบูุฑุฉ */
        .icon-sm {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.625rem;
            transition: all 0.2s;
        }
        
        /* ุชุฏุฑุฌุงุช ุจุงุณุชูู ุฎูููุฉ */
        .pastel-gradient {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
        }
        
        .dark .pastel-gradient {
            background: linear-gradient(135deg, #0c4a6e 0%, #075985 100%);
        }
        
        /* ุงูุนูุงูุงุช */
        .tag {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        /* ุงูุฑุณูู ุงููุชุญุฑูุฉ */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes slideIn {
            from { transform: translateX(20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .animate-fade-in {
            animation: fadeIn 0.3s ease-out;
        }
        
        .animate-slide-in {
            animation: slideIn 0.3s ease-out;
        }
        
        /* ุดุฑูุท ุงูุชูุฑูุฑ */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        
        .dark ::-webkit-scrollbar-track {
            background: #1e293b;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
        
        .dark ::-webkit-scrollbar-thumb {
            background: #475569;
        }
        
        /* ุชุญุณูู ุงููุฌูุฉ */
        .star-rating i {
            transition: transform 0.2s;
        }
        
        .star-rating i:hover {
            transform: scale(1.2);
        }
        
        /* ุชุฃุซูุฑุงุช ุงูุตูุฑ */
        .book-cover {
            object-fit: cover;
            object-position: center;
            transition: transform 0.3s ease;
        }
        
        .book-cover:hover {
            transform: scale(1.05);
        }
        
        /* ุฒุฑ ุงูุชุญููู */
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #0ea5e9;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="font-sans bg-gray-50 dark:bg-gray-900 text-gray-800 dark:text-gray-200 transition-colors duration-300">

    <!-- ุดุฑูุท ุงูุฅุดุนุงุฑุงุช -->
    <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2 max-w-sm w-full"></div>

    <!-- ุงูุดุฑูุท ุงูุนููู -->
    <header class="sticky top-0 z-30 glass-effect border-b border-gray-200 dark:border-gray-700">
        <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
            <!-- ุฒุฑ ุงูุนูุฏุฉ -->
            <button id="back-btn" class="icon-sm text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 hidden" onclick="goBack()">
                <i class="fa-solid fa-arrow-right"></i>
            </button>
            
            <!-- ุงูุนููุงู -->
            <h1 id="header-title" class="text-lg font-semibold text-primary-600 dark:text-primary-400 truncate">
                ๐ ููุชุจุชู
            </h1>
            
            <!-- ุงูุฃููููุงุช -->
            <div class="flex items-center gap-2">
                <button onclick="toggleSearchBar()" class="icon-sm text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700" title="ุจุญุซ">
                    <i class="fa-solid fa-search"></i>
                </button>
                
                <button onclick="showSettingsModal()" class="icon-sm text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700" title="ุฅุนุฏุงุฏุงุช">
                    <i class="fa-solid fa-gear"></i>
                </button>
                
                <button onclick="toggleDarkMode()" class="icon-sm text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700" title="ุงููุถุน ุงููููู">
                    <i class="fa-solid fa-moon"></i>
                </button>
            </div>
        </div>
        
        <!-- ุดุฑูุท ุงูุจุญุซ -->
        <div id="search-bar" class="hidden px-4 py-3 bg-gray-100 dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 animate-slide-in">
            <div class="max-w-6xl mx-auto">
                <div class="relative">
                    <input type="text" id="search-input" placeholder="ุงุจุญุซ ูู ุงููุชุจ ูุงูููุดูุฑุงุช..." 
                           class="w-full pr-10 pl-3 py-2.5 text-sm rounded-xl bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                    <i class="fa-solid fa-search absolute right-3 top-3 text-gray-400 text-sm"></i>
                </div>
                
                <!-- ุณูุงู ุงูุจุญุซ -->
                <div id="search-context" class="text-xs text-gray-500 dark:text-gray-400 mt-2 hidden">
                    ุงูุจุญุซ ูู: <span id="search-context-text"></span>
                </div>
                
                <!-- ุงูุจุญุซ ุงููุชูุฏู -->
                <button onclick="showAdvancedSearch()" class="mt-2 text-xs text-primary-600 dark:text-primary-400 hover:text-primary-700">
                    <i class="fa-solid fa-sliders ml-1"></i> ููุงุชุฑ ูุชูุฏูุฉ
                </button>
            </div>
        </div>
    </header>

    <!-- ุงููุญุชูู ุงูุฑุฆูุณู -->
    <main class="max-w-6xl mx-auto px-4 py-4 pb-24">
        <!-- ุตูุญุฉ ุงูุฑุฆูุณูุฉ -->
        <section id="view-home" class="view-section space-y-4">
            <div class="flex items-center justify-between">
                <div>
                    <h2 class="text-xl font-semibold text-gray-900 dark:text-gray-100">ุณุฌูู ุงูุฃุฏุจู</h2>
                </div>
                <button onclick="showCreatePostModal()" class="btn-sm bg-primary-500 text-white hover:bg-primary-600 flex items-center gap-2">
                    <i class="fa-solid fa-plus"></i>
                    ุฌุฏูุฏ
                </button>
            </div>
    
            <!-- ููุงุชุฑ ุงููุฑุฒ -->
            <div class="flex flex-wrap gap-2 pb-2">
                <button class="sort-btn active px-3 py-1.5 text-sm rounded-full bg-primary-100 dark:bg-primary-900/30 text-primary-700 dark:text-primary-300" onclick="sortPosts('newest')">
                    ุงูุฃุญุฏุซ
                </button>
                <button class="sort-btn px-3 py-1.5 text-sm rounded-full bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300" onclick="sortPosts('quotes')">
                    ุงูุงูุชุจุงุณุงุช
                </button>
                <button class="sort-btn px-3 py-1.5 text-sm rounded-full bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300" onclick="sortPosts('reviews')">
                    ุงููุฑุงุฌุนุงุช
                </button>
                <button class="sort-btn px-3 py-1.5 text-sm rounded-full bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300" onclick="sortPosts('notes')">
                    ุงูููุงุญุธุงุช
                </button>
            </div>
    
            <!-- ุฌููุน ุงูููุดูุฑุงุช -->
            <div>
                <div id="home-posts-list" class="space-y-3"></div>
            </div>
        </section>

        <!-- ุตูุญุฉ ูุชุงุจุงุชู -->
        <section id="view-writings" class="view-section hidden">
            <div class="mb-6">
                <h2 class="text-xl font-semibold text-gray-900 dark:text-gray-100 mb-2">ูุชุงุจุงุชู</h2>
            </div>
    
            <!-- ุฑููู ุงููุชุงุจุงุช -->
            <div class="flex flex-col gap-3">
                <!-- ุงูุงูุชุจุงุณุงุช -->
                <div class="card cursor-pointer hover:shadow-medium" onclick="openWritingShelf('quotes')">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 rounded-lg bg-blue-100 dark:bg-blue-900/30 flex items-center justify-center">
                            <i class="fa-solid fa-quote-right text-blue-600 dark:text-blue-400 text-lg"></i>
                        </div>
                        <div class="flex-1">
                            <h3 class="font-medium text-sm mb-1">ุงูุงูุชุจุงุณุงุช</h3>
                            <p class="text-xs text-gray-500">ุฃุฌูู ูุง ุฎุทู ุงูุขุฎุฑูู ูู ุญูู ูุฃููุงู</p>
                        </div>
                    </div>
                </div>
        
                <!-- ุงููุฑุงุฌุนุงุช -->
                <div class="card cursor-pointer hover:shadow-medium" onclick="openWritingShelf('reviews')">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 rounded-lg bg-amber-100 dark:bg-amber-900/30 flex items-center justify-center">
                            <i class="fa-solid fa-star text-amber-600 dark:text-amber-400 text-lg"></i>
                        </div>
                        <div class="flex-1">
                            <h3 class="font-medium text-sm mb-1">ุงููุฑุงุฌุนุงุช</h3>
                            <p class="text-xs text-gray-500">ูุฑุงุฌุนุงุช ููุตูุฉ ูููุชุจ ุงูุชู ูุฑุฃุชูุง</p>
                        </div>
                    </div>
                </div>
        
                <!-- ุงูููุงุญุธุงุช -->
                <div class="card cursor-pointer hover:shadow-medium" onclick="openWritingShelf('notes')">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 rounded-lg bg-emerald-100 dark:bg-emerald-900/30 flex items-center justify-center">
                            <i class="fa-solid fa-note-sticky text-emerald-600 dark:text-emerald-400 text-lg"></i>
                        </div>
                        <div class="flex-1">
                            <h3 class="font-medium text-sm mb-1">ุงูููุงุญุธุงุช</h3>
                            <p class="text-xs text-gray-500">ุฎูุงุทุฑู ูุชุฃููุงุชู ุงูุดุฎุตูุฉ</p>
                        </div>
                    </div>
                </div>
            </div>
    
            <!-- ุนุฑุถ ูุญุชููุงุช ุงูุฑู -->
            <div id="writings-shelf-view" class="hidden animate-fade-in">
                <div class="mb-6">
                    <button onclick="backToWritings()" class="icon-sm text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-700 mb-3">
                        <i class="fa-solid fa-arrow-right"></i>
                    </button>
                    <h3 id="writing-shelf-title" class="text-lg font-semibold text-gray-900 dark:text-gray-100"></h3>
                </div>
        
                <div id="writing-shelf-posts" class="space-y-3"></div>
            </div>
        </section>

        <!-- ุตูุญุฉ ุงูููุชุจุฉ -->
        <section id="view-books" class="view-section hidden">
            <div class="flex items-center justify-between mb-6">
                <div>
                    <h2 class="text-xl font-semibold text-gray-900 dark:text-gray-100 mb-2">ุงูููุชุจุฉ</h2>
                </div>
                <button onclick="showCreateBookModal()" class="btn-sm bg-primary-500 text-white hover:bg-primary-600 flex items-center gap-2">
                    <i class="fa-solid fa-plus"></i>
                    ูุชุงุจ ุฌุฏูุฏ
                </button>
            </div>
            
            <!-- ููุงุชุฑ ุงูููุชุจุฉ -->
            <div class="card mb-6">
                <div class="flex flex-wrap items-center justify-between gap-3">
                    <div class="flex-1 min-w-[200px]">
                        <select id="books-sort-select" onchange="sortBooks()" class="w-full input-sm">
                            <option value="newest">ุงูุฃุญุฏุซ ุฅุถุงูุฉ</option>
                            <option value="oldest">ุงูุฃูุฏู ุฅุถุงูุฉ</option>
                            <option value="title_asc">ุงูุนููุงู (ุฃ-ู)</option>
                            <option value="title_desc">ุงูุนููุงู (ู-ุฃ)</option>
                            <option value="author">ุงููุคูู</option>
                            <option value="year_desc">ุงูุฃุญุฏุซ ูุดุฑุงู</option>
                            <option value="year_asc">ุงูุฃูุฏู ูุดุฑุงู</option>
                            <option value="rating_desc">ุงูุฃุนูู ุชููููุงู</option>
                            <option value="pages_asc">ุงูุฃูู ุตูุญุงุช</option>
                            <option value="pages_desc">ุงูุฃูุซุฑ ุตูุญุงุช</option>
                            <option value="status">ุญุงูุฉ ุงููุฑุงุกุฉ</option>
                        </select>
                    </div>
                    
                    <div class="flex items-center gap-2">
                        <div class="relative">
                            <input type="text" id="books-search" placeholder="ุจุญุซ ูู ุงูููุชุจุฉ..." 
                                   class="input-sm pr-8 w-40" 
                                   oninput="searchBooks()">
                            <i class="fa-solid fa-search absolute right-2 top-2 text-gray-400 text-sm"></i>
                        </div>
                        
                        <button onclick="toggleBooksView()" class="icon-sm text-gray-600 dark:text-gray-300" title="ุชุบููุฑ ุงูุนุฑุถ">
                            <i id="books-view-icon" class="fa-solid fa-grip"></i>
                        </button>
                    </div>
                </div>
                
                <!-- ููุงุชุฑ ุณุฑูุนุฉ -->
                <div class="flex flex-wrap gap-2 mt-3">
                    <button onclick="filterByStatus('reading')" class="text-xs px-2 py-1 rounded-full bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300">
                        ุฃูุฑุฃ ุงูุขู
                    </button>
                    <button onclick="filterByStatus('finished')" class="text-xs px-2 py-1 rounded-full bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300">
                        ููุฌุฒ
                    </button>
                    <button onclick="filterByStatus('not_started')" class="text-xs px-2 py-1 rounded-full bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300">
                        ูู ุฃุจุฏุฃ
                    </button>
                    <button onclick="clearFilters()" class="text-xs px-2 py-1 rounded-full bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300">
                        ุฅุนุงุฏุฉ ุชุนููู
                    </button>
                </div>
            </div>
            
            <!-- ุนุฑุถ ุดุจูุฉ ุงููุชุจ -->
            <div id="books-grid-view" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-3"></div>
            
            <!-- ุนุฑุถ ูุงุฆูุฉ ุงููุชุจ -->
            <div id="books-list-view" class="hidden space-y-3"></div>
        </section>

        <!-- ุตูุญุฉ ุงูุฑููู -->
        <section id="view-shelves" class="view-section hidden">
            <div class="mb-6">
                <h2 class="text-xl font-semibold text-gray-900 dark:text-gray-100 mb-2">ุงูุฑููู</h2>
            </div>
    
            <div id="shelves-landing">
                <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3">
                    <!-- ุงูุฑููู ุงูุฑุฆูุณูุฉ -->
                    <div class="card cursor-pointer hover:shadow-medium" onclick="openShelf('reading')">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 rounded-lg bg-shelf-reading flex items-center justify-center">
                                <i class="fa-solid fa-book-open text-amber-700"></i>
                            </div>
                            <div class="flex-1">
                                <h3 class="font-medium text-sm mb-1">ุฃูุฑุฃู ุญุงููุงู</h3>
                                <p class="text-xs text-gray-500">0 ูุชุงุจ</p>
                            </div>
                        </div>
                    </div>
            
                    <div class="card cursor-pointer hover:shadow-medium" onclick="openShelf('want_to_read')">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 rounded-lg bg-shelf-want_to_read flex items-center justify-center">
                                <i class="fa-solid fa-bookmark text-blue-700"></i>
                            </div>
                            <div class="flex-1">
                                <h3 class="font-medium text-sm mb-1">ุฃุฑุบุจ ุจูุฑุงุกุชู</h3>
                                <p class="text-xs text-gray-500">0 ูุชุงุจ</p>
                            </div>
                        </div>
                    </div>
            
                    <div class="card cursor-pointer hover:shadow-medium" onclick="openShelf('liked')">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 rounded-lg bg-shelf-liked flex items-center justify-center">
                                <i class="fa-solid fa-heart text-pink-700"></i>
                            </div>
                            <div class="flex-1">
                                <h3 class="font-medium text-sm mb-1">ุฃุนุฌุจูู</h3>
                                <p class="text-xs text-gray-500">0 ูุชุงุจ</p>
                            </div>
                        </div>
                    </div>
            
                    <div class="card cursor-pointer hover:shadow-medium" onclick="openShelf('recommended')">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 rounded-lg bg-shelf-recommended flex items-center justify-center">
                                <i class="fa-solid fa-star text-yellow-700"></i>
                            </div>
                            <div class="flex-1">
                                <h3 class="font-medium text-sm mb-1">ุฃูุตุญ ุจู</h3>
                                <p class="text-xs text-gray-500">0 ูุชุงุจ</p>
                            </div>
                        </div>
                    </div>
            
                    <!-- ุฑููู ุฅุถุงููุฉ -->
                    <div class="card cursor-pointer hover:shadow-medium" onclick="openShelf('life_changing')">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 rounded-lg bg-shelf-life_changing flex items-center justify-center">
                                <i class="fa-solid fa-brain text-green-700"></i>
                            </div>
                            <div class="flex-1">
                                <h3 class="font-medium text-sm mb-1">ุบููุฑ ุชูููุฑู</h3>
                                <p class="text-xs text-gray-500">0 ูุชุงุจ</p>
                            </div>
                        </div>
                    </div>
            
                    <div class="card cursor-pointer hover:shadow-medium" onclick="openShelf('thought_provoking')">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 rounded-lg bg-shelf-thought_provoking flex items-center justify-center">
                                <i class="fa-solid fa-lightbulb text-purple-700"></i>
                            </div>
                            <div class="flex-1">
                                <h3 class="font-medium text-sm mb-1">ุญููุฑูู</h3>
                                <p class="text-xs text-gray-500">0 ูุชุงุจ</p>
                            </div>
                        </div>
                    </div>
            
                    <div class="card cursor-pointer hover:shadow-medium" onclick="openShelf('heavy_but_important')">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 rounded-lg bg-shelf-heavy_but_important flex items-center justify-center">
                                <i class="fa-solid fa-weight-hanging text-gray-700"></i>
                            </div>
                            <div class="flex-1">
                                <h3 class="font-medium text-sm mb-1">ุซููู ููู ููู</h3>
                                <p class="text-xs text-gray-500">0 ูุชุงุจ</p>
                            </div>
                        </div>
                    </div>
            
                    <div class="card cursor-pointer hover:shadow-medium" onclick="openShelf('emotional')">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 rounded-lg bg-shelf-emotional flex items-center justify-center">
                                <i class="fa-solid fa-heart-crack text-red-700"></i>
                            </div>
                            <div class="flex-1">
                                <h3 class="font-medium text-sm mb-1">ุนุงุทูู</h3>
                                <p class="text-xs text-gray-500">0 ูุชุงุจ</p>
                            </div>
                        </div>
                    </div>
            
                    <!-- ุฑููู ุฃุฎุฑู -->
                    <div class="card cursor-pointer hover:shadow-medium" onclick="openShelf('faded_out')">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 rounded-lg bg-shelf-faded_out flex items-center justify-center">
                                <i class="fa-solid fa-battery-empty text-yellow-700"></i>
                            </div>
                            <div class="flex-1">
                                <h3 class="font-medium text-sm mb-1">ุจุฏุฃ ููููุง ุซู ุฎูู</h3>
                                <p class="text-xs text-gray-500">0 ูุชุงุจ</p>
                            </div>
                        </div>
                    </div>
            
                    <div class="card cursor-pointer hover:shadow-medium" onclick="openShelf('experimental')">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 rounded-lg bg-shelf-experimental flex items-center justify-center">
                                <i class="fa-solid fa-flask text-lime-700"></i>
                            </div>
                            <div class="flex-1">
                                <h3 class="font-medium text-sm mb-1">ุชุฌุฑุจุฉ</h3>
                                <p class="text-xs text-gray-500">0 ูุชุงุจ</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
    
            <!-- ุนุฑุถ ูุญุชููุงุช ุงูุฑู -->
            <div id="shelves-shelf-view" class="hidden animate-fade-in">
                <div class="mb-6">
                    <button onclick="backToShelves()" class="icon-sm text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-700 mb-3">
                        <i class="fa-solid fa-arrow-right"></i>
                    </button>
                    <h3 id="shelf-title" class="text-lg font-semibold text-gray-900 dark:text-gray-100"></h3>
                </div>
        
                <!-- ูุฑุฒ ุฏุงุฎู ุงูุฑู -->
                <div class="mb-4">
                    <select id="shelf-sort-select" onchange="sortShelfBooks()" class="input-sm">
                        <option value="title_asc">ุงูุนููุงู (ุฃ-ู)</option>
                        <option value="added_newest">ุงูุฃุญุฏุซ ุฅุถุงูุฉ</option>
                        <option value="rating_desc">ุงูุฃุนูู ุชููููุงู</option>
                        <option value="year_desc">ุงูุฃุญุฏุซ ูุดุฑุงู</option>
                    </select>
                </div>
        
                <!-- ูุชุจ ุงูุฑู -->
                <div id="shelf-books-grid" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-3"></div>
            </div>
        </section>

        <!-- ุตูุญุฉ ุงูุฅุนุฏุงุฏุงุช -->
        <section id="view-menu" class="view-section hidden space-y-4">
            <h2 class="text-xl font-semibold text-gray-900 dark:text-gray-100">โ๏ธ ุงูุฅุนุฏุงุฏุงุช</h2>
            
            <!-- ุงูููู ุงูุดุฎุตู -->
            <div class="card">
                <h3 class="font-medium mb-3 text-gray-900 dark:text-gray-100 flex items-center gap-2">
                    <i class="fa-solid fa-user"></i>
                    ูููู ุงูุดุฎุตู
                </h3>
                <div class="grid grid-cols-3 gap-3 text-center mb-4">
                    <div>
                        <div class="text-lg font-semibold text-primary-600 dark:text-primary-400" id="stats-books">0</div>
                        <div class="text-xs text-gray-500">ุงููุชุจ</div>
                    </div>
                    <div>
                        <div class="text-lg font-semibold text-primary-600 dark:text-primary-400" id="stats-posts">0</div>
                        <div class="text-xs text-gray-500">ุงูููุดูุฑุงุช</div>
                    </div>
                    <div>
                        <div class="text-lg font-semibold text-primary-600 dark:text-primary-400" id="stats-quotes">0</div>
                        <div class="text-xs text-gray-500">ุงูุงูุชุจุงุณุงุช</div>
                    </div>
                </div>
                
                <!-- ูุนูููุงุช ุงูููู -->
                <div class="space-y-3">
                    <div>
                        <label class="block text-xs text-gray-500 mb-1">ุงุณู ุงููุณุชุฎุฏู</label>
                        <input type="text" id="profile-name" class="w-full input-sm" placeholder="ุงุณูู">
                    </div>
                    <div>
                        <label class="block text-xs text-gray-500 mb-1">ุงููุตู</label>
                        <textarea id="profile-bio" rows="2" class="w-full input-sm" placeholder="ูุตู ูุตูุฑ"></textarea>
                    </div>
                    <button onclick="saveProfile()" class="w-full btn-sm bg-primary-500 text-white hover:bg-primary-600">
                        ุญูุธ ุงูููู ุงูุดุฎุตู
                    </button>
                </div>
            </div>
            
            <!-- ุงูุฅุนุฏุงุฏุงุช ุงูุนุงูุฉ -->
            <div class="card space-y-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-gray-100 dark:bg-gray-700 rounded-lg flex items-center justify-center">
                            <i class="fa-solid fa-moon text-gray-600 dark:text-gray-300"></i>
                        </div>
                        <div>
                            <div class="font-medium text-gray-900 dark:text-gray-100">ุงููุถุน ุงููููู</div>
                            <div class="text-xs text-gray-500">ุชุบููุฑ ูุธูุฑ ุงูุชุทุจูู</div>
                        </div>
                    </div>
                    <button id="theme-toggle" class="w-12 h-6 rounded-full bg-gray-300 dark:bg-gray-700 relative" onclick="toggleDarkMode()">
                        <div class="absolute top-0.5 left-0.5 w-5 h-5 rounded-full bg-white transition-transform duration-300"></div>
                    </button>
                </div>
                
                <!-- ุชุบููุฑ ุงูุซูู -->
                <button onclick="showThemeSettings()" class="w-full flex items-center justify-between py-2 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded-lg transition-colors">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-gray-100 dark:bg-gray-700 rounded-lg flex items-center justify-center">
                            <i class="fa-solid fa-palette text-gray-600 dark:text-gray-300"></i>
                        </div>
                        <div>
                            <div class="font-medium text-gray-900 dark:text-gray-100">ุชุบููุฑ ููุท ุงูุนุฑุถ</div>
                            <div class="text-xs text-gray-500">ุงุฎุชุฑ ุซูู ููุงุณุจ ุฐููู</div>
                        </div>
                    </div>
                    <i class="fa-solid fa-arrow-left text-gray-400"></i>
                </button>
                
                <!-- ุงููุณุฎ ุงูุงุญุชูุงุทู -->
                <div class="pt-4 border-t border-gray-100 dark:border-gray-700">
                    <h4 class="font-medium text-gray-700 dark:text-gray-300 mb-3">ุงููุณุฎ ุงูุงุญุชูุงุทู</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <button onclick="exportBackup()" class="btn-sm bg-emerald-500 text-white hover:bg-emerald-600 flex items-center justify-center gap-2">
                            <i class="fa-solid fa-download"></i>
                            ุชุตุฏูุฑ
                        </button>
                        
                        <label class="btn-sm bg-blue-500 text-white hover:bg-blue-600 flex items-center justify-center gap-2 cursor-pointer">
                            <i class="fa-solid fa-upload"></i>
                            ุงุณุชูุฑุงุฏ
                            <input type="file" id="import-file-input" class="hidden" accept=".json,.zip">
                        </label>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">ุงููุณุฎ ุงูุงุญุชูุงุทู ูุญูุธ ุฌููุน ุจูุงูุงุชู ุจุดูู ุขูู</p>
                </div>
                
        <!-- ุตูุญุฉ ุงูุฅุนุฏุงุฏุงุช -->
        <section id="view-menu" class="view-section hidden space-y-4">
            <h2 class="text-xl font-semibold text-gray-900 dark:text-gray-100">ุงูุฅุนุฏุงุฏุงุช</h2>
    
            <!-- ุงูููู ุงูุดุฎุตู ุงููุชูุงูู -->
            <div class="card">
                <h3 class="font-medium mb-3 text-gray-900 dark:text-gray-100 flex items-center gap-2">
                    <i class="fa-solid fa-user"></i>
                    ุงูููู ุงูุดุฎุตู
                </h3>
        
                <!-- ุตูุฑุฉ ุงูุดุฎุตูุฉ -->
                <div class="flex flex-col items-center mb-4">
                    <div id="profile-image-container" class="w-24 h-24 rounded-full overflow-hidden border-4 border-gray-200 dark:border-gray-700 mb-3 cursor-pointer" onclick="document.getElementById('profile-image-input').click()">
                        <img id="profile-image" src="" alt="ุตูุฑุฉ ุงูุดุฎุตูุฉ" class="w-full h-full object-cover bg-gray-100 dark:bg-gray-700">
                        <div id="profile-image-placeholder" class="w-full h-full flex items-center justify-center bg-gray-100 dark:bg-gray-700">
                            <i class="fa-solid fa-user text-3xl text-gray-400"></i>
                        </div>
                    </div>
                    <input type="file" id="profile-image-input" accept="image/*" class="hidden" onchange="uploadProfileImage(event)">
                    <p class="text-xs text-gray-500">ุงููุฑ ูุชุบููุฑ ุงูุตูุฑุฉ</p>
                </div>
        
                <!-- ูุนูููุงุช ุงูุดุฎุตูุฉ -->
                <div class="space-y-3">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">ุงูุงุณู ุงููุงูู</label>
                            <input type="text" id="profile-fullname" class="w-full input-sm" placeholder="ุงูุงุณู ุงููุงูู">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">ุชุงุฑูุฎ ุงููููุงุฏ</label>
                            <input type="date" id="profile-birthdate" class="w-full input-sm">
                        </div>
                    </div>
            
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">ุงูุฌูุณูุฉ</label>
                            <input type="text" id="profile-nationality" class="w-full input-sm" placeholder="ุงูุฌูุณูุฉ">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">ุงููููุน</label>
                            <input type="text" id="profile-location" class="w-full input-sm" placeholder="ุงููุฏููุฉ ุฃู ุงูุจูุฏ">
                        </div>
                    </div>
            
                    <div>
                        <label class="block text-xs text-gray-500 mb-1">ูุจุฐุฉ ูุตูุฑุฉ</label>
                        <textarea id="profile-bio" rows="3" class="w-full input-sm" placeholder="ุงูุชุจ ุนู ููุณู..."></textarea>
                    </div>
            
                    <!-- ุฅุญุตุงุฆูุงุช ุงููุฑุงุกุฉ -->
                    <div class="border-t border-gray-100 dark:border-gray-700 pt-3">
                        <h4 class="font-medium text-sm text-gray-700 dark:text-gray-300 mb-2">ุฅุญุตุงุฆูุงุช ุงููุฑุงุกุฉ</h4>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-xs text-gray-500 mb-1">ุงููุชุจ ุงูููุฑูุกุฉ</label>
                                <input type="number" id="profile-books-read" class="w-full input-sm" value="0">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-500 mb-1">ุงููุชุจ ุงูููุถูุฉ</label>
                                <input type="number" id="profile-favorite-books" class="w-full input-sm" value="0">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-500 mb-1">ุณุงุนุงุช ุงููุฑุงุกุฉ (ุดูุฑูุงู)</label>
                                <input type="number" id="profile-reading-hours" class="w-full input-sm" value="0">
                            </div>
                            <div>
                               <label class="block text-xs text-gray-500 mb-1">ุงููุชุจ ุงูุญุงููุฉ</label>
                                <input type="number" id="profile-current-books" class="w-full input-sm" value="0">
                            </div>
                        </div>
                    </div>
            
                    <button onclick="saveProfile()" class="w-full btn-sm bg-primary-500 text-white hover:bg-primary-600">
                        ุญูุธ ุงูููู ุงูุดุฎุตู
                    </button>
                </div>
            </div>
    
            <!-- ุฅุญุตุงุฆูุงุช ุณุฑูุนุฉ -->
            <div class="card">
                <h3 class="font-medium mb-3 text-gray-900 dark:text-gray-100">ุฅุญุตุงุฆูุงุชู</h3>
                <div class="grid grid-cols-4 gap-3 text-center">
                    <div>
                        <div class="text-lg font-semibold text-primary-600 dark:text-primary-400" id="stats-books">0</div>
                        <div class="text-xs text-gray-500">ุงููุชุจ</div>
                    </div>
                    <div>
                        <div class="text-lg font-semibold text-primary-600 dark:text-primary-400" id="stats-posts">0</div>
                        <div class="text-xs text-gray-500">ุงูููุดูุฑุงุช</div>
                    </div>
                    <div>
                        <div class="text-lg font-semibold text-primary-600 dark:text-primary-400" id="stats-quotes">0</div>
                        <div class="text-xs text-gray-500">ุงูุงูุชุจุงุณุงุช</div>
                    </div>
                    <div>
                        <div class="text-lg font-semibold text-primary-600 dark:text-primary-400" id="stats-reviews">0</div>
                        <div class="text-xs text-gray-500">ุงููุฑุงุฌุนุงุช</div>
                    </div>
                </div>
            </div>
    
            <!-- ุงูุซููุงุช -->
            <div class="card">
                <h3 class="font-medium mb-3 text-gray-900 dark:text-gray-100">ุงูุซููุงุช ูุงูุฃููุงู</h3>
                <div class="grid grid-cols-3 gap-3">
                    <div class="theme-option p-3 rounded-lg border cursor-pointer" data-theme="default" onclick="selectTheme('default')">
                        <div class="w-full h-8 bg-gradient-to-r from-blue-500 to-purple-500 rounded mb-2"></div>
                        <p class="text-sm font-medium text-center">ุฃุณุงุณู</p>
                    </div>
            
                    <div class="theme-option p-3 rounded-lg border cursor-pointer" data-theme="forest" onclick="selectTheme('forest')">
                        <div class="w-full h-8 bg-gradient-to-r from-emerald-500 to-green-500 rounded mb-2"></div>
                        <p class="text-sm font-medium text-center">ุบุงุจุฉ</p>
                    </div>
            
                    <div class="theme-option p-3 rounded-lg border cursor-pointer" data-theme="sunset" onclick="selectTheme('sunset')">
                        <div class="w-full h-8 bg-gradient-to-r from-orange-500 to-pink-500 rounded mb-2"></div>
                        <p class="text-sm font-medium text-center">ุบุฑูุจ</p>
                    </div>
            
                    <div class="theme-option p-3 rounded-lg border cursor-pointer" data-theme="ocean" onclick="selectTheme('ocean')">
                        <div class="w-full h-8 bg-gradient-to-r from-cyan-500 to-blue-500 rounded mb-2"></div>
                        <p class="text-sm font-medium text-center">ูุญูุท</p>
                    </div>
            
                    <div class="theme-option p-3 rounded-lg border cursor-pointer" data-theme="royal" onclick="selectTheme('royal')">
                        <div class="w-full h-8 bg-gradient-to-r from-purple-500 to-indigo-500 rounded mb-2"></div>
                        <p class="text-sm font-medium text-center">ูููู</p>
                    </div>
            
                    <div class="theme-option p-3 rounded-lg border cursor-pointer" data-theme="earth" onclick="selectTheme('earth')">
                        <div class="w-full h-8 bg-gradient-to-r from-amber-500 to-brown-500 rounded mb-2"></div>
                        <p class="text-sm font-medium text-center">ุฃุฑุถู</p>
                    </div>
                </div>
            </div>
    
            <!-- ุงููุณุฎ ุงูุงุญุชูุงุทู -->
            <div class="card">
                <h3 class="font-medium mb-3 text-gray-900 dark:text-gray-100">ุงููุณุฎ ุงูุงุญุชูุงุทู</h3>
                <div class="space-y-3">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <button onclick="exportBackup()" class="btn-sm bg-emerald-500 text-white hover:bg-emerald-600 flex items-center justify-center gap-2">
                            <i class="fa-solid fa-download"></i>
                            ุชุตุฏูุฑ
                        </button>
                
                        <label class="btn-sm bg-blue-500 text-white hover:bg-blue-600 flex items-center justify-center gap-2 cursor-pointer">
                            <i class="fa-solid fa-upload"></i>
                            ุงุณุชูุฑุงุฏ
                            <input type="file" id="import-file-input" class="hidden" accept=".json,.zip">
                        </label>
                    </div>
                   <p class="text-xs text-gray-500">ุงููุณุฎ ุงูุงุญุชูุงุทู ูุญูุธ ุฌููุน ุจูุงูุงุชู ุจุดูู ุขูู</p>
                </div>
            </div>
    
            <!-- ุงููุถุน ุงููููู -->
            <div class="card">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-gray-100 dark:bg-gray-700 rounded-lg flex items-center justify-center">
                            <i class="fa-solid fa-moon text-gray-600 dark:text-gray-300"></i>
                        </div>
                        <div>
                            <div class="font-medium text-gray-900 dark:text-gray-100">ุงููุถุน ุงููููู</div>
                            <div class="text-xs text-gray-500">ุชุบููุฑ ูุธูุฑ ุงูุชุทุจูู</div>
                        </div>
                    </div>
                    <button id="theme-toggle" class="w-12 h-6 rounded-full bg-gray-300 dark:bg-gray-700 relative" onclick="toggleDarkMode()">
                        <div class="absolute top-0.5 left-0.5 w-5 h-5 rounded-full bg-white transition-transform duration-300"></div>
                    </button>
                </div>
            </div>
        </section>

        <!-- ุตูุญุฉ ุชูุงุตูู ุงููุชุงุจ -->
        <section id="view-book-details" class="view-section hidden"></section>

        <!-- ุตูุญุฉ ูุชุงุฆุฌ ุงูุจุญุซ -->
        <section id="view-search" class="view-section hidden">
            <div class="flex items-center gap-3 mb-6">
                <button onclick="hideSearchResults()" class="icon-sm text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-700">
                    <i class="fa-solid fa-arrow-right"></i>
                </button>
                <div>
                    <h2 class="text-xl font-semibold text-gray-900 dark:text-gray-100">๐ ูุชุงุฆุฌ ุงูุจุญุซ</h2>
                    <p id="search-results-count" class="text-sm text-gray-600 dark:text-gray-400"></p>
                </div>
            </div>
            
            <!-- ููุงุชุฑ ุงูุจุญุซ -->
            <div class="card mb-4">
                <div class="flex flex-wrap gap-2">
                    <button onclick="filterSearchResults('all')" class="text-xs px-2 py-1 rounded-full bg-primary-100 dark:bg-primary-900/30 text-primary-700 dark:text-primary-300">
                        ุงููู
                    </button>
                    <button onclick="filterSearchResults('books')" class="text-xs px-2 py-1 rounded-full bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300">
                        ุงููุชุจ
                    </button>
                    <button onclick="filterSearchResults('quotes')" class="text-xs px-2 py-1 rounded-full bg-emerald-100 dark:bg-emerald-900/30 text-emerald-700 dark:text-emerald-300">
                        ุงูุงูุชุจุงุณุงุช
                    </button>
                    <button onclick="filterSearchResults('reviews')" class="text-xs px-2 py-1 rounded-full bg-amber-100 dark:bg-amber-900/30 text-amber-700 dark:text-amber-300">
                        ุงููุฑุงุฌุนุงุช
                    </button>
                </div>
            </div>
            
            <div id="search-results" class="space-y-3"></div>
        </section>
    </main>

    <!-- ุงูุชููู ุงูุณููู -->
    <nav class="fixed bottom-0 left-0 right-0 glass-effect border-t border-gray-200 dark:border-gray-700">
        <div class="max-w-lg mx-auto flex justify-around py-3">
            <button class="nav-btn flex flex-col items-center p-2 text-gray-500" data-view="home" onclick="navigateTo('home')">
                <i class="fa-solid fa-house text-lg mb-1"></i>
                <span class="text-xs">ุงูุฑุฆูุณูุฉ</span>
            </button>
            <button class="nav-btn flex flex-col items-center p-2 text-gray-500" data-view="writings" onclick="navigateTo('writings')">
                <i class="fa-solid fa-pen text-lg mb-1"></i>
                <span class="text-xs">ูุชุงุจุงุชู</span>
            </button>
            <button class="nav-btn flex flex-col items-center p-2 text-gray-500" data-view="books" onclick="navigateTo('books')">
                <i class="fa-solid fa-book text-lg mb-1"></i>
                <span class="text-xs">ุงูููุชุจุฉ</span>
            </button>
            <button class="nav-btn flex flex-col items-center p-2 text-gray-500" data-view="shelves" onclick="navigateTo('shelves')">
                <i class="fa-solid fa-boxes-stacked text-lg mb-1"></i>
                <span class="text-xs">ุงูุฑููู</span>
            </button>
            <button class="nav-btn flex flex-col items-center p-2 text-gray-500" data-view="menu" onclick="navigateTo('menu')">
                <i class="fa-solid fa-gear text-lg mb-1"></i>
                <span class="text-xs">ุงูุฅุนุฏุงุฏุงุช</span>
            </button>
        </div>
    </nav>

    <!-- ========================================================================= -->
    <!-- ุงูููุงูุฐ ุงูููุจุซูุฉ -->
    <!-- ========================================================================= -->

    <!-- ูุงูุฐุฉ ุฅูุดุงุก/ุชุนุฏูู ููุดูุฑ -->
    <div id="post-modal" class="fixed inset-0 bg-black/50 dark:bg-black/70 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 rounded-xl w-full max-w-md max-h-[90vh] overflow-y-auto animate-fade-in">
            <div class="p-4 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between">
                <h3 id="post-modal-title" class="font-semibold text-gray-900 dark:text-gray-100">ููุดูุฑ ุฌุฏูุฏ</h3>
                <button onclick="hideCreatePostModal()" class="icon-sm text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-700">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
            
            <div class="p-4 space-y-4">
                <!-- ููุน ุงูููุดูุฑ -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ููุน ุงูููุดูุฑ</label>
                    <div class="grid grid-cols-2 gap-2">
                        <button data-type="quote" onclick="selectPostType('quote')" class="py-2 rounded-lg bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 flex items-center justify-center gap-2">
                            <i class="fa-solid fa-quote-right"></i>
                            ุงูุชุจุงุณ
                        </button>
                        <button data-type="note" onclick="selectPostType('note')" class="py-2 rounded-lg bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300 flex items-center justify-center gap-2">
                            <i class="fa-solid fa-note-sticky"></i>
                            ููุงุญุธุฉ
                        </button>
                        <button data-type="review" onclick="selectPostType('review')" class="py-2 rounded-lg bg-amber-100 dark:bg-amber-900/30 text-amber-700 dark:text-amber-300 flex items-center justify-center gap-2">
                            <i class="fa-solid fa-star"></i>
                            ูุฑุงุฌุนุฉ
                        </button>
                        <button data-type="thought" onclick="selectPostType('thought')" class="py-2 rounded-lg bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-300 flex items-center justify-center gap-2">
                            <i class="fa-solid fa-lightbulb"></i>
                            ููุฑุฉ
                        </button>
                    </div>
                </div>
                
                <!-- ุงููุญุชูู -->
                <div>
                    <label for="post-content" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ุงููุญุชูู</label>
                    <textarea id="post-content" rows="4" placeholder="ุงูุชุจ ููุง..." class="w-full p-3 text-sm rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary-500 focus:border-primary-500"></textarea>
                </div>
                
                <!-- ุงูุชูููู -->
                <div id="post-rating-field" class="hidden">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ุงูุชูููู</label>
                    <div class="flex items-center gap-4">
                        <div class="star-rating text-2xl text-amber-500" id="rating-stars">
                            <i class="fa-regular fa-star cursor-pointer" data-rating="1"></i>
                            <i class="fa-regular fa-star cursor-pointer" data-rating="2"></i>
                            <i class="fa-regular fa-star cursor-pointer" data-rating="3"></i>
                            <i class="fa-regular fa-star cursor-pointer" data-rating="4"></i>
                            <i class="fa-regular fa-star cursor-pointer" data-rating="5"></i>
                        </div>
                        <input type="number" id="post-rating-input" min="1" max="5" value="5" class="w-16 input-sm text-center">
                    </div>
                </div>
                
                <!-- ุงููุณูู -->
                <div>
                    <label for="post-tags" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ุงููุณูู</label>
                    <input type="text" id="post-tags" placeholder="ุฃุถู ูุณููุงู (ูุซู: ููุณูุฉุ ุฃุฏุจ)" class="w-full input-sm">
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">ุงูุตู ุจูู ุงููุณูู ุจูุงุตูุฉ</p>
                </div>
                
                <!-- ุงุฎุชูุงุฑ ูุชุงุจ -->
                <div>
                    <label for="post-book-select" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ุฑุจุท ุจูุชุงุจ (ุงุฎุชูุงุฑู)</label>
                    
                    <!-- ุจุญุซ ุงููุชุจ -->
                    <input type="text" id="book-search-input" placeholder="ุงุจุญุซ ุนู ูุชุงุจ..." class="w-full mb-2 input-sm">
                    
                    <!-- ูุงุฆูุฉ ุงููุชุจ -->
                    <div id="book-search-results" class="max-h-48 overflow-y-auto border border-gray-300 dark:border-gray-600 rounded-lg hidden mb-2">
                        <!-- ูุชุงุฆุฌ ุงูุจุญุซ ุชุธูุฑ ููุง -->
                    </div>
                    
                    <!-- ุงููุชุงุจ ุงููุฎุชุงุฑ -->
                    <select id="post-book-select" class="w-full input-sm">
                        <option value="">ุงุฎุชุฑ ูุชุงุจุงู...</option>
                    </select>
                </div>
                
                <!-- ุฎูุงุฑุงุช ุฅุถุงููุฉ -->
                <div class="space-y-2">
                    <label class="flex items-center gap-2">
                        <input type="checkbox" id="post-pinned" class="rounded">
                        <span class="text-sm text-gray-700 dark:text-gray-300">ุชุซุจูุช ุงูููุดูุฑ</span>
                    </label>
                    
                    <label class="flex items-center gap-2">
                        <input type="checkbox" id="post-private" class="rounded">
                        <span class="text-sm text-gray-700 dark:text-gray-300">ููุดูุฑ ุฎุงุต</span>
                    </label>
                </div>
            </div>
            
            <div class="p-4 border-t border-gray-200 dark:border-gray-700 flex justify-end gap-2">
                <button onclick="hideCreatePostModal()" class="btn-sm bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300">
                    ุฅูุบุงุก
                </button>
                <button onclick="savePost()" class="btn-sm bg-primary-500 text-white hover:bg-primary-600">
                    ุญูุธ
                </button>
            </div>
        </div>
    </div>

    <!-- ูุงูุฐุฉ ุฅูุดุงุก/ุชุนุฏูู ูุชุงุจ -->
    <div id="book-modal" class="fixed inset-0 bg-black/50 dark:bg-black/70 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 rounded-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto animate-fade-in">
            <div class="p-4 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between">
                <h3 id="book-modal-title" class="font-semibold text-gray-900 dark:text-gray-100">ุฅุถุงูุฉ ูุชุงุจ ุฌุฏูุฏ</h3>
                <button onclick="hideCreateBookModal()" class="icon-sm text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-700">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
            
            <form id="book-form" class="p-4 space-y-4">
                <!-- ุงููุนูููุงุช ุงูุฃุณุงุณูุฉ -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="book-title" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ุนููุงู ุงููุชุงุจ *</label>
                        <input type="text" id="book-title" required class="w-full input-sm" placeholder="ุฃุฏุฎู ุนููุงู ุงููุชุงุจ">
                    </div>
                    
                    <div>
                        <label for="book-author" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ุงููุคูู *</label>
                        <input type="text" id="book-author" required class="w-full input-sm" placeholder="ุงุณู ุงููุคูู">
                    </div>
                </div>
                
                <!-- ุชูุงุตูู ุงููุดุฑ -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label for="book-year" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ุณูุฉ ุงููุดุฑ</label>
                        <input type="number" id="book-year" class="w-full input-sm" placeholder="ูุซุงู: 2023">
                    </div>
                    
                    <div>
                        <label for="book-pages" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ุนุฏุฏ ุงูุตูุญุงุช</label>
                        <input type="number" id="book-pages" class="w-full input-sm" placeholder="ูุซุงู: 320">
                    </div>
                    
                    <div>
                        <label for="book-publisher" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ุฏุงุฑ ุงููุดุฑ</label>
                        <input type="text" id="book-publisher" class="w-full input-sm" placeholder="ุงุณู ุฏุงุฑ ุงููุดุฑ">
                    </div>
                </div>
                
                <!-- ูุนูููุงุช ุงููุฑุงุกุฉ -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="book-status" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ุญุงูุฉ ุงููุฑุงุกุฉ</label>
                        <select id="book-status" class="w-full input-sm">
                            <option value="not_started">ูู ุฃุจุฏุฃ</option>
                            <option value="reading">ุฃูุฑุฃ ุงูุขู</option>
                            <option value="paused">ูุชููู</option>
                            <option value="finished">ููุฌุฒ</option>
                        </select>
                    </div>
                    
                    <div>
                        <label for="book-progress" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ุงูุตูุญุงุช ุงูููุฑูุกุฉ</label>
                        <input type="number" id="book-progress" class="w-full input-sm" placeholder="ุนุฏุฏ ุงูุตูุญุงุช ุงูููุฑูุกุฉ">
                    </div>
                </div>
                
                <!-- ุงูุชูุงุฑูุฎ -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label for="book-start-date" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ุชุงุฑูุฎ ุงูุจุฏุก</label>
                        <input type="date" id="book-start-date" class="w-full input-sm">
                    </div>
                    
                    <div>
                        <label for="book-finish-date" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ุชุงุฑูุฎ ุงูุฅููุงุก</label>
                        <input type="date" id="book-finish-date" class="w-full input-sm">
                    </div>
                    
                    <div>
                        <label for="book-pause-date" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ุชุงุฑูุฎ ุงูุชููู</label>
                        <input type="date" id="book-pause-date" class="w-full input-sm">
                    </div>
                </div>
                
                <!-- ุงูุชุตููู ูุงููุบุฉ -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="book-category" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ุงูุชุตููู</label>
                        <select id="book-category" class="w-full input-sm">
                            <option value="">ุงุฎุชุฑ ุชุตูููุงู</option>
                            <option value="fiction">ุฃุฏุจ</option>
                            <option value="non-fiction">ุบูุฑ ุฃุฏุจู</option>
                            <option value="philosophy">ููุณูุฉ</option>
                            <option value="science">ุนูู</option>
                            <option value="history">ุชุงุฑูุฎ</option>
                            <option value="biography">ุณูุฑุฉ ุฐุงุชูุฉ</option>
                            <option value="self_help">ุชุทููุฑ ุงูุฐุงุช</option>
                        </select>
                    </div>
                    
                    <div>
                        <label for="book-language" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ูุบุฉ ุงููุชุงุจ</label>
                        <select id="book-language" class="w-full input-sm">
                            <option value="arabic">ุงูุนุฑุจูุฉ</option>
                            <option value="english">ุงูุฅูุฌููุฒูุฉ</option>
                            <option value="french">ุงููุฑูุณูุฉ</option>
                            <option value="other">ุฃุฎุฑู</option>
                        </select>
                    </div>
                </div>
                
                <!-- ุงูุณูุณูุฉ -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="book-series" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ุงูุณูุณูุฉ</label>
                        <input type="text" id="book-series" class="w-full input-sm" placeholder="ุงุณู ุงูุณูุณูุฉ">
                    </div>
                    
                    <div>
                        <label for="book-volume" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ุฑูู ุงูุฌุฒุก</label>
                        <input type="number" id="book-volume" class="w-full input-sm" placeholder="ุฑูู ุงูุฌุฒุก">
                    </div>
                </div>
                
                <!-- ูุนูููุงุช ุฅุถุงููุฉ -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="book-translator" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ุงููุชุฑุฌู</label>
                        <input type="text" id="book-translator" class="w-full input-sm" placeholder="ุงุณู ุงููุชุฑุฌู">
                    </div>
                    
                    <div>
                        <label for="book-edition" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ุฑูู ุงูุทุจุนุฉ</label>
                        <input type="number" id="book-edition" class="w-full input-sm" placeholder="ุงูุทุจุนุฉ">
                    </div>
                </div>
                
                <!-- ููุงู ุงููุชุงุจ -->
                <div>
                    <label for="book-location" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ููุงู ุงููุชุงุจ</label>
                    <select id="book-location" class="w-full input-sm">
                        <option value="physical_home">ูุณุฎุฉ ูุฑููุฉ ูู ุงูุจูุช</option>
                        <option value="ebook">ูุณุฎุฉ ุฅููุชุฑูููุฉ</option>
                        <option value="pdf">PDF</option>
                        <option value="online">ุฃูููุงูู</option>
                    </select>
                </div>
                
                <!-- ุงูุฑููู -->
                <div>
                    <label for="book-shelves-select" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ุงูุฑููู</label>
                    <select id="book-shelves-select" multiple class="w-full input-sm h-32">
                        <!-- ุงูุฑููู ุชุธูุฑ ููุง -->
                    </select>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">ุงุถุบุท Ctrl ููุงุฎุชูุงุฑ ุงููุชุนุฏุฏ</p>
                </div>
                
                <!-- ุงูุชูููู -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ุชููููู ุงูุดุฎุตู</label>
                    <div class="flex items-center gap-4">
                        <div class="star-rating text-2xl text-amber-500" id="book-rating-stars">
                            <i class="fa-regular fa-star cursor-pointer" data-rating="1"></i>
                            <i class="fa-regular fa-star cursor-pointer" data-rating="2"></i>
                            <i class="fa-regular fa-star cursor-pointer" data-rating="3"></i>
                            <i class="fa-regular fa-star cursor-pointer" data-rating="4"></i>
                            <i class="fa-regular fa-star cursor-pointer" data-rating="5"></i>
                        </div>
                        <input type="hidden" id="book-rating" value="0">
                    </div>
                </div>
                
                <!-- ุชูููู ูุตู -->
                <div>
                    <label for="book-rating-text" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ุชูููู ูุตู ูุตูุฑ</label>
                    <input type="text" id="book-rating-text" class="w-full input-sm" placeholder="ุฑุฃูู ุจูููุงุช ุจุณูุทุฉ">
                </div>
                
                <!-- ุงูููุฎุต -->
                <div>
                    <label for="book-summary" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ููุฎุต ูุตูุฑ ูููุชุงุจ</label>
                    <textarea id="book-summary" rows="3" class="w-full input-sm" placeholder="ุงูุชุจ ููุฎุตุงู ูุตูุฑุงู ูููุชุงุจ"></textarea>
                </div>
                
                <!-- ูุจุฐุฉ ุนู ุงููุงุชุจ -->
                <div>
                    <label for="book-author-bio" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ูุจุฐุฉ ุนู ุงููุงุชุจ</label>
                    <textarea id="book-author-bio" rows="2" class="w-full input-sm" placeholder="ูุนูููุงุช ูุฎุชุตุฑุฉ ุนู ุงููุคูู"></textarea>
                </div>
                
                <!-- ููุงุญุธุงุช ุดุฎุตูุฉ -->
                <div>
                    <label for="book-notes" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ููุงุญุธุงุช ุดุฎุตูุฉ</label>
                    <textarea id="book-notes" rows="3" class="w-full input-sm" placeholder="ููุงุญุธุงุชู ุนู ุงููุชุงุจ"></textarea>
                </div>
                
                <!-- ุตูุฑุฉ ุงูุบูุงู -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ุตูุฑุฉ ุงูุบูุงู</label>
                    <div class="border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-4 text-center cursor-pointer hover:border-primary-400 transition-colors" onclick="document.getElementById('book-cover-input').click()">
                        <input type="file" id="book-cover-input" accept="image/*" class="hidden" onchange="previewBookCover(event)">
                        <div id="book-cover-preview" class="w-32 h-48 mx-auto bg-gray-100 dark:bg-gray-700 rounded flex flex-col items-center justify-center mb-4 overflow-hidden">
                            <i class="fa-solid fa-image text-4xl text-gray-400 dark:text-gray-500 mb-3"></i>
                            <p class="text-sm text-gray-600 dark:text-gray-400">ุงููุฑ ูุชุญููู ุตูุฑุฉ</p>
                        </div>
                        <p class="text-xs text-gray-500 dark:text-gray-400">ุงูุตูุฑ ุชุชุญูู ุจุฌูุฏุฉ ุนุงููุฉ</p>
                    </div>
                </div>
            </form>
            
            <div class="p-4 border-t border-gray-200 dark:border-gray-700 flex justify-end gap-2">
                <button onclick="hideCreateBookModal()" class="btn-sm bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300">
                    ุฅูุบุงุก
                </button>
                <button onclick="saveBook()" class="btn-sm bg-primary-500 text-white hover:bg-primary-600">
                    ุญูุธ ุงููุชุงุจ
                </button>
            </div>
        </div>
    </div>

    <!-- ูุงูุฐุฉ ุงูุฅุนุฏุงุฏุงุช -->
    <div id="settings-modal" class="fixed inset-0 bg-black/50 dark:bg-black/70 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 rounded-xl w-full max-w-md max-h-[90vh] overflow-y-auto animate-fade-in">
            <div class="p-4 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between">
                <h3 class="font-semibold text-gray-900 dark:text-gray-100">โ๏ธ ุงูุฅุนุฏุงุฏุงุช ุงููุชูุฏูุฉ</h3>
                <button onclick="hideSettingsModal()" class="icon-sm text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-700">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
            
            <div class="p-4 space-y-6">
                <!-- ุงูุซููุงุช -->
                <div>
                    <h4 class="font-medium text-gray-900 dark:text-gray-100 mb-3">ุงุฎุชุฑ ููุท ุงูุนุฑุถ</h4>
                    <div class="grid grid-cols-2 gap-3">
                        <div class="theme-option p-3 rounded-lg border-2 border-transparent cursor-pointer hover:border-primary-400 transition-all" data-theme="classic" onclick="selectTheme('classic')">
                            <div class="w-8 h-8 bg-gradient-to-br from-blue-400 to-purple-500 rounded-lg mb-2"></div>
                            <p class="text-sm font-medium">ููุงุณููู</p>
                            <p class="text-xs text-gray-500">ูุงุฏุฆ ูุฃููู</p>
                        </div>
                        
                        <div class="theme-option p-3 rounded-lg border-2 border-transparent cursor-pointer hover:border-primary-400 transition-all" data-theme="light" onclick="selectTheme('light')">
                            <div class="w-8 h-8 bg-gradient-to-br from-gray-100 to-gray-300 rounded-lg mb-2"></div>
                            <p class="text-sm font-medium">ูุงุชุญ</p>
                            <p class="text-xs text-gray-500">ุณุงุทุน ููุงุถุญ</p>
                        </div>
                        
                        <div class="theme-option p-3 rounded-lg border-2 border-transparent cursor-pointer hover:border-primary-400 transition-all" data-theme="dark" onclick="selectTheme('dark')">
                            <div class="w-8 h-8 bg-gradient-to-br from-gray-800 to-gray-900 rounded-lg mb-2"></div>
                            <p class="text-sm font-medium">ุฏุงูู</p>
                            <p class="text-xs text-gray-500">ูุฑูุญ ููุนูู</p>
                        </div>
                        
                        <div class="theme-option p-3 rounded-lg border-2 border-transparent cursor-pointer hover:border-primary-400 transition-all" data-theme="ocean" onclick="selectTheme('ocean')">
                            <div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-teal-500 rounded-lg mb-2"></div>
                            <p class="text-sm font-medium">ูุญูุท</p>
                            <p class="text-xs text-gray-500">ุฃุฒุฑู ุณูุงูู</p>
                        </div>
                    </div>
                </div>
                
                <!-- ุฅุนุฏุงุฏุงุช ุงููุณุฎ ุงูุงุญุชูุงุทู -->
                <div>
                    <h4 class="font-medium text-gray-900 dark:text-gray-100 mb-3">ุงููุณุฎ ุงูุงุญุชูุงุทู</h4>
                    <div class="space-y-3">
                        <button onclick="exportBackup()" class="w-full btn-sm bg-emerald-500 text-white hover:bg-emerald-600 flex items-center justify-center gap-2">
                            <i class="fa-solid fa-download"></i>
                            ุชุตุฏูุฑ ุฌููุน ุงูุจูุงูุงุช
                        </button>
                        
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">ุชููุงุฆู ูู</label>
                            <select id="auto-backup-frequency" class="w-full input-sm">
                                <option value="never">ูุง</option>
                                <option value="weekly">ุฃุณุจูุน</option>
                                <option value="monthly">ุดูุฑ</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- ุฅุนุฏุงุฏุงุช ุงูุจุญุซ -->
                <div>
                    <h4 class="font-medium text-gray-900 dark:text-gray-100 mb-3">ุฅุนุฏุงุฏุงุช ุงูุจุญุซ</h4>
                    <div class="space-y-3">
                        <label class="flex items-center justify-between">
                            <span class="text-sm text-gray-700 dark:text-gray-300">ุงูุจุญุซ ุงูููุฑู</span>
                            <input type="checkbox" id="instant-search" class="rounded" checked>
                        </label>
                        
                        <label class="flex items-center justify-between">
                            <span class="text-sm text-gray-700 dark:text-gray-300">ุชุถููู ุงููุณูู</span>
                            <input type="checkbox" id="search-include-tags" class="rounded" checked>
                        </label>
                        
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">ุฏูุฉ ุงูุจุญุซ</label>
                            <select id="search-precision" class="w-full input-sm">
                                <option value="normal">ุทุจูุนู</option>
                                <option value="strict">ุฏููู</option>
                                <option value="loose">ูุฑู</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- ุฅุนุฏุงุฏุงุช ุงููุงุฌูุฉ -->
                <div>
                    <h4 class="font-medium text-gray-900 dark:text-gray-100 mb-3">ุฅุนุฏุงุฏุงุช ุงููุงุฌูุฉ</h4>
                    <div class="space-y-3">
                        <label class="flex items-center justify-between">
                            <span class="text-sm text-gray-700 dark:text-gray-300">ุงูุฑุณูู ุงููุชุญุฑูุฉ</span>
                            <input type="checkbox" id="animations-enabled" class="rounded" checked>
                        </label>
                        
                        <label class="flex items-center justify-between">
                            <span class="text-sm text-gray-700 dark:text-gray-300">ุธูุงู ุงูุจุทุงูุงุช</span>
                            <input type="checkbox" id="card-shadows" class="rounded" checked>
                        </label>
                        
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">ุญุฌู ุงูุฎุท</label>
                            <select id="font-size" class="w-full input-sm">
                                <option value="small">ุตุบูุฑ</option>
                                <option value="normal" selected>ุทุจูุนู</option>
                                <option value="large">ูุจูุฑ</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="p-4 border-t border-gray-200 dark:border-gray-700 flex justify-end">
                <button onclick="hideSettingsModal()" class="btn-sm bg-primary-500 text-white hover:bg-primary-600">
                    ุญูุธ ุงูุฅุนุฏุงุฏุงุช
                </button>
            </div>
        </div>
    </div>

    <!-- ูุงูุฐุฉ ุงูุจุญุซ ุงููุชูุฏู -->
    <div id="advanced-search-modal" class="fixed inset-0 bg-black/50 dark:bg-black/70 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 rounded-xl w-full max-w-md max-h-[90vh] overflow-y-auto animate-fade-in">
            <div class="p-4 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between">
                <h3 class="font-semibold text-gray-900 dark:text-gray-100">๐ ุงูุจุญุซ ุงููุชูุฏู</h3>
                <button onclick="hideAdvancedSearch()" class="icon-sm text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-700">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
            
            <div class="p-4 space-y-4">
                <!-- ุงููุต -->
                <div>
                    <label for="advanced-search-text" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ุงููุต</label>
                    <input type="text" id="advanced-search-text" class="w-full input-sm" placeholder="ุงูุชุจ ููุจุญุซ...">
                </div>
                
                <!-- ุงูููุน -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ุงูููุน</label>
                    <div class="grid grid-cols-2 gap-2">
                        <label class="flex items-center gap-2">
                            <input type="checkbox" id="search-type-book" class="rounded" checked>
                            <span class="text-sm text-gray-700 dark:text-gray-300">ูุชุจ</span>
                        </label>
                        <label class="flex items-center gap-2">
                            <input type="checkbox" id="search-type-quote" class="rounded" checked>
                            <span class="text-sm text-gray-700 dark:text-gray-300">ุงูุชุจุงุณุงุช</span>
                        </label>
                        <label class="flex items-center gap-2">
                            <input type="checkbox" id="search-type-review" class="rounded" checked>
                            <span class="text-sm text-gray-700 dark:text-gray-300">ูุฑุงุฌุนุงุช</span>
                        </label>
                        <label class="flex items-center gap-2">
                            <input type="checkbox" id="search-type-note" class="rounded" checked>
                            <span class="text-sm text-gray-700 dark:text-gray-300">ููุงุญุธุงุช</span>
                        </label>
                    </div>
                </div>
                
                <!-- ุงูุชูููู -->
                <div>
                    <label for="search-rating" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ุงูุชูููู</label>
                    <select id="search-rating" class="w-full input-sm">
                        <option value="">ุงููู</option>
                        <option value="5">โญโญโญโญโญ ููุท</option>
                        <option value="4">โญโญโญโญ ูุฃุนูู</option>
                        <option value="3">โญโญโญ ูุฃุนูู</option>
                    </select>
                </div>
                
                <!-- ุงูุชูุงุฑูุฎ -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="search-date-from" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ูู ุชุงุฑูุฎ</label>
                        <input type="date" id="search-date-from" class="w-full input-sm">
                    </div>
                    
                    <div>
                        <label for="search-date-to" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ุฅูู ุชุงุฑูุฎ</label>
                        <input type="date" id="search-date-to" class="w-full input-sm">
                    </div>
                </div>
                
                <!-- ุงููุฑุฒ -->
                <div>
                    <label for="search-sort" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ุชุฑุชูุจ ุงููุชุงุฆุฌ</label>
                    <select id="search-sort" class="w-full input-sm">
                        <option value="newest">ุงูุฃุญุฏุซ ุฃููุงู</option>
                        <option value="oldest">ุงูุฃูุฏู ุฃููุงู</option>
                        <option value="alphabetical">ุงูุฃุจุฌุฏู</option>
                        <option value="rating">ุงูุฃุนูู ุชููููุงู</option>
                    </select>
                </div>
                
                <!-- ุงูุฏูุฉ -->
                <div>
                    <label for="search-precision-advanced" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ุฏูุฉ ุงูุจุญุซ</label>
                    <select id="search-precision-advanced" class="w-full input-sm">
                        <option value="partial">ุชุทุงุจู ุฌุฒุฆู</option>
                        <option value="exact">ุชุทุงุจู ูุงูู</option>
                        <option value="fuzzy">ุชูุฑูุจู</option>
                    </select>
                </div>
            </div>
            
            <div class="p-4 border-t border-gray-200 dark:border-gray-700 flex justify-end gap-2">
                <button onclick="hideAdvancedSearch()" class="btn-sm bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300">
                    ุฅูุบุงุก
                </button>
                <button onclick="performAdvancedSearch()" class="btn-sm bg-primary-500 text-white hover:bg-primary-600">
                    ุจุญุซ
                </button>
            </div>
        </div>
    </div>

    <!-- ูุงูุฐุฉ ุงูุชุญููู -->
    <div id="loading-overlay" class="fixed inset-0 bg-black/50 dark:bg-black/70 z-50 hidden flex items-center justify-center">
        <div class="bg-white dark:bg-gray-800 rounded-xl p-8 flex flex-col items-center">
            <div class="loading-spinner mb-4"></div>
            <p class="text-gray-700 dark:text-gray-300 font-medium">ุฌุงุฑู ุงูุชุญููู...</p>
        </div>
    </div>

    <!-- ========================================================================= -->
    <!-- JavaScript ุงููุงูู -->
    <!-- ========================================================================= -->
    <script>
        // =========================================================================
        // 1. ุงูุซูุงุจุช ูุฅุฏุงุฑุฉ ุงูุญุงูุฉ
        // =========================================================================
        
        const SHELVES = [
            { key: 'reading', title: 'ุฃูุฑุฃู ุญุงููุงู', desc: 'ุงููุชุจ ุงูุชู ุฃุชุงุจุนูุง ุงูุขู', icon: 'fa-book-open', color: 'shelf-reading' },
            { key: 'want_to_read', title: 'ุฃุฑุบุจ ุจูุฑุงุกุชู', desc: 'ูุชุจ ุฎุทุทุช ููุฑุงุกุชูุง', icon: 'fa-bookmark', color: 'shelf-want_to_read' },
            { key: 'liked', title: 'ุฃุนุฌุจูู', desc: 'ูุชุจ ุงุณุชูุชุนุช ุจูุฑุงุกุชูุง', icon: 'fa-heart', color: 'shelf-liked' },
            { key: 'recommended', title: 'ุฃูุตุญ ุจู', desc: 'ูุชุจ ุฃูุตู ุจูุง ููุขุฎุฑูู', icon: 'fa-star', color: 'shelf-recommended' },
            { key: 'life_changing', title: 'ุบููุฑ ุชูููุฑู', desc: 'ูุชุจ ุฃุซุฑุช ุนูู ุฑุคูุชู', icon: 'fa-brain', color: 'shelf-life_changing' },
            { key: 'thought_provoking', title: 'ุญููุฑูู', desc: 'ูุชุจ ุทุฑุญุช ุฃุณุฆูุฉ ุตุนุจุฉ', icon: 'fa-lightbulb', color: 'shelf-thought_provoking' },
            { key: 'heavy_but_important', title: 'ุซููู ููู ููู', desc: 'ูุชุจ ุชุญุชุงุฌ ูุฌูุฏ', icon: 'fa-weight-hanging', color: 'shelf-heavy_but_important' },
            { key: 'emotional', title: 'ุนุงุทูู', desc: 'ูุชุจ ุฃุซุฑุช ุนูู ูุดุงุนุฑู', icon: 'fa-heart-crack', color: 'shelf-emotional' },
            { key: 'faded_out', title: 'ุจุฏุฃ ููููุง ุซู ุฎูู', desc: 'ูุชุจ ุงูุฎูุถ ูุณุชูุงูุง', icon: 'fa-battery-empty', color: 'shelf-faded_out' },
            { key: 'experimental', title: 'ุชุฌุฑุจุฉ', desc: 'ูุชุจ ูุฑุฃุชูุง ูุชุฌุฑุจุฉ ููุท ุฌุฏูุฏ', icon: 'fa-flask', color: 'shelf-experimental' },
            { key: 'reread', title: 'ุฃุนุฏุช ูุฑุงุกุชู', desc: 'ูุชุจ ูุฑุฃุชูุง ุฃูุซุฑ ูู ูุฑุฉ', icon: 'fa-rotate', color: 'teal-100' },
            { key: 'bookmark', title: 'ููุฑุฌูุน ูุงุญููุง', desc: 'ูุชุจ ุณุฃุนูุฏ ุฅูููุง ูุงุญูุงู', icon: 'fa-bookmark', color: 'rose-100' }
        ];

        const WRITING_SHELVES = {
                'quotes': { title: 'ุงูุงูุชุจุงุณุงุช', desc: 'ุฃุฌูู ูุง ุฎุทู ุงูุขุฎุฑูู ูู ุญูู ูุฃููุงู', icon: 'fa-quote-right', color: 'blue' },
                'reviews': { title: 'ุงููุฑุงุฌุนุงุช', desc: 'ูุฑุงุฌุนุงุช ููุตูุฉ ูููุชุจ ุงูุชู ูุฑุฃุชูุง', icon: 'fa-star', color: 'amber' },
                'notes': { title: 'ุงูููุงุญุธุงุช', desc: 'ุฎูุงุทุฑู ูุชุฃููุงุชู ุงูุดุฎุตูุฉ', icon: 'fa-note-sticky', color: 'emerald' }
};

        const READING_STATUS = {
            'not_started': { text: 'ูู ุฃุจุฏุฃ', color: 'gray' },
            'reading': { text: 'ุฃูุฑุฃ ุงูุขู', color: 'blue' },
            'paused': { text: 'ูุชููู', color: 'orange' },
            'finished': { text: 'ููุฌุฒ', color: 'green' }
        };

        const BOOK_LOCATIONS = {
            'physical_home': { text: 'ูุณุฎุฉ ูุฑููุฉ', icon: 'fa-book' },
            'ebook': { text: 'ูุณุฎุฉ ุฅููุชุฑูููุฉ', icon: 'fa-tablet' },
            'pdf': { text: 'PDF', icon: 'fa-file-pdf' },
            'online': { text: 'ุฃูููุงูู', icon: 'fa-globe' }
        };

        const POST_TYPES = {
            'quote': { icon: 'fa-quote-right', text: 'ุงูุชุจุงุณ', color: 'blue' },
            'note': { icon: 'fa-note-sticky', text: 'ููุงุญุธุฉ', color: 'emerald' },
            'review': { icon: 'fa-star', text: 'ูุฑุงุฌุนุฉ', color: 'amber' },
            'thought': { icon: 'fa-lightbulb', text: 'ููุฑุฉ', color: 'purple' }
        };

        const AppState = {
            currentView: 'home',
            currentShelf: null,
            currentWritingShelf: null,
            currentBookId: null,
            editingPostId: null,
            editingBookId: null,
            books: [],
            posts: [],
            profile: { name: 'ูุงุฑุฆ', bio: 'ูุณุชุฎุฏู ููุชุจุฉ' },
            settings: { theme: 'light', mode: 'light' },
            navigationStack: [],
            searchQuery: '',
            booksViewMode: 'grid',
            currentPostSort: 'newest',
            showPinnedOnly: false,
            searchFilter: 'all',
            fuseBooks: null,
            fusePosts: null
        };

        // =========================================================================
        // 2. ุงูุชููุฆุฉ
        // =========================================================================

        async function initApp() {
            try {
                showLoading();
                await DB.init();
                await setupInitialData();
                await loadData();
                setupEventListeners();
                setupSearchIndexes();
                navigateTo('home');
                hideLoading();
                
                // ุฅุธูุงุฑ ุฑุณุงูุฉ ุชุฑุญูุจ
                setTimeout(() => {
                    showToast('ูุฑุญุจุงู ุจู ูู ููุชุจุชู ุงูุดุฎุตูุฉ ๐', 'success');
                }, 1000);
            } catch (error) {
                console.error('โ ุฎุทุฃ ูู ุชููุฆุฉ ุงูุชุทุจูู:', error);
                showToast('ุญุฏุซ ุฎุทุฃ ูู ุชููุฆุฉ ุงูุชุทุจูู', 'error');
                hideLoading();
            }
        }

        function showLoading() {
            document.getElementById('loading-overlay').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loading-overlay').classList.add('hidden');
        }

        async function loadData() {
            try {
                AppState.books = await DB.getAll('books') || [];
                AppState.posts = await DB.getAll('posts') || [];
                AppState.profile = await DB.getAll('profile') || { name: 'ูุงุฑุฆ', bio: 'ูุณุชุฎุฏู ููุชุจุฉ' };
                AppState.settings = await DB.getAll('settings') || { theme: 'classic', mode: 'light' };
                
                // ุชุทุจูู ุงูุซูู ุงููุญููุธ
                applyTheme(AppState.settings.theme, AppState.settings.mode === 'dark');
                
                // ุชุญุฏูุซ ุงูุฅุญุตุงุฆูุงุช
                updateStats();
                
                console.log(`โ ุชู ุชุญููู ${AppState.books.length} ูุชุงุจ ู ${AppState.posts.length} ููุดูุฑ`);
            } catch (error) {
                console.error('โ ุฎุทุฃ ูู ุชุญููู ุงูุจูุงูุงุช:', error);
            }
        }

        function setupSearchIndexes() {
            AppState.fuseBooks = new Fuse(AppState.books, {
                keys: ['title', 'author', 'publisher', 'category', 'series', 'notes', 'summary'],
                threshold: 0.3,
                includeScore: true
            });
            
            AppState.fusePosts = new Fuse(AppState.posts, {
                keys: ['content', 'tags', 'type'],
                threshold: 0.3,
                includeScore: true
            });
        }

        function setupEventListeners() {
            // ุงูุจุญุซ ุงูููุฑู
            document.getElementById('search-input')?.addEventListener('input', debounce(function(e) {
                handleSearch(e.target.value);
            }, 300));
            
            // ุงูุจุญุซ ูู ูุงูุฐุฉ ุงูููุดูุฑ
            document.getElementById('book-search-input')?.addEventListener('input', function(e) {
                searchBooksInModal(e.target.value);
            });
            
            // ุงูููุฑ ุฎุงุฑุฌ ูุชุงุฆุฌ ุงูุจุญุซ
            document.addEventListener('click', function(e) {
                if (!e.target.closest('#book-search-results') && !e.target.closest('#book-search-input')) {
                    document.getElementById('book-search-results').classList.add('hidden');
                }
            });
            
            // ุงูุงุณุชูุฑุงุฏ
            document.getElementById('import-file-input')?.addEventListener('change', handleImport);
            
            // ุงููุฌูุฉ ูู ูุงูุฐุฉ ุงูููุดูุฑ
            document.getElementById('rating-stars')?.addEventListener('click', function(e) {
                if (e.target.matches('i')) {
                    const rating = parseInt(e.target.dataset.rating);
                    setPostRating(rating);
                }
            });
            
            // ุงููุฌูุฉ ูู ูุงูุฐุฉ ุงููุชุงุจ
            document.getElementById('book-rating-stars')?.addEventListener('click', function(e) {
                if (e.target.matches('i')) {
                    const rating = parseInt(e.target.dataset.rating);
                    setBookRating(rating);
                }
            });
            
            // ุชุญููู ุงููุถุน ุงููููู
            loadDarkMode();
        }

        function debounce(func, delay) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), delay);
            };
        }

        function loadDarkMode() {
            const savedTheme = localStorage.getItem('theme');
            const savedMode = localStorage.getItem('mode');
            
            if (savedTheme) {
                AppState.settings.theme = savedTheme;
            }
            
            if (savedMode === 'dark') {
                document.documentElement.classList.add('dark');
                const toggleBtn = document.getElementById('theme-toggle');
                const circle = toggleBtn.querySelector('div');
                circle.style.transform = 'translateX(1.75rem)';
            }
        }

        // =========================================================================
        // 3. ุงูุชููู ูุงููุงุฌูุฉ
        // =========================================================================

        function navigateTo(viewId, params = {}) {
            // ุฅุฎูุงุก ุฌููุน ุงูุตูุญุงุช
            document.querySelectorAll('.view-section').forEach(section => {
                section.classList.add('hidden');
            });
            
            // ุชุญุฏูุงุช ุงูุชููู
            if (viewId !== AppState.currentView) {
                AppState.navigationStack.push(AppState.currentView);
            }
            
            // ุฅุธูุงุฑ ุฒุฑ ุงูุนูุฏุฉ ุฅุฐุง ูุฒู
            const backBtn = document.getElementById('back-btn');
            if (viewId !== 'home') {
                backBtn.classList.remove('hidden');
            } else {
                backBtn.classList.add('hidden');
            }
            
            // ุชุญุฏูุซ ุงูุนููุงู
            updateHeaderTitle(viewId);
            
            // ุฅุธูุงุฑ ุงูุตูุญุฉ ุงููุทููุจุฉ
            const targetSection = document.getElementById(`view-${viewId}`);
            if (targetSection) {
                targetSection.classList.remove('hidden');
                AppState.currentView = viewId;
                
                // ุชุญุฏูุซ ุงูุชููู ุงูุณููู
                updateNavigation(viewId);
                
                // ุชุญููู ูุญุชูู ุงูุตูุญุฉ
                switch(viewId) {
                    case 'home':
                        loadHomePosts();
                        break;
                    case 'books':
                        loadBooksView();
                        break;
                    case 'shelves':
                        renderShelvesGrid();
                        break;
                    case 'writings':
                        // ุฅุนุงุฏุฉ ุชุนููู ุนุฑุถ ุงูุฑููู
                        document.getElementById('writings-shelf-view').classList.add('hidden');
                        break;
                    case 'menu':
                        loadMenuStats();
                        loadProfileForm();
                        break;
                    case 'book-details':
                        if (params.id) loadBookDetails(params.id);
                        break;
                    case 'search':
                        // ุงูุจุญุซ ุงูุญุงูู
                        if (AppState.searchQuery) {
                            performSearch(AppState.searchQuery);
                        }
                        break;
                }
            }
            
            // ุงูุชูุฑูุฑ ููุฃุนูู
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function updateHeaderTitle(viewId) {
            const titles = {
                'home': '๐ ุงูุฑุฆูุณูุฉ',
                'writings': '๐ ูุชุงุจุงุชู',
                'books': '๐ ุงูููุชุจุฉ',
                'shelves': '๐ฆ ุงูุฑููู',
                'menu': 'โ๏ธ ุงูุฅุนุฏุงุฏุงุช',
                'search': '๐ ุงูุจุญุซ',
                'book-details': '๐ ุชูุงุตูู ุงููุชุงุจ'
            };
            document.getElementById('header-title').textContent = titles[viewId] || 'ููุชุจุชู';
        }

        function updateNavigation(viewId) {
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('text-primary-600', 'dark:text-primary-400');
                if (btn.dataset.view === viewId) {
                    btn.classList.add('text-primary-600', 'dark:text-primary-400');
                }
            });
        }

        function goBack() {
            if (AppState.navigationStack.length > 0) {
                const prevView = AppState.navigationStack.pop();
                navigateTo(prevView);
            } else {
                navigateTo('home');
            }
        }

        // =========================================================================
        // 4. ุงููุถุน ุงููููู ูุงูุซููุงุช
        // =========================================================================
        
        function toggleDarkMode() {
            const isDark = document.documentElement.classList.toggle('dark');
            const toggleBtn = document.getElementById('theme-toggle');
            const circle = toggleBtn.querySelector('div');
    
            if (isDark) {
                circle.style.transform = 'translateX(1.75rem)';
                AppState.settings.mode = 'dark';
                localStorage.setItem('mode', 'dark');
            } else {
                circle.style.transform = 'translateX(0)';
                AppState.settings.mode = 'light';
                localStorage.setItem('mode', 'light');
            }
    
            // ุญูุธ ุงูุฅุนุฏุงุฏุงุช
            DB.save('settings', AppState.settings);
        }

        // ุฏุงูุฉ ูุชุญ ูุงูุฐุฉ ุงูุฅุนุฏุงุฏุงุช
        function showSettingsModal() {
            document.getElementById('settings-modal').classList.remove('hidden');
        }

        // ุฏุงูุฉ ุฅุบูุงู ูุงูุฐุฉ ุงูุฅุนุฏุงุฏุงุช
        function hideSettingsModal() {
            document.getElementById('settings-modal').classList.add('hidden');
        }

        // ุฏุงูุฉ ูุชุญ ุฅุนุฏุงุฏุงุช ุงูุซููุงุช (ููุณ ูุงูุฐุฉ ุงูุฅุนุฏุงุฏุงุช)
        function showThemeSettings() {
            document.getElementById('settings-modal').classList.remove('hidden');
        }

        // ุฏุงูุฉ ุงุฎุชูุงุฑ ุงูุซูู ูุน ุงูุชุจุณูุท
        function selectTheme(themeKey) {
            // ุฃููุงู: ุฅุฒุงูุฉ ุฌููุน ูุฆุงุช ุงูุซููุงุช ุงูุณุงุจูุฉ
            const themes = ['classic', 'light', 'dark', 'ocean', 'forest', 'sunset', 'royal', 'earth'];
            themes.forEach(theme => {
                document.documentElement.classList.remove(`theme-${theme}`);
            });
            
            // ุซุงููุงู: ุฅุถุงูุฉ ูุฆุฉ ุงูุซูู ุงูุฌุฏูุฏ (ุฅุฐุง ูู ููู 'default')
            if (themeKey !== 'default') {
                document.documentElement.classList.add(`theme-${themeKey}`);
            }
    
            // ุซุงูุซุงู: ุชุญุฏูุซ ูุธูุฑ ุฃุฒุฑุงุฑ ุงูุงุฎุชูุงุฑ
            document.querySelectorAll('.theme-option').forEach(option => {
                if (option.dataset.theme === themeKey) {
                    option.classList.add('border-primary-500', 'border-2');
                } else {
                    option.classList.remove('border-primary-500', 'border-2');
                    option.classList.add('border-transparent');
                }
            });
    
            // ุฑุงุจุนุงู: ุญูุธ ุงูุฅุนุฏุงุฏุงุช
            AppState.settings.theme = themeKey;
            localStorage.setItem('theme', themeKey);
            DB.save('settings', AppState.settings);
    
            // ุฎุงูุณุงู: ุฅุธูุงุฑ ุฑุณุงูุฉ ุชุฃููุฏ
            showToast(`ุชู ุชุทุจูู ุงูุซูู: ${getThemeName(themeKey)}`, 'success');
        }

        // ุฏุงูุฉ ูุณุงุนุฏุฉ ููุญุตูู ุนูู ุงุณู ุงูุซูู ุจุงูุนุฑุจูุฉ
        function getThemeName(themeKey) {
            const themeNames = {
                'default': 'ุงูุงูุชุฑุงุถู',
                'classic': 'ููุงุณููู',
                'light': 'ูุงุชุญ',
                'dark': 'ุฏุงูู',
                'ocean': 'ูุญูุท',
                'forest': 'ุบุงุจุฉ',
                'sunset': 'ุบุฑูุจ',
                'royal': 'ูููู',
                'earth': 'ุฃุฑุถู'
            };
            return themeNames[themeKey] || themeKey;
        }

        // ุฏุงูุฉ ุชุทุจูู ุงูุซูู ูุงููุถุน ุงููููู ูุนุงู
        function applyTheme(themeKey, isDark) {
            // ุชุทุจูู ุงูุซูู
            selectTheme(themeKey);
    
            // ุชุทุจูู ุงููุถุน ุงููููู
            if (isDark) {
                document.documentElement.classList.add('dark');
                const toggleBtn = document.getElementById('theme-toggle');
                if (toggleBtn) {
                    const circle = toggleBtn.querySelector('div');
                    circle.style.transform = 'translateX(1.75rem)';
               }
            } else {
                document.documentElement.classList.remove('dark');
            }
        }

        // ุฏุงูุฉ ุชุญููู ุงูุซูู ุนูุฏ ุจุฏุงูุฉ ุงูุชุทุจูู
        function loadTheme() {
            // ุฌูุจ ุงูุซูู ุงููุญููุธ
            const savedTheme = localStorage.getItem('theme') || 'default';
            const savedMode = localStorage.getItem('mode') || 'light';
    
            // ุชุทุจูู ุงูุซูู
            selectTheme(savedTheme);
    
            // ุชุทุจูู ุงููุถุน ุงููููู
            if (savedMode === 'dark') {
                document.documentElement.classList.add('dark');
                const toggleBtn = document.getElementById('theme-toggle');
                if (toggleBtn) {
                    const circle = toggleBtn.querySelector('div');
                    circle.style.transform = 'translateX(1.75rem)';
                }
            } else {
                document.documentElement.classList.remove('dark');
            }
    
            // ุชุญุฏูุซ ุญุงูุฉ ุงูุฅุนุฏุงุฏุงุช
            AppState.settings.theme = savedTheme;
            AppState.settings.mode = savedMode;
        }

        // ุฅุถุงูุฉ ุฃููุงุท CSS ููุซููุงุช ุงูุฌุฏูุฏุฉ
        function addThemeStyles() {
            // ุฅุถุงูุฉ ุฃููุงุท CSS ููุซููุงุช ุงูุฌุฏูุฏุฉ
            const style = document.createElement('style');
            style.innerHTML = `
                /* ุซูู ุงูุบุงุจุฉ - ุฃููุงู ุฎุถุฑุงุก */
                .theme-forest {
                    --primary-500: #10b981;
                    --primary-600: #059669;
                    --primary-700: #047857;
                }
        
                /* ุซูู ุงูุบุฑูุจ - ุฃููุงู ุจุฑุชูุงููุฉ/ูุฑุฏูุฉ */
                .theme-sunset {
                    --primary-500: #f97316;
                    --primary-600: #ea580c;
                    --primary-700: #c2410c;
                }
        
                /* ุซูู ุงููุญูุท - ุฃููุงู ุฒุฑูุงุก ูุงุชุญุฉ */
                .theme-ocean {
                    --primary-500: #06b6d4;
                    --primary-600: #0891b2;
                    --primary-700: #0e7490;
                }
        
                /* ุซูู ูููู - ุฃููุงู ุจููุณุฌูุฉ */
                .theme-royal {
                    --primary-500: #8b5cf6;
                    --primary-600: #7c3aed;
                    --primary-700: #6d28d9;
                }
        
                /* ุซูู ุฃุฑุถู - ุฃููุงู ุจููุฉ/ุฐูุจูุฉ */
                .theme-earth {
                    --primary-500: #d97706;
                    --primary-600: #b45309;
                    --primary-700: #92400e;
                }
        
                /* ุชุทุจูู ุงูุฃููุงู ุนูู ุงูุนูุงุตุฑ */
                .theme-forest .bg-primary-500 { background-color: var(--primary-500) !important; }
                .theme-forest .text-primary-500 { color: var(--primary-500) !important; }
                .theme-forest .border-primary-500 { border-color: var(--primary-500) !important; }
        
                .theme-sunset .bg-primary-500 { background-color: var(--primary-500) !important; }
                .theme-sunset .text-primary-500 { color: var(--primary-500) !important; }
                .theme-sunset .border-primary-500 { border-color: var(--primary-500) !important; }
        
                .theme-ocean .bg-primary-500 { background-color: var(--primary-500) !important; }
                .theme-ocean .text-primary-500 { color: var(--primary-500) !important; }
                .theme-ocean .border-primary-500 { border-color: var(--primary-500) !important; }
        
                .theme-royal .bg-primary-500 { background-color: var(--primary-500) !important; }
                .theme-royal .text-primary-500 { color: var(--primary-500) !important; }
                .theme-royal .border-primary-500 { border-color: var(--primary-500) !important; }
        
                .theme-earth .bg-primary-500 { background-color: var(--primary-500) !important; }
                .theme-earth .text-primary-500 { color: var(--primary-500) !important; }
                .theme-earth .border-primary-500 { border-color: var(--primary-500) !important; }
            `;
            document.head.appendChild(style);
        }

        // ูู ุฏุงูุฉ initAppุ ูุถูู ุชุญููู ุงูุซูู
        async function initApp() {
            try {
                showLoading();
                await DB.init();
                await setupInitialData();
                await loadData();
                setupEventListeners();
                setupSearchIndexes();
                navigateTo('home');
                hideLoading();
        
                // ุฅุฒุงูุฉ ุงูุฅุดุนุงุฑ ุงูุชููุงุฆู ุญุณุจ ุงูุทูุจ
            } catch (error) {
                console.error('โ ุฎุทุฃ ูู ุชููุฆุฉ ุงูุชุทุจูู:', error);
                showToast('ุญุฏุซ ุฎุทุฃ ูู ุชููุฆุฉ ุงูุชุทุจูู', 'error');
                hideLoading();
            }
        }

        // =========================================================================
        // 5. ุงูุตูุญุฉ ุงูุฑุฆูุณูุฉ - ุงูููุดูุฑุงุช
        // =========================================================================

        function loadHomePosts() {
            loadAllPosts();
        }
            
            // ุชุฑุชูุจ ุญุณุจ ุงูุฃุญุฏุซ
            const sortedPosts = [...pinnedPosts].sort((a, b) => b.created_at - a.created_at);
            
            container.innerHTML = sortedPosts.map(post => renderPostCard(post, true)).join('');
        }

        function loadAllPosts() {
            const container = document.getElementById('home-posts-list');
            if (!container) return;
            
            let filteredPosts = AppState.posts.filter(post => !post.pinned);
            
            if (AppState.currentPostSort === 'pinned') {
                filteredPosts = filteredPosts.filter(post => post.pinned === true);
            } else if (AppState.currentPostSort === 'quotes') {
                filteredPosts = filteredPosts.filter(post => post.type === 'quote');
            } else if (AppState.currentPostSort === 'reviews') {
                filteredPosts = filteredPosts.filter(post => post.type === 'review');
            } else if (AppState.currentPostSort === 'notes') {
                filteredPosts = filteredPosts.filter(post => post.type === 'note');
            }
            
            // ุงูุชุทุจูู ุงููุฑุฒ
            sortPosts(AppState.currentPostSort, filteredPosts);
            
            if (filteredPosts.length === 0) {
                container.innerHTML = `
                    <div class="card text-center py-8 text-gray-500">
                        <i class="fa-solid fa-feather text-2xl mb-2"></i>
                        <p>ูุง ุชูุฌุฏ ููุดูุฑุงุช ุจุนุฏ</p>
                        <button onclick="showCreatePostModal()" class="btn-sm bg-primary-500 text-white mt-3">
                            ุฅุถุงูุฉ ููุดูุฑ ุฌุฏูุฏ
                        </button>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = filteredPosts.map(post => renderPostCard(post, false)).join('');
        }

        function renderPostCard(post, isPinned = false) {
            const associatedBook = post.book_ids && post.book_ids.length > 0
                ? AppState.books.find(b => b.id === post.book_ids[0])
                : null;
            
            const typeInfo = POST_TYPES[post.type] || POST_TYPES.note;
            const typeColor = typeInfo.color;
            
            return `
                <div class="card animate-fade-in ${isPinned ? 'border-l-4 border-amber-500' : ''}">
                    <div class="flex items-start justify-between mb-3">
                        <div class="flex items-center gap-2">
                            <div class="w-8 h-8 rounded-lg bg-${typeColor}-100 dark:bg-${typeColor}-900/30 flex items-center justify-center">
                                <i class="fa-solid ${typeInfo.icon} text-${typeColor}-600 dark:text-${typeColor}-400"></i>
                            </div>
                            <div>
                                <div class="text-xs text-gray-500">
                                    ${new Date(post.created_at).toLocaleDateString('ar-EG', {
                                        year: 'numeric',
                                        month: 'short',
                                        day: 'numeric'
                                    })}
                                </div>
                                <div class="text-xs font-medium text-${typeColor}-600 dark:text-${typeColor}-400">
                                    ${typeInfo.text}
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex items-center gap-1">
                            ${post.pinned ? '<i class="fa-solid fa-thumbtack text-amber-500 text-sm" title="ูุซุจุช"></i>' : ''}
                            <button onclick="togglePinPost('${post.id}')" class="icon-sm text-gray-400 hover:text-amber-500" title="${post.pinned ? 'ุฅูุบุงุก ุงูุชุซุจูุช' : 'ุชุซุจูุช'}">
                                <i class="fa-solid fa-thumbtack ${post.pinned ? 'text-amber-500' : ''}"></i>
                            </button>
                            <button onclick="copyToClipboard('${post.content.replace(/'/g, "\\'")}')" class="icon-sm text-gray-400 hover:text-primary-600" title="ูุณุฎ">
                                <i class="fa-solid fa-copy"></i>
                            </button>
                        </div>
                    </div>
                    
                    <p class="text-gray-800 dark:text-gray-200 mb-3 leading-relaxed">
                        ${post.content}
                    </p>
                    
                    ${post.rating ? `
                        <div class="mb-3">
                            <div class="star-rating text-amber-500">
                                ${renderStars(post.rating)}
                            </div>
                        </div>
                    ` : ''}
                    
                    ${associatedBook ? `
                        <div class="flex items-center gap-2 p-2 bg-gray-50 dark:bg-gray-700/50 rounded-lg mb-3">
                            <div class="w-8 h-8 rounded overflow-hidden">
                                <img src="${associatedBook.cover || 'https://images.unsplash.com/photo-1541963463532-d68292c34b19?ixlib=rb-4.0.3&auto=format&fit=crop&w=100&q=80'}" 
                                     alt="${associatedBook.title}" 
                                     class="w-full h-full object-cover">
                            </div>
                            <div class="flex-1">
                                <div class="text-sm font-medium text-gray-700 dark:text-gray-300">${associatedBook.title}</div>
                                <div class="text-xs text-gray-500">${associatedBook.author || 'ุบูุฑ ูุนุฑูู'}</div>
                            </div>
                        </div>
                    ` : ''}
                    
                    ${post.tags && post.tags.length > 0 ? `
                        <div class="flex flex-wrap gap-1 mb-3">
                            ${post.tags.map(tag => `
                                <span class="tag bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 text-xs">
                                    ${tag}
                                </span>
                            `).join('')}
                        </div>
                    ` : ''}
                    
                    <div class="flex justify-end gap-2 pt-2 border-t border-gray-100 dark:border-gray-700">
                        <button onclick="editPost('${post.id}')" class="text-xs text-blue-500 hover:text-blue-700">
                            <i class="fa-solid fa-edit ml-1"></i>
                            ุชุนุฏูู
                        </button>
                        <button onclick="deletePost('${post.id}')" class="text-xs text-red-500 hover:text-red-700">
                            <i class="fa-solid fa-trash ml-1"></i>
                            ุญุฐู
                        </button>
                    </div>
                </div>
            `;
        }

        function renderStars(rating) {
            let html = '';
            for (let i = 1; i <= 5; i++) {
                if (i <= rating) {
                    html += `<i class="fa-solid fa-star"></i>`;
                } else {
                    html += `<i class="fa-regular fa-star"></i>`;
                }
            }
            return html;
        }

        function sortPosts(sortType, posts = AppState.posts) {
            AppState.currentPostSort = sortType;
    
            // ุชุญุฏูุซ ุฃุฒุฑุงุฑ ุงููุฑุฒ
            document.querySelectorAll('.sort-btn').forEach(btn => {
                if (btn.textContent.includes(sortType) || (sortType === 'newest' && btn.textContent.includes('ุงูุฃุญุฏุซ'))) {
                    btn.classList.add('bg-primary-100', 'dark:bg-primary-900/30', 'text-primary-700', 'dark:text-primary-300');
                    btn.classList.remove('bg-gray-100', 'dark:bg-gray-800', 'text-gray-700', 'dark:text-gray-300');
                } else {
                    btn.classList.remove('bg-primary-100', 'dark:bg-primary-900/30', 'text-primary-700', 'dark:text-primary-300');
                    btn.classList.add('bg-gray-100', 'dark:bg-gray-800', 'text-gray-700', 'dark:text-gray-300');
                }
            });
    
            let sortedPosts = [...posts];
    
            switch(sortType) {
                case 'newest':
                    sortedPosts.sort((a, b) => b.created_at - a.created_at);
                    break;
                case 'oldest':
                    sortedPosts.sort((a, b) => a.created_at - b.created_at);
                    break;
                case 'quotes':
                    sortedPosts = sortedPosts.filter(p => p.type === 'quote');
                    sortedPosts.sort((a, b) => b.created_at - a.created_at);
                    break;
                case 'reviews':
                    sortedPosts = sortedPosts.filter(p => p.type === 'review');
                    sortedPosts.sort((a, b) => b.created_at - a.created_at);
                    break;
                case 'notes':
                    sortedPosts = sortedPosts.filter(p => p.type === 'note');
                    sortedPosts.sort((a, b) => b.created_at - a.created_at);
                    break;
            }
    
            // ุฅุฐุง ููุง ูู ุงูุตูุญุฉ ุงูุฑุฆูุณูุฉุ ูุญุฏูุซ ุงูุนุฑุถ
            if (AppState.currentView === 'home') {
                loadAllPosts();
            }
        }

        async function togglePinPost(postId) {
            try {
                const post = AppState.posts.find(p => p.id === postId);
                if (post) {
                    post.pinned = !post.pinned;
                    await DB.update('posts', postId, { pinned: post.pinned });
                    
                    if (post.pinned) {
                        showToast('ุชู ุชุซุจูุช ุงูููุดูุฑ', 'success');
                    } else {
                        showToast('ุชู ุฅูุบุงุก ุชุซุจูุช ุงูููุดูุฑ', 'success');
                    }
                    
                    loadHomePosts();
                }
            } catch (error) {
                console.error('โ ุฎุทุฃ ูู ุชุซุจูุช ุงูููุดูุฑ:', error);
                showToast('ุญุฏุซ ุฎุทุฃ ูู ุชุซุจูุช ุงูููุดูุฑ', 'error');
            }
        }

        // =========================================================================
        // 6. ูุชุงุจุงุชู
        // =========================================================================

        function openWritingShelf(type) {
            const shelf = WRITING_SHELVES[type];
            if (!shelf) return;
    
            AppState.currentWritingShelf = type;
    
            // ุฅุฎูุงุก ุงูุฑููู ูุฅุธูุงุฑ ุงููุญุชูู
            document.querySelector('#view-writings > div:nth-child(2)').classList.add('hidden');
            document.getElementById('writings-shelf-view').classList.remove('hidden');
            
            // ุชุญุฏูุซ ุงูุนููุงู ููุท
            document.getElementById('writing-shelf-title').textContent = shelf.title;
    
            // ุชุญููู ุงูููุดูุฑุงุช
            loadWritingShelfPosts(type);
        }

        function loadWritingShelfPosts(type) {
            const container = document.getElementById('writing-shelf-posts');
            if (!container) return;
    
            let filteredPosts = [];
    
            switch(type) {
                case 'quotes':
                    filteredPosts = AppState.posts.filter(p => p.type === 'quote');
                    break;
                case 'reviews':
                    filteredPosts = AppState.posts.filter(p => p.type === 'review');
                    break;
                case 'notes':
                    filteredPosts = AppState.posts.filter(p => p.type === 'note');
                    break;
            }
    
            if (filteredPosts.length === 0) {
                container.innerHTML = `
                    <div class="card text-center py-8 text-gray-500">
                        <i class="fa-solid fa-feather text-2xl mb-2"></i>
                        <p>ูุง ุชูุฌุฏ ${type === 'quotes' ? 'ุงูุชุจุงุณุงุช' : type === 'reviews' ? 'ูุฑุงุฌุนุงุช' : 'ููุงุญุธุงุช'} ุจุนุฏ</p>
                        <button onclick="showCreatePostModal()" class="btn-sm bg-primary-500 text-white mt-3">
                            ุฅุถุงูุฉ ุฌุฏูุฏ
                        </button>
                    </div>
                `;
                return;
            }
    
            filteredPosts.sort((a, b) => b.created_at - a.created_at);
           container.innerHTML = filteredPosts.map(post => renderPostCard(post, false)).join('');
        }

        function backToWritings() {
            document.getElementById('writings-shelf-view').classList.add('hidden');
            document.getElementById('view-writings').querySelector('div:nth-child(2)').classList.remove('hidden');
            AppState.currentWritingShelf = null;
        }

        // =========================================================================
        // 7. ุงูููุชุจุฉ
        // =========================================================================

        function loadBooksView() {
            const gridView = document.getElementById('books-grid-view');
            const listView = document.getElementById('books-list-view');
            
            if (AppState.booksViewMode === 'grid') {
                gridView.classList.remove('hidden');
                listView.classList.add('hidden');
                renderBooksGrid();
            } else {
                gridView.classList.add('hidden');
                listView.classList.remove('hidden');
                renderBooksList();
            }
        }

        function renderBooksGrid() {
            const container = document.getElementById('books-grid-view');
            if (!container) return;
            
            let booksToDisplay = [...AppState.books];
            
            // ุชุทุจูู ุงููุฑุฒ
            const sortSelect = document.getElementById('books-sort-select');
            if (sortSelect) {
                booksToDisplay = sortBookList(booksToDisplay, sortSelect.value);
            }
            
            // ุชุทุจูู ุงูุจุญุซ
            const searchInput = document.getElementById('books-search');
            if (searchInput && searchInput.value.trim() !== '') {
                const query = searchInput.value.trim().toLowerCase();
                booksToDisplay = booksToDisplay.filter(book => 
                    book.title.toLowerCase().includes(query) ||
                    (book.author && book.author.toLowerCase().includes(query))
                );
            }
            
            if (booksToDisplay.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full card text-center py-8 text-gray-500">
                        <i class="fa-solid fa-book text-2xl mb-2"></i>
                        <p>ูุง ุชูุฌุฏ ูุชุจ</p>
                        <button onclick="showCreateBookModal()" class="btn-sm bg-primary-500 text-white mt-3">
                            ุฅุถุงูุฉ ูุชุงุจ ุฌุฏูุฏ
                        </button>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = booksToDisplay.map(book => `
                <div class="cursor-pointer animate-fade-in" onclick="navigateTo('book-details', {id: '${book.id}'})">
                    <div class="card hover:shadow-medium">
                        <div class="aspect-[2/3] rounded-lg overflow-hidden mb-3">
                            <img src="${book.cover || 'https://images.unsplash.com/photo-1541963463532-d68292c34b19?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&q=80'}" 
                                 alt="${book.title}" 
                                 class="w-full h-full object-cover book-cover">
                        </div>
                        
                        <h3 class="font-medium text-sm mb-1 truncate">${book.title}</h3>
                        <p class="text-xs text-gray-500 truncate">${book.author || 'ุบูุฑ ูุนุฑูู'}</p>
                        
                        ${book.rating ? `
                            <div class="mt-2">
                                <div class="star-rating text-amber-500 text-xs">
                                    ${renderStars(book.rating)}
                                </div>
                            </div>
                        ` : ''}
                        
                        <div class="mt-2 flex items-center justify-between">
                            <span class="text-xs text-gray-500">
                                ${book.year || ''}
                            </span>
                            <span class="text-xs px-2 py-0.5 rounded-full bg-${READING_STATUS[book.status]?.color || 'gray'}-100 dark:bg-${READING_STATUS[book.status]?.color || 'gray'}-900/30 text-${READING_STATUS[book.status]?.color || 'gray'}-700 dark:text-${READING_STATUS[book.status]?.color || 'gray'}-300">
                                ${READING_STATUS[book.status]?.text || book.status}
                            </span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function renderBooksList() {
            const container = document.getElementById('books-list-view');
            if (!container) return;
            
            let booksToDisplay = [...AppState.books];
            
            // ุชุทุจูู ุงููุฑุฒ
            const sortSelect = document.getElementById('books-sort-select');
            if (sortSelect) {
                booksToDisplay = sortBookList(booksToDisplay, sortSelect.value);
            }
            
            // ุชุทุจูู ุงูุจุญุซ
            const searchInput = document.getElementById('books-search');
            if (searchInput && searchInput.value.trim() !== '') {
                const query = searchInput.value.trim().toLowerCase();
                booksToDisplay = booksToDisplay.filter(book => 
                    book.title.toLowerCase().includes(query) ||
                    (book.author && book.author.toLowerCase().includes(query))
                );
            }
            
            if (booksToDisplay.length === 0) {
                container.innerHTML = `
                    <div class="card text-center py-8 text-gray-500">
                        <i class="fa-solid fa-book text-2xl mb-2"></i>
                        <p>ูุง ุชูุฌุฏ ูุชุจ</p>
                        <button onclick="showCreateBookModal()" class="btn-sm bg-primary-500 text-white mt-3">
                            ุฅุถุงูุฉ ูุชุงุจ ุฌุฏูุฏ
                        </button>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = booksToDisplay.map(book => `
                <div class="card cursor-pointer hover:shadow-medium" onclick="navigateTo('book-details', {id: '${book.id}'})">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-16 rounded overflow-hidden flex-shrink-0">
                            <img src="${book.cover || 'https://images.unsplash.com/photo-1541963463532-d68292c34b19?ixlib=rb-4.0.3&auto=format&fit=crop&w=100&q=80'}" 
                                 alt="${book.title}" 
                                 class="w-full h-full object-cover">
                        </div>
                        
                        <div class="flex-1 min-w-0">
                            <h3 class="font-medium text-sm mb-1 truncate">${book.title}</h3>
                            <p class="text-xs text-gray-500 truncate">${book.author || 'ุบูุฑ ูุนุฑูู'}</p>
                            
                            <div class="flex items-center gap-2 mt-1">
                                ${book.rating ? `
                                    <div class="star-rating text-amber-500 text-xs">
                                        ${renderStars(book.rating)}
                                    </div>
                                ` : ''}
                                
                                <span class="text-xs text-gray-500">
                                    ${book.year || ''}
                                </span>
                            </div>
                        </div>
                        
                        <div class="text-right">
                            <span class="text-xs px-2 py-0.5 rounded-full bg-${READING_STATUS[book.status]?.color || 'gray'}-100 dark:bg-${READING_STATUS[book.status]?.color || 'gray'}-900/30 text-${READING_STATUS[book.status]?.color || 'gray'}-700 dark:text-${READING_STATUS[book.status]?.color || 'gray'}-300">
                                ${READING_STATUS[book.status]?.text || book.status}
                            </span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function sortBooks() {
            loadBooksView();
        }

        function sortBookList(books, sortType) {
            let sortedBooks = [...books];
            
            switch(sortType) {
                case 'title_asc':
                    sortedBooks.sort((a, b) => a.title.localeCompare(b.title, 'ar'));
                    break;
                case 'title_desc':
                    sortedBooks.sort((a, b) => b.title.localeCompare(a.title, 'ar'));
                    break;
                case 'newest':
                    sortedBooks.sort((a, b) => b.added_date - a.added_date);
                    break;
                case 'oldest':
                    sortedBooks.sort((a, b) => a.added_date - b.added_date);
                    break;
                case 'author':
                    sortedBooks.sort((a, b) => (a.author || '').localeCompare(b.author || '', 'ar'));
                    break;
                case 'year_desc':
                    sortedBooks.sort((a, b) => (b.year || 0) - (a.year || 0));
                    break;
                case 'year_asc':
                    sortedBooks.sort((a, b) => (a.year || 0) - (b.year || 0));
                    break;
                case 'rating_desc':
                    sortedBooks.sort((a, b) => (b.rating || 0) - (a.rating || 0));
                    break;
                case 'pages_asc':
                    sortedBooks.sort((a, b) => (a.pages || 0) - (b.pages || 0));
                    break;
                case 'pages_desc':
                    sortedBooks.sort((a, b) => (b.pages || 0) - (a.pages || 0));
                    break;
                case 'status':
                    const statusOrder = { 'reading': 1, 'not_started': 2, 'paused': 3, 'finished': 4 };
                    sortedBooks.sort((a, b) => (statusOrder[a.status] || 5) - (statusOrder[b.status] || 5));
                    break;
            }
            
            return sortedBooks;
        }

        function searchBooks() {
            loadBooksView();
        }

        function toggleBooksView() {
            AppState.booksViewMode = AppState.booksViewMode === 'grid' ? 'list' : 'grid';
            
            const icon = document.getElementById('books-view-icon');
            if (AppState.booksViewMode === 'grid') {
                icon.classList.remove('fa-list');
                icon.classList.add('fa-grip');
            } else {
                icon.classList.remove('fa-grip');
                icon.classList.add('fa-list');
            }
            
            loadBooksView();
        }

        function filterByStatus(status) {
            const searchInput = document.getElementById('books-search');
            searchInput.value = '';
            
            const sortSelect = document.getElementById('books-sort-select');
            sortSelect.value = 'newest';
            
            AppState.books = AppState.books.filter(book => book.status === status);
            loadBooksView();
            
            showToast(`ุนุฑุถ ุงููุชุจ ุจุญุงูุฉ: ${READING_STATUS[status]?.text || status}`);
        }

        function clearFilters() {
            loadData().then(() => {
                const searchInput = document.getElementById('books-search');
                searchInput.value = '';
                loadBooksView();
                showToast('ุชู ุฅุนุงุฏุฉ ุชุนููู ุงูููุงุชุฑ');
            });
        }

        // =========================================================================
        // 8. ุงูุฑููู
        // =========================================================================

        function renderShelvesGrid() {
            const grid = document.getElementById('shelves-landing').querySelector('.grid');
            if (!grid) return;
    
            grid.innerHTML = SHELVES.slice(0, 10).map(shelf => {
                const count = AppState.books.filter(book => 
                    Array.isArray(book.statuses) && book.statuses.includes(shelf.key)
                ).length;
        
                return `
                    <div class="card cursor-pointer hover:shadow-medium" onclick="openShelf('${shelf.key}')">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 rounded-lg ${shelf.color} flex items-center justify-center">
                                <i class="fa-solid ${shelf.icon} text-gray-800"></i>
                            </div>
                            <div class="flex-1">
                                <h3 class="font-medium text-sm mb-1">${shelf.title}</h3>
                                <p class="text-xs text-gray-500">${count} ูุชุงุจ</p>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function openShelf(shelfKey) {
            const shelf = SHELVES.find(s => s.key === shelfKey);
            if (!shelf) return;
            
            AppState.currentShelf = shelfKey;
            
            document.getElementById('shelves-landing').classList.add('hidden');
            document.getElementById('shelves-shelf-view').classList.remove('hidden');
            
            document.getElementById('shelf-title').textContent = shelf.title;
            document.getElementById('shelf-desc').textContent = shelf.desc;
            
            sortShelfBooks();
        }

        function sortShelfBooks() {
            const sortSelect = document.getElementById('shelf-sort-select');
            const sortType = sortSelect ? sortSelect.value : 'title_asc';
            
            const booksInShelf = AppState.books.filter(book => 
                Array.isArray(book.statuses) && book.statuses.includes(AppState.currentShelf)
            );
            
            const sortedBooks = sortBookList(booksInShelf, sortType);
            renderShelfBooks(sortedBooks);
        }

        function renderShelfBooks(books) {
            const container = document.getElementById('shelf-books-grid');
            if (!container) return;
            
            if (books.length === 0) {
                 container.innerHTML = `
                    <div class="col-span-full card text-center py-8 text-gray-500">
                        <i class="fa-solid fa-inbox text-2xl mb-2"></i>
                        <p>ูุง ุชูุฌุฏ ูุชุจ ูู ูุฐุง ุงูุฑู</p>
                        <p class="text-sm text-gray-400 mt-1">ุฃุถู ูุชุจุงู ุฅูู ูุฐุง ุงูุฑู ูู ุฎูุงู ุตูุญุฉ ุงูููุชุจุฉ</p>
                    </div>
                 `;
                 return;
            }

            container.innerHTML = books.map(book => `
                <div class="cursor-pointer animate-fade-in" onclick="navigateTo('book-details', {id: '${book.id}'})">
                    <div class="card hover:shadow-medium">
                        <div class="aspect-[2/3] rounded-lg overflow-hidden mb-3">
                            <img src="${book.cover || 'https://images.unsplash.com/photo-1541963463532-d68292c34b19?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&q=80'}" 
                                 alt="${book.title}" 
                                 class="w-full h-full object-cover">
                        </div>
                        
                        <h3 class="font-medium text-sm mb-1 truncate">${book.title}</h3>
                        <p class="text-xs text-gray-500 truncate">${book.author || 'ุบูุฑ ูุนุฑูู'}</p>
                    </div>
                </div>
            `).join('');
        }

        function backToShelves() {
            document.getElementById('shelves-landing').classList.remove('hidden');
            document.getElementById('shelves-shelf-view').classList.add('hidden');
            AppState.currentShelf = null;
        }

        // =========================================================================
        // 9. ุฅุฏุงุฑุฉ ุงูููุดูุฑุงุช
        // =========================================================================

        function showCreatePostModal(postId = null, bookId = null) {
            AppState.editingPostId = postId;
            
            const modal = document.getElementById('post-modal');
            const titleElement = document.getElementById('post-modal-title');
            const contentInput = document.getElementById('post-content');
            const ratingField = document.getElementById('post-rating-field');
            const bookSelect = document.getElementById('post-book-select');
            const tagsInput = document.getElementById('post-tags');
            const pinnedCheckbox = document.getElementById('post-pinned');
            
            // ุชุนุจุฆุฉ ุฎูุงุฑุงุช ุงููุชุจ
            bookSelect.innerHTML = '<option value="">ุงุฎุชุฑ ูุชุงุจุงู...</option>';
            AppState.books.forEach(book => {
                bookSelect.innerHTML += `<option value="${book.id}">${book.title}</option>`;
            });

            // ุฅุนุงุฏุฉ ุงูุชุนููู
            contentInput.value = '';
            tagsInput.value = '';
            setPostRating(5);
            ratingField.classList.add('hidden');
            pinnedCheckbox.checked = false;
            
            // ุฅุนุงุฏุฉ ุชุนููู ุฃุฒุฑุงุฑ ุงูููุน
            document.querySelectorAll('#post-modal button[data-type]').forEach(btn => {
                btn.classList.remove('bg-blue-100', 'dark:bg-blue-900/30', 'text-blue-700', 'dark:text-blue-300',
                                   'bg-amber-100', 'dark:bg-amber-900/30', 'text-amber-700', 'dark:text-amber-300');
                btn.classList.add('bg-gray-100', 'dark:bg-gray-800', 'text-gray-700', 'dark:text-gray-300');
            });
            
            // ุชุนููู ุงูุงูุชุฑุงุถู
            document.querySelector('#post-modal button[data-type="note"]').classList.remove('bg-gray-100', 'dark:bg-gray-800', 'text-gray-700', 'dark:text-gray-300');
            document.querySelector('#post-modal button[data-type="note"]').classList.add('bg-primary-100', 'dark:bg-primary-900/30', 'text-primary-700', 'dark:text-primary-300');

            if (postId) {
                titleElement.textContent = 'ุชุนุฏูู ุงูููุดูุฑ';
                const post = AppState.posts.find(p => p.id === postId);
                if (post) {
                    contentInput.value = post.content;
                    tagsInput.value = (post.tags || []).join(', ');
                    pinnedCheckbox.checked = post.pinned || false;
                    
                    // ุชุนููู ููุน ุงูููุดูุฑ
                    document.querySelectorAll('#post-modal button[data-type]').forEach(btn => {
                        if (btn.dataset.type === post.type) {
                            btn.click();
                        }
                    });
                    
                    if (post.type === 'review') {
                        ratingField.classList.remove('hidden');
                        setPostRating(post.rating || 5);
                    }
                    
                    if (post.book_ids && post.book_ids.length > 0) {
                        bookSelect.value = post.book_ids[0];
                    }
                }
            } else {
                titleElement.textContent = 'ููุดูุฑ ุฌุฏูุฏ';
                if (bookId) {
                    bookSelect.value = bookId;
                }
            }

            modal.classList.remove('hidden');
        }

        function hideCreatePostModal() {
            const modal = document.getElementById('post-modal');
            modal.classList.add('hidden');
            AppState.editingPostId = null;
        }

        function selectPostType(type) {
            // ุชุญุฏูุซ ุฃุฒุฑุงุฑ ุงูููุน
            document.querySelectorAll('#post-modal button[data-type]').forEach(btn => {
                btn.classList.remove('bg-blue-100', 'dark:bg-blue-900/30', 'text-blue-700', 'dark:text-blue-300',
                                   'bg-amber-100', 'dark:bg-amber-900/30', 'text-amber-700', 'dark:text-amber-300',
                                   'bg-emerald-100', 'dark:bg-emerald-900/30', 'text-emerald-700', 'dark:text-emerald-300',
                                   'bg-purple-100', 'dark:bg-purple-900/30', 'text-purple-700', 'dark:text-purple-300');
                btn.classList.add('bg-gray-100', 'dark:bg-gray-800', 'text-gray-700', 'dark:text-gray-300');
            });
            
            const selectedBtn = document.querySelector(`#post-modal button[data-type="${type}"]`);
            selectedBtn.classList.remove('bg-gray-100', 'dark:bg-gray-800', 'text-gray-700', 'dark:text-gray-300');
            
            // ุชุญุฏูุฏ ุงูููู ุงูููุงุณุจ ููููุน
            const typeColors = {
                'quote': 'bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300',
                'note': 'bg-emerald-100 dark:bg-emerald-900/30 text-emerald-700 dark:text-emerald-300',
                'review': 'bg-amber-100 dark:bg-amber-900/30 text-amber-700 dark:text-amber-300',
                'thought': 'bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-300'
            };
            
            selectedBtn.classList.add(...typeColors[type].split(' '));
            
            // ุฅุธูุงุฑ/ุฅุฎูุงุก ุงูุชูููู
            const ratingField = document.getElementById('post-rating-field');
            if (type === 'review') {
                ratingField.classList.remove('hidden');
            } else {
                ratingField.classList.add('hidden');
            }
        }

        function setPostRating(rating) {
            const stars = document.querySelectorAll('#rating-stars i');
            const input = document.getElementById('post-rating-input');
            
            stars.forEach((star, index) => {
                if (index < rating) {
                    star.classList.remove('fa-regular');
                    star.classList.add('fa-solid');
                } else {
                    star.classList.remove('fa-solid');
                    star.classList.add('fa-regular');
                }
            });
            
            input.value = rating;
        }

        async function savePost() {
            try {
                const content = document.getElementById('post-content').value.trim();
                const tagsInput = document.getElementById('post-tags').value.trim();
                const bookSelect = document.getElementById('post-book-select');
                const pinned = document.getElementById('post-pinned').checked;
                
                if (!content) {
                    showToast('ูุฑุฌู ุฅุฏุฎุงู ูุญุชูู ุงูููุดูุฑ', 'error');
                    return;
                }
                
                // ุชุญุฏูุฏ ููุน ุงูููุดูุฑ ูู ุงูุฒุฑ ุงููุดุท
                const activeTypeBtn = document.querySelector('#post-modal button[data-type]');
                const type = activeTypeBtn?.dataset.type || 'note';
                
                let rating = null;
                if (type === 'review') {
                    rating = parseInt(document.getElementById('post-rating-input').value) || 5;
                }
                
                const tags = tagsInput ? tagsInput.split(',').map(tag => tag.trim()).filter(t => t) : [];
                
                const bookId = bookSelect.value || null;
                const book_ids = bookId ? [bookId] : [];
                
                const postData = {
                    type,
                    content,
                    book_ids,
                    tags,
                    rating,
                    pinned,
                    edited_at: Date.now()
                };
                
                if (AppState.editingPostId) {
                    await DB.update('posts', AppState.editingPostId, postData);
                    showToast('ุชู ุชุญุฏูุซ ุงูููุดูุฑ', 'success');
                } else {
                    postData.created_at = Date.now();
                    await DB.save('posts', postData);
                    showToast('ุชู ุฅูุดุงุก ุงูููุดูุฑ', 'success');
                }
                
                await loadData();
                hideCreatePostModal();
                loadHomePosts();
                
                // ุฅุฐุง ููุง ูู ุฑู ูุชุงุจุงุชูุ ูุญุฏูุซู
                if (AppState.currentWritingShelf) {
                    loadWritingShelfPosts(AppState.currentWritingShelf);
                }
            } catch (error) {
                console.error('โ ุฎุทุฃ ูู ุญูุธ ุงูููุดูุฑ:', error);
                showToast('ุญุฏุซ ุฎุทุฃ ูู ุญูุธ ุงูููุดูุฑ', 'error');
            }
        }

        function editPost(postId) {
            showCreatePostModal(postId);
        }

        function deletePost(postId) {
            if (confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ูุฐุง ุงูููุดูุฑุ ูุง ูููู ุงูุชุฑุงุฌุน ุนู ูุฐุง ุงูุฅุฌุฑุงุก.')) {
                DB.delete('posts', postId).then(() => {
                    loadData().then(() => {
                        loadHomePosts();
                        if (AppState.currentWritingShelf) {
                            loadWritingShelfPosts(AppState.currentWritingShelf);
                        }
                        showToast('ุชู ุญุฐู ุงูููุดูุฑ', 'success');
                    });
                }).catch(error => {
                    console.error('โ ุฎุทุฃ ูู ุญุฐู ุงูููุดูุฑ:', error);
                    showToast('ุญุฏุซ ุฎุทุฃ ูู ุญุฐู ุงูููุดูุฑ', 'error');
                });
            }
        }

        // =========================================================================
        // 10. ุฅุฏุงุฑุฉ ุงููุชุจ
        // =========================================================================

        function showCreateBookModal(bookId = null) {
            AppState.editingBookId = bookId;
            
            const modal = document.getElementById('book-modal');
            const titleElement = document.getElementById('book-modal-title');
            const shelvesSelect = document.getElementById('book-shelves-select');
            
            // ุชุนุจุฆุฉ ุฎูุงุฑุงุช ุงูุฑููู
            shelvesSelect.innerHTML = '';
            SHELVES.forEach(shelf => {
                const option = document.createElement('option');
                option.value = shelf.key;
                option.textContent = shelf.title;
                shelvesSelect.appendChild(option);
            });
            
            // ุฅุนุงุฏุฉ ุงูุชุนููู
            document.getElementById('book-form').reset();
            document.getElementById('book-cover-preview').innerHTML = `
                <i class="fa-solid fa-image text-4xl text-gray-400 dark:text-gray-500 mb-3"></i>
                <p class="text-sm text-gray-600 dark:text-gray-400">ุงููุฑ ูุชุญููู ุตูุฑุฉ</p>
            `;
            setBookRating(0);
            
            if (bookId) {
                titleElement.textContent = 'ุชุนุฏูู ุงููุชุงุจ';
                const book = AppState.books.find(b => b.id === bookId);
                if (book) {
                    // ุชุนุจุฆุฉ ุงูุญููู
                    document.getElementById('book-title').value = book.title || '';
                    document.getElementById('book-author').value = book.author || '';
                    document.getElementById('book-year').value = book.year || '';
                    document.getElementById('book-publisher').value = book.publisher || '';
                    document.getElementById('book-pages').value = book.pages || '';
                    document.getElementById('book-status').value = book.status || 'not_started';
                    document.getElementById('book-progress').value = book.progress || '';
                    document.getElementById('book-start-date').value = book.start_date || '';
                    document.getElementById('book-finish-date').value = book.finish_date || '';
                    document.getElementById('book-pause-date').value = book.pause_date || '';
                    document.getElementById('book-category').value = book.category || '';
                    document.getElementById('book-language').value = book.language || 'arabic';
                    document.getElementById('book-series').value = book.series || '';
                    document.getElementById('book-volume').value = book.volume || '';
                    document.getElementById('book-translator').value = book.translator || '';
                    document.getElementById('book-edition').value = book.edition || '';
                    document.getElementById('book-summary').value = book.summary || '';
                    document.getElementById('book-author-bio').value = book.author_bio || '';
                    document.getElementById('book-rating-text').value = book.rating_text || '';
                    document.getElementById('book-notes').value = book.notes || '';
                    document.getElementById('book-location').value = book.location || 'physical_home';
                    
                    setBookRating(book.rating || 0);
                    
                    if (book.cover) {
                        document.getElementById('book-cover-preview').innerHTML = `
                            <img src="${book.cover}" alt="ุบูุงู ุงููุชุงุจ" class="w-full h-full object-cover">
                        `;
                    }
                    
                    if (Array.isArray(book.statuses)) {
                        Array.from(shelvesSelect.options).forEach(opt => {
                            if (book.statuses.includes(opt.value)) {
                                opt.selected = true;
                            }
                        });
                    }
                }
            } else {
                titleElement.textContent = 'ุฅุถุงูุฉ ูุชุงุจ ุฌุฏูุฏ';
            }
            
            modal.classList.remove('hidden');
        }

        function hideCreateBookModal() {
            const modal = document.getElementById('book-modal');
            modal.classList.add('hidden');
            AppState.editingBookId = null;
        }

        function previewBookCover(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const preview = document.getElementById('book-cover-preview');
                preview.innerHTML = `<img src="${e.target.result}" alt="ุบูุงู ุงููุชุงุจ" class="w-full h-full object-cover">`;
            };
            reader.readAsDataURL(file);
        }

        function setBookRating(rating) {
            const stars = document.querySelectorAll('#book-rating-stars i');
            const input = document.getElementById('book-rating');
            
            stars.forEach((star, index) => {
                if (index < rating) {
                    star.classList.remove('fa-regular');
                    star.classList.add('fa-solid');
                } else {
                    star.classList.remove('fa-solid');
                    star.classList.add('fa-regular');
                }
            });
            
            input.value = rating;
        }

        async function saveBook() {
            try {
                const title = document.getElementById('book-title').value.trim();
                const author = document.getElementById('book-author').value.trim();
                
                if (!title || !author) {
                    showToast('ูุฑุฌู ุฅุฏุฎุงู ุงูุนููุงู ูุงููุคูู', 'error');
                    return;
                }
                
                const coverInput = document.getElementById('book-cover-input');
                let cover = '';
                if (coverInput.files && coverInput.files[0]) {
                    const file = coverInput.files[0];
                    cover = await readFileAsDataURL(file);
                } else if (AppState.editingBookId) {
                    const book = AppState.books.find(b => b.id === AppState.editingBookId);
                    cover = book ? book.cover : '';
                }
                
                const shelvesSelect = document.getElementById('book-shelves-select');
                const statuses = Array.from(shelvesSelect.selectedOptions).map(opt => opt.value);
                
                const bookData = {
                    title,
                    author,
                    cover,
                    year: document.getElementById('book-year').value || null,
                    publisher: document.getElementById('book-publisher').value || null,
                    pages: parseInt(document.getElementById('book-pages').value) || null,
                    status: document.getElementById('book-status').value,
                    progress: parseInt(document.getElementById('book-progress').value) || 0,
                    start_date: document.getElementById('book-start-date').value || null,
                    finish_date: document.getElementById('book-finish-date').value || null,
                    pause_date: document.getElementById('book-pause-date').value || null,
                    category: document.getElementById('book-category').value || null,
                    language: document.getElementById('book-language').value,
                    series: document.getElementById('book-series').value || null,
                    volume: parseInt(document.getElementById('book-volume').value) || null,
                    translator: document.getElementById('book-translator').value || null,
                    edition: parseInt(document.getElementById('book-edition').value) || null,
                    summary: document.getElementById('book-summary').value || null,
                    author_bio: document.getElementById('book-author-bio').value || null,
                    rating: parseInt(document.getElementById('book-rating').value) || 0,
                    rating_text: document.getElementById('book-rating-text').value || null,
                    notes: document.getElementById('book-notes').value || null,
                    location: document.getElementById('book-location').value,
                    statuses,
                    updated_at: Date.now()
                };
                
                if (AppState.editingBookId) {
                    await DB.update('books', AppState.editingBookId, bookData);
                    showToast('ุชู ุชุญุฏูุซ ุงููุชุงุจ', 'success');
                } else {
                    bookData.added_date = Date.now();
                    await DB.save('books', bookData);
                    showToast('ุชู ุฅุถุงูุฉ ุงููุชุงุจ', 'success');
                }
                
                await loadData();
                hideCreateBookModal();
                loadBooksView();
                renderShelvesGrid();
            } catch (error) {
                console.error('โ ุฎุทุฃ ูู ุญูุธ ุงููุชุงุจ:', error);
                showToast('ุญุฏุซ ุฎุทุฃ ูู ุญูุธ ุงููุชุงุจ', 'error');
            }
        }

        function readFileAsDataURL(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = (e) => reject(e);
                reader.readAsDataURL(file);
            });
        }

        function editBook(bookId) {
            showCreateBookModal(bookId);
        }

        function deleteBook(bookId) {
            if (confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ูุฐุง ุงููุชุงุจุ ุณูุชู ุญุฐู ุฌููุน ุงูููุดูุฑุงุช ุงููุฑุชุจุทุฉ ุจู ุฃูุถุงู.')) {
                DB.delete('books', bookId).then(async () => {
                    // ุญุฐู ุงูููุดูุฑุงุช ุงููุฑุชุจุทุฉ
                    const postsToDelete = AppState.posts.filter(p => p.book_ids && p.book_ids.includes(bookId));
                    for (const post of postsToDelete) {
                        await DB.delete('posts', post.id);
                    }
                    
                    await loadData();
                    loadBooksView();
                    renderShelvesGrid();
                    showToast('ุชู ุญุฐู ุงููุชุงุจ ูุงูููุดูุฑุงุช ุงููุฑุชุจุทุฉ ุจู', 'success');
                }).catch(error => {
                    console.error('โ ุฎุทุฃ ูู ุญุฐู ุงููุชุงุจ:', error);
                    showToast('ุญุฏุซ ุฎุทุฃ ูู ุญุฐู ุงููุชุงุจ', 'error');
                });
            }
        }

        // =========================================================================
        // 11. ุชูุงุตูู ุงููุชุงุจ
        // =========================================================================

        function loadBookDetails(bookId) {
            const book = AppState.books.find(b => b.id === bookId);
            if (!book) {
                showToast('ุงููุชุงุจ ุบูุฑ ููุฌูุฏ', 'error');
                navigateTo('books');
                return;
            }
            
            const relatedPosts = AppState.posts.filter(post => 
                post.book_ids && post.book_ids.includes(bookId)
            );
            
            const quotes = relatedPosts.filter(p => p.type === 'quote');
            const reviews = relatedPosts.filter(p => p.type === 'review');
            const notes = relatedPosts.filter(p => p.type === 'note');
            const thoughts = relatedPosts.filter(p => p.type === 'thought');
            
            const container = document.getElementById('view-book-details');
            if (!container) return;
            
            container.innerHTML = `
                <div class="space-y-4">
                    <!-- ุฒุฑ ุงูุนูุฏุฉ -->
                    <div class="flex items-center gap-2 mb-4">
                        <button onclick="navigateTo('books')" class="icon-sm text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-700">
                            <i class="fa-solid fa-arrow-right"></i>
                        </button>
                        <h2 class="text-xl font-semibold text-gray-900 dark:text-gray-100">${book.title}</h2>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                        <!-- ุงูุนููุฏ ุงูุฃูุณุฑ: ุงูุบูุงู ูุงููุนูููุงุช ุงูุณุฑูุนุฉ -->
                        <div class="lg:col-span-1">
                            <div class="card">
                                <div class="aspect-[2/3] rounded-lg overflow-hidden mb-4">
                                    <img src="${book.cover || 'https://images.unsplash.com/photo-1541963463532-d68292c34b19?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&q=80'}" 
                                         alt="${book.title}" 
                                         class="w-full h-full object-cover">
                                </div>
                                
                                <!-- ูุนูููุงุช ุณุฑูุนุฉ -->
                                <div class="space-y-3">
                                    <div class="flex justify-between items-center">
                                        <span class="text-sm text-gray-500">ุงููุคูู</span>
                                        <span class="font-medium">${book.author || 'ุบูุฑ ูุนุฑูู'}</span>
                                    </div>
                                    
                                    ${book.year ? `
                                        <div class="flex justify-between items-center">
                                            <span class="text-sm text-gray-500">ุณูุฉ ุงููุดุฑ</span>
                                            <span>${book.year}</span>
                                        </div>
                                    ` : ''}
                                    
                                    ${book.pages ? `
                                        <div class="flex justify-between items-center">
                                            <span class="text-sm text-gray-500">ุงูุตูุญุงุช</span>
                                            <span>${book.pages}</span>
                                        </div>
                                    ` : ''}
                                    
                                    <div class="flex justify-between items-center">
                                        <span class="text-sm text-gray-500">ุญุงูุฉ ุงููุฑุงุกุฉ</span>
                                        <span class="px-2 py-0.5 rounded-full bg-${READING_STATUS[book.status]?.color || 'gray'}-100 dark:bg-${READING_STATUS[book.status]?.color || 'gray'}-900/30 text-${READING_STATUS[book.status]?.color || 'gray'}-700 dark:text-${READING_STATUS[book.status]?.color || 'gray'}-300 text-xs">
                                            ${READING_STATUS[book.status]?.text || book.status}
                                        </span>
                                    </div>
                                    
                                    ${book.location ? `
                                        <div class="flex justify-between items-center">
                                            <span class="text-sm text-gray-500">ููุงู ุงููุชุงุจ</span>
                                            <span class="flex items-center gap-1">
                                                <i class="fa-solid ${BOOK_LOCATIONS[book.location]?.icon || 'fa-question'}"></i>
                                                ${BOOK_LOCATIONS[book.location]?.text || book.location}
                                            </span>
                                        </div>
                                    ` : ''}
                                    
                                    <!-- ุงูุชูููู -->
                                    ${book.rating ? `
                                        <div class="pt-3 border-t border-gray-100 dark:border-gray-700">
                                            <div class="flex justify-between items-center mb-2">
                                                <span class="text-sm text-gray-500">ุชููููู</span>
                                                <div class="star-rating text-amber-500">
                                                    ${renderStars(book.rating)}
                                                </div>
                                            </div>
                                            ${book.rating_text ? `
                                                <p class="text-sm text-gray-600 dark:text-gray-400 italic">"${book.rating_text}"</p>
                                            ` : ''}
                                        </div>
                                    ` : ''}
                                    
                                    <!-- ุงูุชูุฏู -->
                                    ${book.progress && book.pages ? `
                                        <div class="pt-3 border-t border-gray-100 dark:border-gray-700">
                                            <div class="flex justify-between text-sm text-gray-500 mb-1">
                                                <span>ุงูุชูุฏู</span>
                                                <span>${Math.round((book.progress / book.pages) * 100)}%</span>
                                            </div>
                                            <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                                                <div class="bg-primary-500 h-2 rounded-full" style="width: ${(book.progress / book.pages) * 100}%"></div>
                                            </div>
                                            <p class="text-xs text-gray-500 text-center mt-1">${book.progress} ูู ${book.pages} ุตูุญุฉ</p>
                                        </div>
                                    ` : ''}
                                    
                                    <!-- ุงูุฑููู -->
                                    ${book.statuses && book.statuses.length > 0 ? `
                                        <div class="pt-3 border-t border-gray-100 dark:border-gray-700">
                                            <p class="text-sm text-gray-500 mb-2">ุงูุฑููู</p>
                                            <div class="flex flex-wrap gap-1">
                                                ${book.statuses.map(statusKey => {
                                                    const shelf = SHELVES.find(s => s.key === statusKey);
                                                    return shelf ? `
                                                        <span class="tag bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 text-xs">
                                                            ${shelf.title}
                                                        </span>
                                                    ` : '';
                                                }).join('')}
                                            </div>
                                        </div>
                                    ` : ''}
                                    
                                    <!-- ุงูุฃุฒุฑุงุฑ -->
                                    <div class="pt-3 border-t border-gray-100 dark:border-gray-700 space-y-2">
                                        <button onclick="editBook('${book.id}')" class="w-full btn-sm bg-blue-500 text-white hover:bg-blue-600">
                                            <i class="fa-solid fa-edit ml-2"></i>
                                            ุชุนุฏูู ุงูุจูุงูุงุช
                                        </button>
                                        <button onclick="showCreatePostModal(null, '${book.id}')" class="w-full btn-sm bg-primary-500 text-white hover:bg-primary-600">
                                            <i class="fa-solid fa-plus ml-2"></i>
                                            ุฅุถุงูุฉ ููุดูุฑ ุฌุฏูุฏ
                                        </button>
                                        <button onclick="deleteBook('${book.id}')" class="w-full btn-sm bg-red-500 text-white hover:bg-red-600">
                                            <i class="fa-solid fa-trash ml-2"></i>
                                            ุญุฐู ุงููุชุงุจ
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- ุงูุนููุฏูู ุงูุฃููููู: ุงูุชูุงุตูู -->
                        <div class="lg:col-span-2 space-y-4">
                            <!-- ูุนูููุงุช ุฅุถุงููุฉ -->
                            <div class="card">
                                <h3 class="font-medium mb-3 text-gray-900 dark:text-gray-100">ูุนูููุงุช ุฅุถุงููุฉ</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    ${book.publisher ? `
                                        <div>
                                            <p class="text-sm text-gray-500">ุฏุงุฑ ุงููุดุฑ</p>
                                            <p class="font-medium">${book.publisher}</p>
                                        </div>
                                    ` : ''}
                                    
                                    ${book.category ? `
                                        <div>
                                            <p class="text-sm text-gray-500">ุงูุชุตููู</p>
                                            <p class="font-medium">${book.category}</p>
                                        </div>
                                    ` : ''}
                                    
                                    ${book.language ? `
                                        <div>
                                            <p class="text-sm text-gray-500">ุงููุบุฉ</p>
                                            <p class="font-medium">${book.language === 'arabic' ? 'ุงูุนุฑุจูุฉ' : 'ุงูุฅูุฌููุฒูุฉ'}</p>
                                        </div>
                                    ` : ''}
                                    
                                    ${book.series ? `
                                        <div>
                                            <p class="text-sm text-gray-500">ุงูุณูุณูุฉ</p>
                                            <p class="font-medium">
                                                ${book.series}
                                                ${book.volume ? ` - ุงูุฌุฒุก ${book.volume}` : ''}
                                            </p>
                                        </div>
                                    ` : ''}
                                    
                                    ${book.translator ? `
                                        <div>
                                            <p class="text-sm text-gray-500">ุงููุชุฑุฌู</p>
                                            <p class="font-medium">${book.translator}</p>
                                        </div>
                                    ` : ''}
                                    
                                    ${book.edition ? `
                                        <div>
                                            <p class="text-sm text-gray-500">ุงูุทุจุนุฉ</p>
                                            <p class="font-medium">${book.edition}</p>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                            
                            <!-- ุงูููุฎุต -->
                            ${book.summary ? `
                                <div class="card">
                                    <h3 class="font-medium mb-3 text-gray-900 dark:text-gray-100">ููุฎุต ุงููุชุงุจ</h3>
                                    <p class="text-gray-700 dark:text-gray-300 leading-relaxed">${book.summary}</p>
                                </div>
                            ` : ''}
                            
                            <!-- ูุจุฐุฉ ุนู ุงููุงุชุจ -->
                            ${book.author_bio ? `
                                <div class="card">
                                    <h3 class="font-medium mb-3 text-gray-900 dark:text-gray-100">ูุจุฐุฉ ุนู ุงููุงุชุจ</h3>
                                    <p class="text-gray-700 dark:text-gray-300 leading-relaxed">${book.author_bio}</p>
                                </div>
                            ` : ''}
                            
                            <!-- ุงูููุงุญุธุงุช ุงูุดุฎุตูุฉ -->
                            ${book.notes ? `
                                <div class="card">
                                    <h3 class="font-medium mb-3 text-gray-900 dark:text-gray-100">ููุงุญุธุงุช ุดุฎุตูุฉ</h3>
                                    <p class="text-gray-700 dark:text-gray-300 leading-relaxed">${book.notes}</p>
                                </div>
                            ` : ''}
                            
                            <!-- ุงูููุดูุฑุงุช ุงููุฑุชุจุทุฉ -->
                            <div class="card">
                                <div class="flex items-center justify-between mb-4">
                                    <h3 class="font-medium text-gray-900 dark:text-gray-100">ุงูููุดูุฑุงุช ุงููุฑุชุจุทุฉ</h3>
                                    <button onclick="showCreatePostModal(null, '${book.id}')" class="btn-sm bg-primary-500 text-white hover:bg-primary-600">
                                        <i class="fa-solid fa-plus ml-2"></i>
                                        ุฅุถุงูุฉ ุฌุฏูุฏ
                                    </button>
                                </div>
                                
                                <!-- ุนูุงูุงุช ุงูุชุจููุจ -->
                                <div class="flex flex-wrap gap-2 mb-4">
                                    <button onclick="showBookPosts('all')" class="text-xs px-3 py-1 rounded-full bg-primary-100 dark:bg-primary-900/30 text-primary-700 dark:text-primary-300">
                                        ุงููู (${relatedPosts.length})
                                    </button>
                                    ${quotes.length > 0 ? `
                                        <button onclick="showBookPosts('quotes')" class="text-xs px-3 py-1 rounded-full bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300">
                                            ุงูุชุจุงุณุงุช (${quotes.length})
                                        </button>
                                    ` : ''}
                                    ${reviews.length > 0 ? `
                                        <button onclick="showBookPosts('reviews')" class="text-xs px-3 py-1 rounded-full bg-amber-100 dark:bg-amber-900/30 text-amber-700 dark:text-amber-300">
                                            ูุฑุงุฌุนุงุช (${reviews.length})
                                        </button>
                                    ` : ''}
                                    ${notes.length > 0 ? `
                                        <button onclick="showBookPosts('notes')" class="text-xs px-3 py-1 rounded-full bg-emerald-100 dark:bg-emerald-900/30 text-emerald-700 dark:text-emerald-300">
                                            ููุงุญุธุงุช (${notes.length})
                                        </button>
                                    ` : ''}
                                    ${thoughts.length > 0 ? `
                                        <button onclick="showBookPosts('thoughts')" class="text-xs px-3 py-1 rounded-full bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-300">
                                            ุฃููุงุฑ (${thoughts.length})
                                        </button>
                                    ` : ''}
                                </div>
                                
                                <!-- ุงูููุดูุฑุงุช -->
                                <div id="book-posts-container" class="space-y-3">
                                    ${relatedPosts.length === 0 ? `
                                        <div class="text-center py-8 text-gray-500">
                                            <i class="fa-solid fa-feather text-2xl mb-2"></i>
                                            <p>ูุง ุชูุฌุฏ ููุดูุฑุงุช ูุฑุชุจุทุฉ ุจูุฐุง ุงููุชุงุจ</p>
                                        </div>
                                    ` : relatedPosts.map(post => renderPostCard(post, false)).join('')}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function showBookPosts(type) {
            const container = document.getElementById('book-posts-container');
            if (!container) return;
            
            const bookId = AppState.currentBookId;
            const relatedPosts = AppState.posts.filter(post => 
                post.book_ids && post.book_ids.includes(bookId)
            );
            
            let filteredPosts = [];
            
            switch(type) {
                case 'all':
                    filteredPosts = relatedPosts;
                    break;
                case 'quotes':
                    filteredPosts = relatedPosts.filter(p => p.type === 'quote');
                    break;
                case 'reviews':
                    filteredPosts = relatedPosts.filter(p => p.type === 'review');
                    break;
                case 'notes':
                    filteredPosts = relatedPosts.filter(p => p.type === 'note');
                    break;
                case 'thoughts':
                    filteredPosts = relatedPosts.filter(p => p.type === 'thought');
                    break;
            }
            
            if (filteredPosts.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i class="fa-solid fa-feather text-2xl mb-2"></i>
                        <p>ูุง ุชูุฌุฏ ${type === 'quotes' ? 'ุงูุชุจุงุณุงุช' : type === 'reviews' ? 'ูุฑุงุฌุนุงุช' : type === 'notes' ? 'ููุงุญุธุงุช' : 'ุฃููุงุฑ'}</p>
                    </div>
                `;
                return;
            }
            
            filteredPosts.sort((a, b) => b.created_at - a.created_at);
            container.innerHTML = filteredPosts.map(post => renderPostCard(post, false)).join('');
        }

        // =========================================================================
        // 12. ุงูุจุญุซ
        // =========================================================================

        function toggleSearchBar() {
            const bar = document.getElementById('search-bar');
            bar.classList.toggle('hidden');
            
            if (!bar.classList.contains('hidden')) {
                document.getElementById('search-input').focus();
            }
        }

        function handleSearch(query) {
            AppState.searchQuery = query;
            
            if (query.trim().length >= 2 || query.trim() === '') {
                navigateTo('search');
                performSearch(query);
            }
        }

        function performSearch(query) {
            const container = document.getElementById('search-results');
            const countElement = document.getElementById('search-results-count');
            
            if (!query.trim()) {
                container.innerHTML = `
                    <div class="card text-center py-8 text-gray-500">
                        <i class="fa-solid fa-search text-2xl mb-2"></i>
                        <p>ุงูุชุจ ููุจุญุซ ูู ููุชุจุชู</p>
                    </div>
                `;
                countElement.textContent = '';
                return;
            }
            
            let results = [];
            let booksResults = [];
            let postsResults = [];
            
            // ุจุญุซ ูู ุงููุชุจ
            if (AppState.searchFilter === 'all' || AppState.searchFilter === 'books') {
                booksResults = AppState.books.filter(book => 
                    book.title.toLowerCase().includes(query.toLowerCase()) ||
                    (book.author && book.author.toLowerCase().includes(query.toLowerCase())) ||
                    (book.publisher && book.publisher.toLowerCase().includes(query.toLowerCase())) ||
                    (book.summary && book.summary.toLowerCase().includes(query.toLowerCase())) ||
                    (book.notes && book.notes.toLowerCase().includes(query.toLowerCase()))
                );
                
                booksResults.forEach(book => {
                    results.push({
                        type: 'book',
                        item: book,
                        score: 0
                    });
                });
            }
            
            // ุจุญุซ ูู ุงูููุดูุฑุงุช
            if (AppState.searchFilter === 'all' || AppState.searchFilter === 'quotes' || AppState.searchFilter === 'reviews' || AppState.searchFilter === 'notes') {
                postsResults = AppState.posts.filter(post => {
                    if (AppState.searchFilter === 'quotes' && post.type !== 'quote') return false;
                    if (AppState.searchFilter === 'reviews' && post.type !== 'review') return false;
                    if (AppState.searchFilter === 'notes' && post.type !== 'note') return false;
                    
                    return post.content.toLowerCase().includes(query.toLowerCase()) ||
                           (post.tags && post.tags.some(tag => tag.toLowerCase().includes(query.toLowerCase())));
                });
                
                postsResults.forEach(post => {
                    results.push({
                        type: 'post',
                        item: post,
                        score: 0
                    });
                });
            }
            
            // ุชุญุฏูุซ ุงูุนุฏุฏ
            countElement.textContent = `(${results.length} ูุชูุฌุฉ)`;
            
            if (results.length === 0) {
                container.innerHTML = `
                    <div class="card text-center py-8 text-gray-500">
                        <i class="fa-solid fa-search text-2xl mb-2"></i>
                        <p>ูุง ุชูุฌุฏ ูุชุงุฆุฌ ูู "${query}"</p>
                    </div>
                `;
                return;
            }
            
            // ุนุฑุถ ุงููุชุงุฆุฌ
            container.innerHTML = results.map(result => {
                if (result.type === 'book') {
                    const book = result.item;
                    return `
                        <div class="card cursor-pointer hover:shadow-medium" onclick="navigateTo('book-details', {id: '${book.id}'})">
                            <div class="flex items-center gap-3">
                                <div class="w-12 h-16 rounded overflow-hidden flex-shrink-0">
                                    <img src="${book.cover || 'https://images.unsplash.com/photo-1541963463532-d68292c34b19?ixlib=rb-4.0.3&auto=format&fit=crop&w=100&q=80'}" 
                                         alt="${book.title}" 
                                         class="w-full h-full object-cover">
                                </div>
                                
                                <div class="flex-1">
                                    <h3 class="font-medium text-sm mb-1">${book.title}</h3>
                                    <p class="text-xs text-gray-500">${book.author || 'ุบูุฑ ูุนุฑูู'}</p>
                                    <div class="text-xs text-gray-400 mt-1">ูุชุงุจ</div>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    const post = result.item;
                    const associatedBook = post.book_ids && post.book_ids.length > 0
                        ? AppState.books.find(b => b.id === post.book_ids[0])
                        : null;
                    
                    const typeInfo = POST_TYPES[post.type] || POST_TYPES.note;
                    
                    return `
                        <div class="card">
                            <div class="flex items-start justify-between mb-2">
                                <div class="flex items-center gap-2">
                                    <div class="w-6 h-6 rounded bg-${typeInfo.color}-100 dark:bg-${typeInfo.color}-900/30 flex items-center justify-center">
                                        <i class="fa-solid ${typeInfo.icon} text-${typeInfo.color}-600 dark:text-${typeInfo.color}-400 text-xs"></i>
                                    </div>
                                    <span class="text-xs text-${typeInfo.color}-600 dark:text-${typeInfo.color}-400">${typeInfo.text}</span>
                                </div>
                                <div class="text-xs text-gray-500">
                                    ${new Date(post.created_at).toLocaleDateString('ar-EG')}
                                </div>
                            </div>
                            
                            <p class="text-gray-700 dark:text-gray-300 text-sm mb-3">
                                ${post.content.length > 150 ? post.content.substring(0, 150) + '...' : post.content}
                            </p>
                            
                            ${associatedBook ? `
                                <div class="text-xs text-gray-500 flex items-center gap-1">
                                    <i class="fa-solid fa-book"></i>
                                    ${associatedBook.title}
                                </div>
                            ` : ''}
                            
                            ${post.tags && post.tags.length > 0 ? `
                                <div class="flex flex-wrap gap-1 mt-2">
                                    ${post.tags.map(tag => `
                                        <span class="text-xs px-2 py-0.5 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded">
                                            ${tag}
                                        </span>
                                    `).join('')}
                                </div>
                            ` : ''}
                        </div>
                    `;
                }
            }).join('');
        }

        function showAdvancedSearch() {
            document.getElementById('advanced-search-modal').classList.remove('hidden');
        }

        function hideAdvancedSearch() {
            document.getElementById('advanced-search-modal').classList.add('hidden');
        }

        function performAdvancedSearch() {
            const query = document.getElementById('advanced-search-text').value.trim();
            const rating = document.getElementById('search-rating').value;
            const dateFrom = document.getElementById('search-date-from').value;
            const dateTo = document.getElementById('search-date-to').value;
            const sort = document.getElementById('search-sort').value;
            const precision = document.getElementById('search-precision-advanced').value;
            
            // ุชุทุจูู ุงูููุงุชุฑ (ูุจุณุท ูู ูุฐุง ุงููุซุงู)
            handleSearch(query);
            hideAdvancedSearch();
        }

        function filterSearchResults(type) {
            AppState.searchFilter = type;
            performSearch(AppState.searchQuery);
        }

        function hideSearchResults() {
            navigateTo('home');
            document.getElementById('search-input').value = '';
            document.getElementById('search-bar').classList.add('hidden');
        }

        function searchBooksInModal(query) {
            const resultsContainer = document.getElementById('book-search-results');
            const bookSelect = document.getElementById('post-book-select');
            
            if (!query.trim()) {
                resultsContainer.classList.add('hidden');
                return;
            }
            
            const filteredBooks = AppState.books.filter(book => 
                book.title.toLowerCase().includes(query.toLowerCase()) ||
                (book.author && book.author.toLowerCase().includes(query.toLowerCase()))
            );
            
            if (filteredBooks.length === 0) {
                resultsContainer.innerHTML = '<div class="p-2 text-sm text-gray-500">ูุง ุชูุฌุฏ ูุชุงุฆุฌ</div>';
            } else {
                resultsContainer.innerHTML = filteredBooks.map(book => `
                    <div class="p-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer" 
                         onclick="selectBookFromSearch('${book.id}', '${book.title}')">
                        ${book.title} - ${book.author || 'ุบูุฑ ูุนุฑูู'}
                    </div>
                `).join('');
            }
            
            resultsContainer.classList.remove('hidden');
        }

        function selectBookFromSearch(bookId, bookTitle) {
            document.getElementById('post-book-select').value = bookId;
            document.getElementById('book-search-input').value = bookTitle;
            document.getElementById('book-search-results').classList.add('hidden');
        }

        // =========================================================================
        // 13. ุงูุฅุนุฏุงุฏุงุช ูุงูููู ุงูุดุฎุตู
        // =========================================================================

        function loadMenuStats() {
            document.getElementById('stats-books').textContent = AppState.books.length;
            document.getElementById('stats-posts').textContent = AppState.posts.length;
            document.getElementById('stats-quotes').textContent = AppState.posts.filter(p => p.type === 'quote').length;
        }

        function loadProfileForm() {
            document.getElementById('profile-name').value = AppState.profile.name || '';
            document.getElementById('profile-bio').value = AppState.profile.bio || '';
        }

        async function saveProfile() {
            try {
                const profileData = {
                    fullName: document.getElementById('profile-fullname').value,
                    birthdate: document.getElementById('profile-birthdate').value,
                    nationality: document.getElementById('profile-nationality').value,
                    location: document.getElementById('profile-location').value,
                    bio: document.getElementById('profile-bio').value,
                    stats: {
                        booksRead: parseInt(document.getElementById('profile-books-read').value) || 0,
                        favoriteBooks: parseInt(document.getElementById('profile-favorite-books').value) || 0,
                        readingHours: parseInt(document.getElementById('profile-reading-hours').value) || 0,
                        currentBooks: parseInt(document.getElementById('profile-current-books').value) || 0
                    }
                };
        
                await DB.save('profile', profileData);
                showToast('ุชู ุญูุธ ุงูููู ุงูุดุฎุตู ุจูุฌุงุญ', 'success');
            } catch (error) {
                console.error('โ ุฎุทุฃ ูู ุญูุธ ุงูููู ุงูุดุฎุตู:', error);
                showToast('ุญุฏุซ ุฎุทุฃ ูู ุญูุธ ุงูููู ุงูุดุฎุตู', 'error');
            }
        }

        function updateStats() {
            loadMenuStats();
        }

        // =========================================================================
        // 14. ุงููุณุฎ ุงูุงุญุชูุงุทู ูุงูุงุณุชูุฑุงุฏ
        // =========================================================================

        async function exportBackup() {
            try {
                const books = await DB.getAll('books');
                const posts = await DB.getAll('posts');
                const profile = AppState.profile;
                const settings = AppState.settings;
                
                const data = {
                    books,
                    posts,
                    profile,
                    settings,
                    shelves: SHELVES,
                    writing_shelves: WRITING_SHELVES,
                    export_date: new Date().toISOString(),
                    version: '2.0'
                };
                
                // ุฅูุดุงุก ููู ZIP
                const zip = new JSZip();
                
                // ุฅุถุงูุฉ ุงูุจูุงูุงุช ููููุงุช JSON ูููุตูุฉ
                zip.file('meta.json', JSON.stringify({
                    name: 'ููุชุจุชู',
                    version: '2.0',
                    export_date: new Date().toISOString(),
                    items_count: {
                        books: books.length,
                        posts: posts.length
                    }
                }, null, 2));
                
                zip.file('books.json', JSON.stringify(books, null, 2));
                zip.file('posts.json', JSON.stringify(posts, null, 2));
                zip.file('profile.json', JSON.stringify(profile, null, 2));
                zip.file('settings.json', JSON.stringify(settings, null, 2));
                
                // ุฅูุดุงุก ุงูููู
                const content = await zip.generateAsync({ type: "blob" });
                
                const date = new Date().toISOString().slice(0, 10).replace(/-/g, '');
                const filename = `ููุชุจุชู-ูุณุฎุฉ-ุงุญุชูุงุทูุฉ-${date}.zip`;
                
                saveAs(content, filename);
                
                showToast('ุชู ุชุตุฏูุฑ ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ ุจูุฌุงุญ', 'success');
            } catch (error) {
                console.error('โ ุฎุทุฃ ูู ุงูุชุตุฏูุฑ:', error);
                showToast('ุญุฏุซ ุฎุทุฃ ูู ุชุตุฏูุฑ ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ', 'error');
            }
        }

        async function handleImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            
            reader.onload = async (e) => {
                try {
                    showLoading();
                    
                    let importedData;
                    
                    if (file.name.endsWith('.zip')) {
                        const zip = await JSZip.loadAsync(e.target.result);
                        const meta = JSON.parse(await zip.file('meta.json').async("text"));
                        const books = JSON.parse(await zip.file('books.json').async("text"));
                        const posts = JSON.parse(await zip.file('posts.json').async("text"));
                        const profile = JSON.parse(await zip.file('profile.json').async("text"));
                        const settings = JSON.parse(await zip.file('settings.json').async("text"));
                        
                        importedData = { books, posts, profile, settings };
                    } else if (file.name.endsWith('.json')) {
                        importedData = JSON.parse(e.target.result);
                    } else {
                        throw new Error('ููุน ุงูููู ุบูุฑ ูุฏุนูู');
                    }
                    
                    if (!importedData.books || !Array.isArray(importedData.books)) {
                        throw new Error('ุงูููู ูุง ูุญุชูู ุนูู ุจูุงูุงุช ุตุญูุญุฉ');
                    }
                    
                    const confirmMerge = confirm(`ุชู ุงูุนุซูุฑ ุนูู ${importedData.books.length} ูุชุงุจ ู ${importedData.posts?.length || 0} ููุดูุฑ.\n\nูู ุชุฑูุฏ ุงุณุชุจุฏุงู ุงูุจูุงูุงุช ุงูุญุงููุฉุ\n\nููุงูู: ุงุณุชุจุฏุงู ูุงูู\nุฅูุบุงุก: ุฏูุฌ ุงูุจูุงูุงุช`);
                    
                    if (confirmMerge) {
                        // ุงุณุชุจุฏุงู ูุงูู
                        await DB.db.setItem('books', importedData.books);
                        await DB.db.setItem('posts', importedData.posts || []);
                        await DB.db.setItem('profile', importedData.profile || {});
                        await DB.db.setItem('settings', importedData.settings || {});
                    } else {
                        // ุฏูุฌ ุงูุจูุงูุงุช
                        const existingBooks = await DB.getAll('books');
                        const existingPosts = await DB.getAll('posts');
                        
                        const mergedBooks = [...existingBooks];
                        const existingBookIds = new Set(existingBooks.map(b => b.id));
                        
                        importedData.books.forEach(book => {
                            if (existingBookIds.has(book.id)) {
                                // ุชุญุฏูุซ ุงููุชุงุจ ุงูููุฌูุฏ
                                const index = mergedBooks.findIndex(b => b.id === book.id);
                                mergedBooks[index] = { ...mergedBooks[index], ...book };
                            } else {
                                // ุฅุถุงูุฉ ุงููุชุงุจ ุงูุฌุฏูุฏ
                                mergedBooks.push(book);
                            }
                        });
                        
                        await DB.db.setItem('books', mergedBooks);
                        
                        // ุฏูุฌ ุงูููุดูุฑุงุช
                        const mergedPosts = [...existingPosts];
                        const existingPostIds = new Set(existingPosts.map(p => p.id));
                        
                        (importedData.posts || []).forEach(post => {
                            if (!existingPostIds.has(post.id)) {
                                mergedPosts.push(post);
                            }
                        });
                        
                        await DB.db.setItem('posts', mergedPosts);
                    }
                    
                    await loadData();
                    hideLoading();
                    
                    showToast('ุชู ุงุณุชูุฑุงุฏ ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ ุจูุฌุงุญ', 'success');
                    
                    // ุชุญุฏูุซ ุงูุนุฑุถ ุงูุญุงูู
                    switch(AppState.currentView) {
                        case 'home': loadHomePosts(); break;
                        case 'books': loadBooksView(); break;
                        case 'shelves': renderShelvesGrid(); break;
                        case 'menu': loadMenuStats(); break;
                    }
                    
                } catch (error) {
                    console.error('โ ุฎุทุฃ ูู ุงูุงุณุชูุฑุงุฏ:', error);
                    hideLoading();
                    showToast('ุญุฏุซ ุฎุทุฃ ูู ุงุณุชูุฑุงุฏ ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ', 'error');
                }
            };
            
            reader.readAsArrayBuffer(file);
        }

        // =========================================================================
        // 15. ูุธุงุฆู ูุณุงุนุฏุฉ
        // =========================================================================

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showToast('ุชู ูุณุฎ ุงููุต ุฅูู ุงูุญุงูุธุฉ', 'success');
            }).catch(err => {
                console.error('โ ูุดู ุงููุณุฎ:', err);
                showToast('ูุดู ูุณุฎ ุงููุต', 'error');
            });
        }

        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            
            const baseClasses = 'card flex items-center justify-between gap-2 animate-fade-in';
            let colorClasses = '';
            let icon = '';
            
            switch(type) {
                case 'success':
                    colorClasses = 'border-l-4 border-emerald-500';
                    icon = 'fa-check-circle text-emerald-500';
                    break;
                case 'error':
                    colorClasses = 'border-l-4 border-red-500';
                    icon = 'fa-times-circle text-red-500';
                    break;
                case 'info':
                    colorClasses = 'border-l-4 border-blue-500';
                    icon = 'fa-info-circle text-blue-500';
                    break;
                default:
                    colorClasses = 'border-l-4 border-gray-500';
                    icon = 'fa-info-circle text-gray-500';
            }
            
            toast.className = `${baseClasses} ${colorClasses}`;
            toast.innerHTML = `
                <div class="flex items-center gap-2">
                    <i class="fa-solid ${icon}"></i>
                    <span>${message}</span>
                </div>
                <button onclick="this.parentElement.remove()" class="text-gray-500 hover:text-gray-700">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            `;
            
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.add('opacity-0');
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }

        function clearCache() {
            if (confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ูุณุญ ุงูุฐุงูุฑุฉ ุงููุคูุชุฉุ')) {
                localStorage.clear();
                showToast('ุชู ูุณุญ ุงูุฐุงูุฑุฉ ุงููุคูุชุฉ', 'success');
            }
        }

        function showHelp(type) {
            const messages = {
                'tutorial': 'ุชุนูููุงุช ุงูุงุณุชุฎุฏุงู: ููููู ุฅุถุงูุฉ ูุชุจุ ูุชุงุจุฉ ููุดูุฑุงุชุ ุชุตููู ุงููุชุจ ูู ุฑูููุ ูุงูุจุญุซ ูู ููุชุจุชู.',
                'about': 'ููุชุจุชู ุงูุดุฎุตูุฉ - ุชุทุจูู ูุฅุฏุงุฑุฉ ููุชุจุชู ุงูุดุฎุตูุฉ ูุชุชุจุน ูุฑุงุกุงุชู.',
                'tips': 'ูุตุงุฆุญ: ุงุณุชุฎุฏู ุงููุณูู ูุชุตููู ุงูููุดูุฑุงุชุ ุงุณุชุฎุฏู ุงูุฑููู ูุชูุธูู ุงููุชุจุ ุงุญูุธ ูุณุฎุฉ ุงุญุชูุงุทูุฉ ุจุงูุชุธุงู.'
            };
            
            showToast(messages[type] || 'ูุณุงุนุฏุฉ', 'info');
        }

        // =========================================================================
        // 16. ูุงุนุฏุฉ ุงูุจูุงูุงุช
        // =========================================================================

        const DB = {
            async init() {
                this.db = localforage.createInstance({
                    name: "MaktabatiDB",
                    storeName: "maktabati_store"
                });
            },

            async getAll(key) {
                const data = await this.db.getItem(key);
                return data || [];
            },

            async save(key, item) {
                let collection = await this.getAll(key);
                item.id = item.id || Date.now().toString() + Math.random().toString(36).substr(2, 9);
                collection.push(item);
                await this.db.setItem(key, collection);
                return item;
            },

            async update(key, id, newData) {
                let collection = await this.getAll(key);
                const index = collection.findIndex(item => item.id === id);
                if (index !== -1) {
                    collection[index] = { ...collection[index], ...newData };
                    await this.db.setItem(key, collection);
                    return collection[index];
                }
                return null;
            },

            async delete(key, id) {
                let collection = await this.getAll(key);
                collection = collection.filter(item => item.id !== id);
                await this.db.setItem(key, collection);
            }
        };

        // ุจูุงูุงุช ุชุฌุฑูุจูุฉ ุฃูููุฉ
        async function setupInitialData() {
            const books = await DB.getAll('books');
            const posts = await DB.getAll('posts');
            
            if (books.length === 0 && posts.length === 0) {
                const demoBooks = [
                    {
                        id: '1',
                        title: 'ููุฏูุฉ ูู ุงูุชุฃูู',
                        author: 'ุฃ. ู. ูุญูุฏ',
                        year: 2022,
                        pages: 256,
                        cover: 'https://images.unsplash.com/photo-1544716278-ca5e3f4abd8c?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&q=80',
                        status: 'finished',
                        statuses: ['liked', 'recommended', 'life_changing'],
                        rating: 5,
                        rating_text: 'ูุชุงุจ ุบููุฑ ุทุฑููุฉ ุชูููุฑู',
                        progress: 256,
                        location: 'physical_home',
                        language: 'arabic',
                        category: 'philosophy',
                        added_date: Date.now() - 86400000 * 30,
                        summary: 'ูุชุงุจ ุนููู ุนู ุงูุชุฃูู ูุฃุซุฑู ุนูู ุงูุญูุงุฉ',
                        notes: 'ูุฌุจ ุฃู ุฃุนูุฏ ูุฑุงุกุชู ูุฑุฉ ุฃุฎุฑู'
                    },
                    {
                        id: '2',
                        title: 'ุชุงุฑูุฎ ุงูููุณูุฉ ุงูุญุฏูุซุฉ',
                        author: 'ุฌ. ุฏ. ุณููู',
                        year: 2020,
                        pages: 480,
                        cover: 'https://images.unsplash.com/photo-1531346688376-ab6275c4725e?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&q=80',
                        status: 'reading',
                        statuses: ['reading', 'heavy_but_important'],
                        rating: 4,
                        progress: 150,
                        location: 'ebook',
                        language: 'arabic',
                        category: 'philosophy',
                        added_date: Date.now() - 86400000 * 60,
                        summary: 'ุชุงุฑูุฎ ุดุงูู ููููุณูุฉ ุงูุญุฏูุซุฉ'
                    },
                    {
                        id: '3',
                        title: 'ุฑูุงูุฉ ูุฏููุฉ ุงูุฑูุงุญ',
                        author: 'ู. ููุณู',
                        year: 2023,
                        pages: 320,
                        cover: 'https://images.unsplash.com/photo-1512820790803-83ca734da794?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&q=80',
                        status: 'finished',
                        statuses: ['liked', 'emotional'],
                        rating: 5,
                        rating_text: 'ุฑูุงูุฉ ูุคุซุฑุฉ ุฌุฏุงู',
                        progress: 320,
                        location: 'pdf',
                        language: 'arabic',
                        category: 'fiction',
                        added_date: Date.now() - 86400000 * 10,
                        summary: 'ุฑูุงูุฉ ุนู ุฑุญูุฉ ุจุญุซ ุนู ุงูุฐุงุช'
                    }
                ];
                
                const demoPosts = [
                    {
                        id: 'p1',
                        type: 'quote',
                        content: 'ุฅู ุงูุนูู ููุณ ูุนุงุกู ูุฌุจ ููุคูุ ุจู ูุงุฑุงู ูุฌุจ ุฅุดุนุงููุง.',
                        book_ids: ['2'],
                        created_at: Date.now() - 86400000 * 5,
                        tags: ['ููุณูุฉ', 'ุชุฃูู'],
                        pinned: false
                    },
                    {
                        id: 'p2',
                        type: 'review',
                        content: 'ุฑูุงูุฉ ูุฐููุฉ ุชุณุชุญู ุฎูุณ ูุฌููุ ููู ููุงูุชูุง ุญูุฑุชูู.',
                        book_ids: ['3'],
                        created_at: Date.now() - 86400000 * 2,
                        rating: 5,
                        tags: ['ูุฑุงุฌุนุฉ', 'ุนุงุทูู'],
                        pinned: true
                    },
                    {
                        id: 'p3',
                        type: 'note',
                        content: 'ูุฌุจ ุฃู ุฃุจุญุซ ุฃูุซุฑ ุนู ููููู "ุงููุฌูุฏ ูุงูุนุฏู".',
                        book_ids: ['2'],
                        created_at: Date.now() - 86400000 * 1,
                        tags: ['ุฃููุงุฑ', 'ููุณูุฉ'],
                        pinned: false
                    },
                    {
                        id: 'p4',
                        type: 'thought',
                        content: 'ุงููุฑุงุกุฉ ููุณุช ููุงูุฉุ ุจู ุทุฑููุฉ ููุญูุงุฉ.',
                        book_ids: [],
                        created_at: Date.now() - 86400000 * 3,
                        tags: ['ุชุฃูู', 'ูุฑุงุกุฉ'],
                        pinned: true
                    }
                ];
                
                await DB.db.setItem('books', demoBooks);
                await DB.db.setItem('posts', demoPosts);
                await DB.db.setItem('profile', { 
                    name: 'ูุงุฑุฆ ูููู', 
                    bio: 'ูุงูู ูููุชุจ ูุงูุชุฃููุงุช' 
                });
                await DB.db.setItem('settings', { 
                    theme: 'classic', 
                    mode: 'light' 
                });
            }
        }

        // =========================================================================
        // 17. ุชุดุบูู ุงูุชุทุจูู
        // =========================================================================

        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
